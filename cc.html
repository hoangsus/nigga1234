<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>German Learning Assistant</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50 0%, #e74c3c 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .tabs {
        display: flex;
        background: #34495e;
      }

      .tab {
        flex: 1;
        padding: 15px;
        background: #34495e;
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 16px;
      }

      .tab:hover {
        background: #2c3e50;
      }

      .tab.active {
        background: #e74c3c;
      }

      .tab-content {
        display: none;
        padding: 30px;
      }

      .tab-content.active {
        display: block;
      }

      .upload-section {
        background: #f8f9fa;
        border: 2px dashed #e74c3c;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        transition: all 0.3s ease;
      }

      .upload-section:hover {
        border-color: #c0392b;
        background: #fee;
      }

      .upload-section.dragover {
        border-color: #27ae60;
        background: #e8f5e8;
      }

      .file-input {
        display: none;
      }

      .upload-btn {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .control-btn {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 20px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      }

      .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
      }

      .control-btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #ecf0f1;
        border-radius: 4px;
        margin: 20px 0;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #e74c3c, #c0392b);
        width: 0%;
        transition: width 0.3s ease;
      }

      .transcript-container {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin-top: 30px;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
      }

      .transcript-word {
        display: inline;
        padding: 4px 8px;
        margin: 2px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 18px;
        line-height: 2;
        font-weight: 500;
      }

      .transcript-word:hover {
        background: #e3f2fd;
        transform: scale(1.02);
      }

      .transcript-word.active {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);
      }

      .transcript-word.learned {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
      }

      .transcript-word.difficult {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
      }

      .word-actions {
        display: inline-block;
        margin-left: 10px;
      }

      .word-action-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        margin: 0 2px;
        padding: 2px 4px;
        border-radius: 3px;
        transition: all 0.3s;
      }

      .word-action-btn:hover {
        background: rgba(0, 0, 0, 0.1);
      }

      .vocabulary-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .vocab-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid #e74c3c;
        transition: all 0.3s ease;
      }

      .vocab-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .vocab-card.learned {
        border-left-color: #27ae60;
      }

      .vocab-card.difficult {
        border-left-color: #e74c3c;
      }

      .vocab-word {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .vocab-translation {
        font-size: 18px;
        color: #7f8c8d;
        margin-bottom: 10px;
      }

      .vocab-example {
        font-style: italic;
        color: #95a5a6;
        margin-bottom: 15px;
      }

      .vocab-actions {
        display: flex;
        gap: 10px;
      }

      .vocab-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }

      .vocab-btn.learn {
        background: #27ae60;
        color: white;
      }

      .vocab-btn.difficult {
        background: #e74c3c;
        color: white;
      }

      .vocab-btn.play {
        background: #3498db;
        color: white;
      }

      .quiz-container {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin-top: 20px;
      }

      .quiz-question {
        font-size: 24px;
        color: #2c3e50;
        margin-bottom: 20px;
        text-align: center;
      }

      .quiz-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .quiz-option {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
      }

      .quiz-option:hover {
        border-color: #3498db;
        background: #e3f2fd;
      }

      .quiz-option.correct {
        border-color: #27ae60;
        background: #d5f4e6;
      }

      .quiz-option.wrong {
        border-color: #e74c3c;
        background: #ffeaa7;
      }

      .quiz-stats {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
        padding: 20px;
        background: white;
        border-radius: 10px;
      }

      .stat-item {
        text-align: center;
      }

      .stat-number {
        font-size: 32px;
        font-weight: bold;
        color: #e74c3c;
      }

      .stat-label {
        color: #7f8c8d;
        font-size: 14px;
      }

      .status {
        text-align: center;
        padding: 20px;
        font-size: 18px;
        color: #2c3e50;
        font-weight: 500;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #e74c3c;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .time-display {
        text-align: center;
        font-size: 20px;
        color: #2c3e50;
        margin: 20px 0;
        font-weight: 500;
      }

      .section {
        margin-bottom: 30px;
      }

      .section h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 20px;
      }

      .playback-speed {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
      }

      .speed-btn {
        background: #34495e;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
      }

      .speed-btn.active {
        background: #e74c3c;
      }

      .repeat-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
      }

      .repeat-btn {
        background: #f39c12;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        margin: 0 10px;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 2em;
        }

        .tabs {
          flex-direction: column;
        }

        .controls {
          flex-direction: column;
          align-items: center;
        }

        .control-btn {
          width: 200px;
        }

        .vocabulary-list {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üá©üá™ German Learning Assistant</h1>
        <p>H·ªçc ti·∫øng ƒê·ª©c t·ª´ file √¢m thanh v·ªõi transcript, t·ª´ v·ª±ng v√† b√†i t·∫≠p</p>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('audio')">
          üéµ Audio & Transcript
        </button>
        <button class="tab" onclick="switchTab('vocabulary')">
          üìö T·ª´ V·ª±ng
        </button>
        <button class="tab" onclick="switchTab('quiz')">üß† B√†i T·∫≠p</button>
        <button class="tab" onclick="switchTab('review')">üìù √în T·∫≠p</button>
      </div>

      <!-- Audio & Transcript Tab -->
      <div id="audio" class="tab-content active">
        <div class="upload-section" id="uploadSection">
          <input
            type="file"
            id="audioFile"
            class="file-input"
            accept=".mp3,.wav,.ogg,.m4a"
          />
          <button
            class="upload-btn"
            onclick="document.getElementById('audioFile').click()"
          >
            üìÅ Ch·ªçn file √¢m thanh ti·∫øng ƒê·ª©c
          </button>
          <p style="margin-top: 15px; color: #7f8c8d">
            Ho·∫∑c k√©o th·∫£ file v√†o ƒë√¢y
          </p>
        </div>

        <div class="controls">
          <button
            class="control-btn"
            id="playBtn"
            onclick="togglePlayPause()"
            disabled
          >
            ‚ñ∂Ô∏è Ph√°t
          </button>
          <button
            class="control-btn"
            id="pauseBtn"
            onclick="togglePlayPause()"
            disabled
            style="display: none"
          >
            ‚è∏Ô∏è T·∫°m d·ª´ng
          </button>
          <button
            class="control-btn"
            id="stopBtn"
            onclick="stopAudio()"
            disabled
          >
            ‚èπÔ∏è D·ª´ng
          </button>
          <button
            class="control-btn"
            id="transcribeBtn"
            onclick="startTranscription()"
            disabled
          >
            üìù T·∫°o Transcript
          </button>
        </div>

        <div class="playback-speed">
          <span>T·ªëc ƒë·ªô ph√°t:</span>
          <button class="speed-btn" onclick="setPlaybackSpeed(0.5)">
            0.5x
          </button>
          <button class="speed-btn active" onclick="setPlaybackSpeed(1)">
            1x
          </button>
          <button class="speed-btn" onclick="setPlaybackSpeed(1.25)">
            1.25x
          </button>
          <button class="speed-btn" onclick="setPlaybackSpeed(1.5)">
            1.5x
          </button>
        </div>

        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="time-display" id="timeDisplay">00:00 / 00:00</div>

        <div class="repeat-section" id="repeatSection" style="display: none">
          <h4>üîÑ L·∫∑p l·∫°i ƒëo·∫°n</h4>
          <button class="repeat-btn" onclick="setRepeatStart()">
            ƒêi·ªÉm b·∫Øt ƒë·∫ßu
          </button>
          <button class="repeat-btn" onclick="setRepeatEnd()">
            ƒêi·ªÉm k·∫øt th√∫c
          </button>
          <button class="repeat-btn" onclick="toggleRepeat()">
            B·∫≠t/T·∫Øt l·∫∑p
          </button>
          <div id="repeatInfo" style="margin-top: 10px; color: #7f8c8d"></div>
        </div>

        <div class="status" id="status">
          Vui l√≤ng ch·ªçn file √¢m thanh ti·∫øng ƒê·ª©c ƒë·ªÉ b·∫Øt ƒë·∫ßu
        </div>

        <div
          class="transcript-container"
          id="transcriptContainer"
          style="display: none"
        >
          <h3 style="margin-bottom: 20px; color: #2c3e50">
            üìÑ Transcript ti·∫øng ƒê·ª©c:
          </h3>
          <div id="transcript"></div>
        </div>
      </div>

      <!-- Vocabulary Tab -->
      <div id="vocabulary" class="tab-content">
        <div class="section">
          <h3>üìö T·ª´ v·ª±ng ƒë√£ h·ªçc</h3>
          <div class="vocabulary-list" id="vocabularyList">
            <div style="text-align: center; color: #7f8c8d; padding: 40px">
              Ch∆∞a c√≥ t·ª´ v·ª±ng n√†o. H√£y t·∫°o transcript tr∆∞·ªõc!
            </div>
          </div>
        </div>
      </div>

      <!-- Quiz Tab -->
      <div id="quiz" class="tab-content">
        <div class="quiz-container">
          <div class="quiz-stats">
            <div class="stat-item">
              <div class="stat-number" id="totalWords">0</div>
              <div class="stat-label">T·ªïng t·ª´</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="learnedWords">0</div>
              <div class="stat-label">ƒê√£ h·ªçc</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="difficultWords">0</div>
              <div class="stat-label">Kh√≥</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="quizScore">0</div>
              <div class="stat-label">ƒêi·ªÉm</div>
            </div>
          </div>

          <div id="quizContent">
            <div style="text-align: center; color: #7f8c8d; padding: 40px">
              <h3>üß† B√†i t·∫≠p t·ª´ v·ª±ng</h3>
              <p>T·∫°o transcript tr∆∞·ªõc ƒë·ªÉ c√≥ b√†i t·∫≠p!</p>
              <button
                class="control-btn"
                onclick="startQuiz()"
                disabled
                id="startQuizBtn"
              >
                üéØ B·∫Øt ƒë·∫ßu Quiz
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Review Tab -->
      <div id="review" class="tab-content">
        <div class="section">
          <h3>üìù √în t·∫≠p t·ª´ kh√≥</h3>
          <div id="reviewContent">
            <div style="text-align: center; color: #7f8c8d; padding: 40px">
              Ch∆∞a c√≥ t·ª´ kh√≥ n√†o ƒë·ªÉ √¥n t·∫≠p
            </div>
          </div>
        </div>
      </div>
    </div>

    <audio id="audioPlayer" style="display: none"></audio>

    <script>
      let audioPlayer = document.getElementById("audioPlayer");
      let transcriptData = [];
      let vocabularyData = [];
      let isTranscribing = false;
      let recognition;
      let currentWordIndex = 0;
      let quizData = [];
      let currentQuizIndex = 0;
      let quizScore = 0;
      let repeatStart = null;
      let repeatEnd = null;
      let isRepeating = false;

      // Drag and drop functionality
      const uploadSection = document.getElementById("uploadSection");

      uploadSection.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadSection.classList.add("dragover");
      });

      uploadSection.addEventListener("dragleave", () => {
        uploadSection.classList.remove("dragover");
      });

      uploadSection.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadSection.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

      document
        .getElementById("audioFile")
        .addEventListener("change", function (e) {
          if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
          }
        });

      function handleFileSelect(file) {
        if (!file.type.startsWith("audio/")) {
          alert("Vui l√≤ng ch·ªçn file √¢m thanh!");
          return;
        }

        const url = URL.createObjectURL(file);
        audioPlayer.src = url;

        document.getElementById(
          "status"
        ).innerHTML = `‚úÖ ƒê√£ t·∫£i file: ${file.name}`;
        document.getElementById("playBtn").disabled = false;
        document.getElementById("transcribeBtn").disabled = false;
        document.getElementById("repeatSection").style.display = "block";

        // Reset data
        document.getElementById("transcriptContainer").style.display = "none";
        transcriptData = [];
        vocabularyData = [];
        updateVocabularyDisplay();
        updateStats();
      }

      function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(tabName).classList.add("active");
        event.target.classList.add("active");
      }

      function togglePlayPause() {
        if (audioPlayer.paused) {
          audioPlayer.play();
          document.getElementById("playBtn").style.display = "none";
          document.getElementById("pauseBtn").style.display = "inline-block";
          document.getElementById("stopBtn").disabled = false;
          startWordSync();
        } else {
          audioPlayer.pause();
          document.getElementById("playBtn").style.display = "inline-block";
          document.getElementById("pauseBtn").style.display = "none";
          stopWordSync();
        }
      }

      function stopAudio() {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        document.getElementById("playBtn").style.display = "inline-block";
        document.getElementById("pauseBtn").style.display = "none";
        document.getElementById("stopBtn").disabled = true;
        stopWordSync();
      }

      function setPlaybackSpeed(speed) {
        audioPlayer.playbackRate = speed;
        document.querySelectorAll(".speed-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        event.target.classList.add("active");
      }

      function setRepeatStart() {
        repeatStart = audioPlayer.currentTime;
        updateRepeatInfo();
      }

      function setRepeatEnd() {
        repeatEnd = audioPlayer.currentTime;
        updateRepeatInfo();
      }

      function toggleRepeat() {
        isRepeating = !isRepeating;
        updateRepeatInfo();
      }

      function updateRepeatInfo() {
        const info = document.getElementById("repeatInfo");
        if (repeatStart !== null && repeatEnd !== null) {
          info.innerHTML = `L·∫∑p t·ª´ ${formatTime(repeatStart)} ƒë·∫øn ${formatTime(
            repeatEnd
          )} ${isRepeating ? "(ƒêang b·∫≠t)" : "(ƒêang t·∫Øt)"}`;
        } else {
          info.innerHTML = "Ch∆∞a ƒë·∫∑t ƒëi·ªÉm l·∫∑p";
        }
      }

      function startTranscription() {
        if (isTranscribing) return;

        if (
          !("webkitSpeechRecognition" in window) &&
          !("SpeechRecognition" in window)
        ) {
          alert(
            "Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Web Speech API. Vui l√≤ng s·ª≠ d·ª•ng Chrome ho·∫∑c Edge."
          );
          return;
        }

        isTranscribing = true;
        document.getElementById("status").innerHTML =
          '<span class="loading"></span>ƒêang t·∫°o transcript ti·∫øng ƒê·ª©c...';
        document.getElementById("transcribeBtn").disabled = true;

        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();

        recognition.lang = "de-DE"; // German
        recognition.interimResults = true;
        recognition.continuous = true;
        recognition.maxAlternatives = 1;

        let fullTranscript = "";
        let wordTimestamps = [];
        let startTime = Date.now();

        recognition.onresult = function (event) {
          let interimTranscript = "";
          let finalTranscript = "";

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript;

              // Add words with timestamps
              const words = transcript.trim().split(/\s+/);
              const currentTime = (Date.now() - startTime) / 1000;

              words.forEach((word, index) => {
                if (word.trim()) {
                  wordTimestamps.push({
                    word: word.replace(/[.,!?]/g, ""),
                    originalWord: word,
                    startTime: currentTime + index * 0.6,
                    endTime: currentTime + (index + 1) * 0.6,
                    status: "new",
                  });
                }
              });
            } else {
              interimTranscript += transcript;
            }
          }

          fullTranscript += finalTranscript;
          displayTranscript(wordTimestamps, interimTranscript);
        };

        recognition.onerror = function (event) {
          console.error("Speech recognition error:", event.error);
          document.getElementById(
            "status"
          ).innerHTML = `‚ùå L·ªói: ${event.error}`;
          isTranscribing = false;
          document.getElementById("transcribeBtn").disabled = false;
        };

        recognition.onend = function () {
          isTranscribing = false;
          document.getElementById("transcribeBtn").disabled = false;
          document.getElementById("status").innerHTML =
            "‚úÖ Ho√†n th√†nh transcript ti·∫øng ƒê·ª©c!";
          transcriptData = wordTimestamps;
          generateVocabulary();
          updateStats();
          document.getElementById("startQuizBtn").disabled = false;
        };

        // Start audio and recognition together
        audioPlayer.currentTime = 0;
        audioPlayer.play();
        recognition.start();

        document.getElementById("playBtn").style.display = "none";
        document.getElementById("pauseBtn").style.display = "inline-block";
        document.getElementById("stopBtn").disabled = false;
      }

      function displayTranscript(words, interim) {
        const transcriptContainer = document.getElementById(
          "transcriptContainer"
        );
        const transcript = document.getElementById("transcript");

        transcriptContainer.style.display = "block";

        let html = "";
        words.forEach((wordData, index) => {
          const statusClass =
            wordData.status === "learned"
              ? "learned"
              : wordData.status === "difficult"
              ? "difficult"
              : "";
          html += `<span class="transcript-word ${statusClass}" data-index="${index}" 
                         onclick="seekToWord(${wordData.startTime})">${wordData.originalWord}</span>
                         <span class="word-actions">
                             <button class="word-action-btn" onclick="markAsLearned(${index})" title="ƒê√£ h·ªçc">‚úÖ</button>
                             <button class="word-action-btn" onclick="markAsDifficult(${index})" title="Kh√≥">‚ùå</button>
                             <button class="word-action-btn" onclick="translateWord('${wordData.word}')" title="D·ªãch">üîç</button>
                         </span> `;
        });

        if (interim) {
          html += `<span style="color: #95a5a6; font-style: italic;">${interim}</span>`;
        }

        transcript.innerHTML = html;
      }

      function seekToWord(time) {
        audioPlayer.currentTime = time;
        if (audioPlayer.paused) {
          audioPlayer.play();
          document.getElementById("playBtn").style.display = "none";
          document.getElementById("pauseBtn").style.display = "inline-block";
          document.getElementById("stopBtn").disabled = false;
        }
      }

      function markAsLearned(index) {
        if (transcriptData[index]) {
          transcriptData[index].status = "learned";
          updateTranscriptDisplay();
          updateVocabularyDisplay();
          updateStats();
        }
      }

      function markAsDifficult(index) {
        if (transcriptData[index]) {
          transcriptData[index].status = "difficult";
          updateTranscriptDisplay();
          updateVocabularyDisplay();
          updateStats();
        }
      }

      function translateWord(word) {
        // Simple translation (in real app, you'd use a translation API)
        const translations = {
          hallo: "xin ch√†o",
          guten: "t·ªët",
          tag: "ng√†y",
          morgen: "bu·ªïi s√°ng",
          abend: "bu·ªïi t·ªëi",
          nacht: "ƒë√™m",
          ich: "t√¥i",
          du: "b·∫°n",
          er: "anh ·∫•y",
          sie: "c√¥ ·∫•y",
          wir: "ch√∫ng ta",
          ihr: "c√°c b·∫°n",
          bin: "l√†",
          ist: "l√†",
          sind: "l√†",
          haben: "c√≥",
          hat: "c√≥",
          machen: "l√†m",
          gehen: "ƒëi",
          kommen: "ƒë·∫øn",
          sprechen: "n√≥i",
          lernen: "h·ªçc",
          arbeiten: "l√†m vi·ªác",
          essen: "ƒÉn",
          trinken: "u·ªëng",
          schlafen: "ng·ªß",
          wohnen: "s·ªëng",
          lieben: "y√™u",
          k√∂nnen: "c√≥ th·ªÉ",
          m√ºssen: "ph·∫£i",
          sollen: "n√™n",
          wollen: "mu·ªën",
          deutsch: "ti·∫øng ƒê·ª©c",
          english: "ti·∫øng Anh",
          vietnamesisch: "ti·∫øng Vi·ªát",
          haus: "nh√†",
          auto: "xe h∆°i",
          schule: "tr∆∞·ªùng h·ªçc",
          universit√§t: "ƒë·∫°i h·ªçc",
          arbeit: "c√¥ng vi·ªác",
          freund: "b·∫°n",
          familie: "gia ƒë√¨nh",
          vater: "b·ªë",
          mutter: "m·∫π",
          kind: "con",
          bruder: "anh/em trai",
          schwester: "ch·ªã/em g√°i",
          wasser: "n∆∞·ªõc",
          brot: "b√°nh m√¨",
          fleisch: "th·ªãt",
          gem√ºse: "rau",
          obst: "tr√°i c√¢y",
          buch: "s√°ch",
          zeit: "th·ªùi gian",
          geld: "ti·ªÅn",
          leben: "cu·ªôc s·ªëng",
          welt: "th·∫ø gi·ªõi",
          land: "ƒë·∫•t n∆∞·ªõc",
          stadt: "th√†nh ph·ªë",
          dorf: "l√†ng",
          stra√üe: "ƒë∆∞·ªùng ph·ªë",
          platz: "qu·∫£ng tr∆∞·ªùng",
          bahnhof: "ga t√†u",
          flughafen: "s√¢n bay",
          hotel: "kh√°ch s·∫°n",
          restaurant: "nh√† h√†ng",
          laden: "c·ª≠a h√†ng",
          markt: "ch·ª£",
          bank: "ng√¢n h√†ng",
          post: "b∆∞u ƒëi·ªán",
          krankenhaus: "b·ªánh vi·ªán",
          arzt: "b√°c sƒ©",
          lehrer: "gi√°o vi√™n",
          student: "sinh vi√™n",
          verk√§ufer: "nh√¢n vi√™n b√°n h√†ng",
          polizei: "c·∫£nh s√°t",
          rot: "ƒë·ªè",
          blau: "xanh d∆∞∆°ng",
          gr√ºn: "xanh l√°",
          gelb: "v√†ng",
          schwarz: "ƒëen",
          wei√ü: "tr·∫Øng",
          gro√ü: "l·ªõn",
          klein: "nh·ªè",
          alt: "gi√†",
          jung: "tr·∫ª",
          neu: "m·ªõi",
          gut: "t·ªët",
          schlecht: "x·∫•u",
          sch√∂n: "ƒë·∫πp",
          h√§sslich: "x·∫•u x√≠",
          schnell: "nhanh",
          langsam: "ch·∫≠m",
          teuer: "ƒë·∫Øt",
          billig: "r·∫ª",
          eins: "m·ªôt",
          zwei: "hai",
          drei: "ba",
          vier: "b·ªën",
          f√ºnf: "nƒÉm",
          sechs: "s√°u",
          sieben: "b·∫£y",
          acht: "t√°m",
          neun: "ch√≠n",
          zehn: "m∆∞·ªùi",
          montag: "th·ª© hai",
          dienstag: "th·ª© ba",
          mittwoch: "th·ª© t∆∞",
          donnerstag: "th·ª© nƒÉm",
          freitag: "th·ª© s√°u",
          samstag: "th·ª© b·∫£y",
          sonntag: "ch·ªß nh·∫≠t",
          januar: "th√°ng m·ªôt",
          februar: "th√°ng hai",
          m√§rz: "th√°ng ba",
          april: "th√°ng t∆∞",
          mai: "th√°ng nƒÉm",
          juni: "th√°ng s√°u",
          juli: "th√°ng b·∫£y",
          august: "th√°ng t√°m",
          september: "th√°ng ch√≠n",
          oktober: "th√°ng m∆∞·ªùi",
          november: "th√°ng m∆∞·ªùi m·ªôt",
          dezember: "th√°ng m∆∞·ªùi hai",
        };

        const translation =
          translations[word.toLowerCase()] || "Kh√¥ng t√¨m th·∫•y nghƒ©a";
        alert(`${word} = ${translation}`);
      }

      function generateVocabulary() {
        vocabularyData = transcriptData.map((item) => ({
          german: item.word,
          vietnamese: getTranslation(item.word),
          status: item.status,
          timestamp: item.startTime,
          example: `"${item.originalWord}" (${formatTime(item.startTime)})`,
        }));
        updateVocabularyDisplay();
      }

      function getTranslation(word) {
        const translations = {
          hallo: "xin ch√†o",
          guten: "t·ªët",
          tag: "ng√†y",
          morgen: "bu·ªïi s√°ng",
          abend: "bu·ªïi t·ªëi",
          nacht: "ƒë√™m",
          ich: "t√¥i",
          du: "b·∫°n",
          er: "anh ·∫•y",
          sie: "c√¥ ·∫•y",
          wir: "ch√∫ng ta",
          ihr: "c√°c b·∫°n",
          bin: "l√†",
          ist: "l√†",
          sind: "l√†",
          haben: "c√≥",
          hat: "c√≥",
          deutsch: "ti·∫øng ƒê·ª©c",
          english: "ti·∫øng Anh",
          vietnamesisch: "ti·∫øng Vi·ªát",
          haus: "nh√†",
          auto: "xe h∆°i",
          schule: "tr∆∞·ªùng h·ªçc",
          buch: "s√°ch",
          zeit: "th·ªùi gian",
          geld: "ti·ªÅn",
          wasser: "n∆∞·ªõc",
          brot: "b√°nh m√¨",
        };
        return translations[word.toLowerCase()] || "Ch∆∞a c√≥ nghƒ©a";
      }

      function updateVocabularyDisplay() {
        const vocabularyList = document.getElementById("vocabularyList");

        if (vocabularyData.length === 0) {
          vocabularyList.innerHTML =
            '<div style="text-align: center; color: #7f8c8d; padding: 40px;">Ch∆∞a c√≥ t·ª´ v·ª±ng n√†o. H√£y t·∫°o transcript tr∆∞·ªõc!</div>';
          return;
        }

        let html = "";
        vocabularyData.forEach((vocab, index) => {
          const statusClass =
            vocab.status === "learned"
              ? "learned"
              : vocab.status === "difficult"
              ? "difficult"
              : "";
          html += `
                    <div class="vocab-card ${statusClass}">
                        <div class="vocab-word">${vocab.german}</div>
                        <div class="vocab-translation">${vocab.vietnamese}</div>
                        <div class="vocab-example">${vocab.example}</div>
                        <div class="vocab-actions">
                            <button class="vocab-btn learn" onclick="markVocabAsLearned(${index})">‚úÖ ƒê√£ h·ªçc</button>
                            <button class="vocab-btn difficult" onclick="markVocabAsDifficult(${index})">‚ùå Kh√≥</button>
                            <button class="vocab-btn play" onclick="playVocabAudio(${vocab.timestamp})">üîä Nghe</button>
                        </div>
                    </div>
                `;
        });

        vocabularyList.innerHTML = html;
      }

      function markVocabAsLearned(index) {
        vocabularyData[index].status = "learned";
        if (transcriptData[index]) {
          transcriptData[index].status = "learned";
        }
        updateVocabularyDisplay();
        updateTranscriptDisplay();
        updateStats();
      }

      function markVocabAsDifficult(index) {
        vocabularyData[index].status = "difficult";
        if (transcriptData[index]) {
          transcriptData[index].status = "difficult";
        }
        updateVocabularyDisplay();
        updateTranscriptDisplay();
        updateStats();
        updateReviewContent();
      }

      function playVocabAudio(timestamp) {
        audioPlayer.currentTime = timestamp;
        audioPlayer.play();
        document.getElementById("playBtn").style.display = "none";
        document.getElementById("pauseBtn").style.display = "inline-block";
        document.getElementById("stopBtn").disabled = false;
      }

      function updateTranscriptDisplay() {
        if (transcriptData.length === 0) return;

        const transcript = document.getElementById("transcript");
        let html = "";

        transcriptData.forEach((wordData, index) => {
          const statusClass =
            wordData.status === "learned"
              ? "learned"
              : wordData.status === "difficult"
              ? "difficult"
              : "";
          html += `<span class="transcript-word ${statusClass}" data-index="${index}" 
                         onclick="seekToWord(${wordData.startTime})">${wordData.originalWord}</span>
                         <span class="word-actions">
                             <button class="word-action-btn" onclick="markAsLearned(${index})" title="ƒê√£ h·ªçc">‚úÖ</button>
                             <button class="word-action-btn" onclick="markAsDifficult(${index})" title="Kh√≥">‚ùå</button>
                             <button class="word-action-btn" onclick="translateWord('${wordData.word}')" title="D·ªãch">üîç</button>
                         </span> `;
        });

        transcript.innerHTML = html;
      }

      function updateStats() {
        const total = transcriptData.length;
        const learned = transcriptData.filter(
          (item) => item.status === "learned"
        ).length;
        const difficult = transcriptData.filter(
          (item) => item.status === "difficult"
        ).length;

        document.getElementById("totalWords").textContent = total;
        document.getElementById("learnedWords").textContent = learned;
        document.getElementById("difficultWords").textContent = difficult;
        document.getElementById("quizScore").textContent = quizScore;
      }

      function startQuiz() {
        if (transcriptData.length === 0) {
          alert("C·∫ßn t·∫°o transcript tr∆∞·ªõc khi l√†m quiz!");
          return;
        }

        // Create quiz from vocabulary
        quizData = vocabularyData
          .filter((item) => item.status !== "learned")
          .slice(0, 10);
        if (quizData.length === 0) {
          alert("B·∫°n ƒë√£ h·ªçc h·∫øt t·ª´ v·ª±ng! Tuy·ªát v·ªùi!");
          return;
        }

        currentQuizIndex = 0;
        showQuizQuestion();
      }

      function showQuizQuestion() {
        if (currentQuizIndex >= quizData.length) {
          showQuizResult();
          return;
        }

        const question = quizData[currentQuizIndex];
        const options = generateQuizOptions(question);

        const quizContent = document.getElementById("quizContent");
        quizContent.innerHTML = `
                <div class="quiz-question">
                    T·ª´ "${question.german}" c√≥ nghƒ©a l√† g√¨?
                </div>
                <div class="quiz-options">
                    ${options
                      .map(
                        (option, index) => `
                        <div class="quiz-option" onclick="selectQuizAnswer(${index}, '${option}', '${question.vietnamese}')">
                            ${option}
                        </div>
                    `
                      )
                      .join("")}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="control-btn" onclick="playVocabAudio(${
                      question.timestamp
                    })">
                        üîä Nghe ph√°t √¢m
                    </button>
                </div>
            `;
      }

      function generateQuizOptions(question) {
        const correctAnswer = question.vietnamese;
        const wrongAnswers = [
          "xin ch√†o",
          "t·∫°m bi·ªát",
          "c·∫£m ∆°n",
          "xin l·ªói",
          "c√≥",
          "kh√¥ng",
          "t·ªët",
          "x·∫•u",
          "l·ªõn",
          "nh·ªè",
          "nhanh",
          "ch·∫≠m",
          "ƒë·ªè",
          "xanh",
          "nh√†",
          "xe",
          "s√°ch",
          "ti·ªÅn",
          "n∆∞·ªõc",
          "b√°nh m√¨",
          "th·ªãt",
          "t√¥i",
          "b·∫°n",
          "anh ·∫•y",
          "c√¥ ·∫•y",
          "ch√∫ng ta",
          "h·ªç",
          "l√†m",
          "ƒëi",
          "ƒë·∫øn",
          "n√≥i",
          "h·ªçc",
          "l√†m vi·ªác",
          "ƒÉn",
          "u·ªëng",
        ].filter((answer) => answer !== correctAnswer);

        const options = [correctAnswer];
        while (options.length < 4 && wrongAnswers.length > 0) {
          const randomIndex = Math.floor(Math.random() * wrongAnswers.length);
          options.push(wrongAnswers.splice(randomIndex, 1)[0]);
        }

        return options.sort(() => Math.random() - 0.5);
      }

      function selectQuizAnswer(selectedIndex, selectedAnswer, correctAnswer) {
        const options = document.querySelectorAll(".quiz-option");
        options.forEach((option, index) => {
          option.style.pointerEvents = "none";
          if (option.textContent === correctAnswer) {
            option.classList.add("correct");
          } else if (
            index === selectedIndex &&
            selectedAnswer !== correctAnswer
          ) {
            option.classList.add("wrong");
          }
        });

        if (selectedAnswer === correctAnswer) {
          quizScore += 10;
          updateStats();
        }

        setTimeout(() => {
          currentQuizIndex++;
          showQuizQuestion();
        }, 2000);
      }

      function showQuizResult() {
        const percentage = Math.round(
          (quizScore / (quizData.length * 10)) * 100
        );
        document.getElementById("quizContent").innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2>üéâ K·∫øt qu·∫£ Quiz</h2>
                    <p style="font-size: 24px; margin: 20px 0;">
                        ƒêi·ªÉm: ${quizScore}/${
          quizData.length * 10
        } (${percentage}%)
                    </p>
                    <button class="control-btn" onclick="startQuiz()">
                        üîÑ L√†m l·∫°i
                    </button>
                </div>
            `;
      }

      function updateReviewContent() {
        const difficultWords = vocabularyData.filter(
          (item) => item.status === "difficult"
        );
        const reviewContent = document.getElementById("reviewContent");

        if (difficultWords.length === 0) {
          reviewContent.innerHTML =
            '<div style="text-align: center; color: #7f8c8d; padding: 40px;">Ch∆∞a c√≥ t·ª´ kh√≥ n√†o ƒë·ªÉ √¥n t·∫≠p</div>';
          return;
        }

        let html = '<div class="vocabulary-list">';
        difficultWords.forEach((vocab, index) => {
          html += `
                    <div class="vocab-card difficult">
                        <div class="vocab-word">${vocab.german}</div>
                        <div class="vocab-translation">${vocab.vietnamese}</div>
                        <div class="vocab-example">${vocab.example}</div>
                        <div class="vocab-actions">
                            <button class="vocab-btn learn" onclick="markVocabAsLearned(${vocabularyData.indexOf(
                              vocab
                            )})">‚úÖ ƒê√£ h·ªçc</button>
                            <button class="vocab-btn play" onclick="playVocabAudio(${
                              vocab.timestamp
                            })">üîä Nghe</button>
                        </div>
                    </div>
                `;
        });
        html += "</div>";

        reviewContent.innerHTML = html;
      }

      function startWordSync() {
        if (transcriptData.length === 0) return;

        const syncInterval = setInterval(() => {
          if (audioPlayer.paused) {
            clearInterval(syncInterval);
            return;
          }

          const currentTime = audioPlayer.currentTime;

          // Check repeat function
          if (isRepeating && repeatStart !== null && repeatEnd !== null) {
            if (currentTime >= repeatEnd) {
              audioPlayer.currentTime = repeatStart;
            }
          }

          // Remove active class from all words
          document.querySelectorAll(".transcript-word").forEach((word) => {
            word.classList.remove("active");
          });

          // Find and highlight current word
          for (let i = 0; i < transcriptData.length; i++) {
            const wordData = transcriptData[i];
            if (
              currentTime >= wordData.startTime &&
              currentTime <= wordData.endTime
            ) {
              const wordElement = document.querySelector(`[data-index="${i}"]`);
              if (wordElement) {
                wordElement.classList.add("active");
                wordElement.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
              }
              break;
            }
          }
        }, 100);
      }

      function stopWordSync() {
        document.querySelectorAll(".transcript-word").forEach((word) => {
          word.classList.remove("active");
        });
      }

      // Audio player event listeners
      audioPlayer.addEventListener("timeupdate", function () {
        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        document.getElementById("progressFill").style.width = progress + "%";

        const currentTime = formatTime(audioPlayer.currentTime);
        const duration = formatTime(audioPlayer.duration);
        document.getElementById(
          "timeDisplay"
        ).textContent = `${currentTime} / ${duration}`;
      });

      audioPlayer.addEventListener("ended", function () {
        document.getElementById("playBtn").style.display = "inline-block";
        document.getElementById("pauseBtn").style.display = "none";
        document.getElementById("stopBtn").disabled = true;
        stopWordSync();
      });

      function formatTime(seconds) {
        if (isNaN(seconds)) return "00:00";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, "0")}:${secs
          .toString()
          .padStart(2, "0")}`;
      }
    </script>
  </body>
</html>
