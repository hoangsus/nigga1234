<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Conversation AI - LinguaTreff</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .name-settings {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        .name-settings h3 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        
        .name-inputs {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .name-input-group {
            flex: 1;
            min-width: 200px;
        }
        
        .name-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .name-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .name-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 206, 201, 0.3);
        }
        
        .role-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .role-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .role-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .role-option input[type="radio"] {
            accent-color: #667eea;
        }
        
        .role-option input[type="radio"]:checked + span {
            color: #667eea;
            font-weight: bold;
        }
        
        .conversation-container {
            margin-top: 20px;
        }
        
        .current-roles {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #b8daff;
        }
        
        .role-display {
            margin-bottom: 8px;
        }
        
        .role-display:last-child {
            margin-bottom: 0;
        }
        
        .conversation-area {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }
        
        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.ai {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            color: #2d3436;
        }
        
        .message.error {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            margin: 0 auto;
            text-align: center;
            max-width: 90%;
        }
        
        .message.success {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            margin: 0 auto;
            text-align: center;
            max-width: 90%;
        }
        
        .message .speaker {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #00b894, #00cec9);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }
        
        .expected-response {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-style: italic;
            color: #155724;
        }
        
        .expected-response strong {
            color: #0c5460;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mic-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
        }
        
        .mic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(238, 90, 111, 0.3);
        }
        
        .mic-btn.recording {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            animation: pulse 1s infinite;
        }
        
        .mic-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .speak-btn {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }
        
        .speak-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 206, 201, 0.3);
        }
        
        .restart-btn {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
        }
        
        .restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(225, 112, 85, 0.3);
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #636e72, #2d3436);
            color: white;
        }
        
        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 110, 114, 0.3);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .status.listening {
            background: #dff0d8;
            color: #3c763d;
        }
        
        .status.speaking {
            background: #d9edf7;
            color: #31708f;
        }
        
        .status.error {
            background: #f2dede;
            color: #a94442;
        }
        
        .voice-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            justify-content: center;
        }
        
        .voice-select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .speed-slider {
            width: 100px;
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9em;
            color: #666;
        }
        
        .debug-info h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        @media (max-width: 768px) {
            .name-inputs {
                flex-direction: column;
            }
            
            .role-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .voice-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 LinguaTreff AI</h1>
            <p>Luyện tập hội thoại tiếng Đức với AI - Theo thứ tự chính xác</p>
        </div>
        
        <div class="main-content">
            <div class="name-settings" id="nameSettings">
                <h3>⚙️ Cài đặt thông tin nhân vật</h3>
                <div class="name-inputs">
                    <div class="name-input-group">
                        <label for="teacherName">Tên giáo viên:</label>
                        <input type="text" id="teacherName" class="name-input" value="Frau Schwarz" placeholder="Nhập tên giáo viên">
                    </div>
                    <div class="name-input-group">
                        <label for="studentFirstName">Tên (Vorname) học viên:</label>
                        <input type="text" id="studentFirstName" class="name-input" value="Marie" placeholder="Nhập tên học viên">
                    </div>
                    <div class="name-input-group">
                        <label for="studentLastName">Họ (Familienname) học viên:</label>
                        <input type="text" id="studentLastName" class="name-input" value="Platini" placeholder="Nhập họ học viên">
                    </div>
                    <div class="name-input-group">
                        <label for="studentCity">Thành phố học viên:</label>
                        <input type="text" id="studentCity" class="name-input" value="Fribourg" placeholder="Nhập thành phố">
                    </div>
                    <div class="name-input-group">
                        <label for="studentCountry">Đất nước:</label>
                        <input type="text" id="studentCountry" class="name-input" value="Schweiz" placeholder="Nhập đất nước (tiếng Đức)">
                    </div>
                    <div class="name-input-group">
                        <label for="studentAddress">Địa chỉ học viên:</label>
                        <input type="text" id="studentAddress" class="name-input" value="Hauptstraße 15" placeholder="Nhập địa chỉ">
                    </div>
                    <div class="name-input-group">
                        <label for="courseLevel">Cấp độ khóa học:</label>
                        <input type="text" id="courseLevel" class="name-input" value="A 1.1" placeholder="Nhập cấp độ khóa học">
                    </div>
                    <div class="name-input-group">
                        <label for="schoolName">Tên trường:</label>
                        <input type="text" id="schoolName" class="name-input" value="LinguaTreff" placeholder="Nhập tên trường">
                    </div>
                </div>
                
                <div class="role-selector">
                    <h4>Chọn vai của bạn:</h4>
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 10px;">
                        <label class="role-option">
                            <input type="radio" name="userRole" value="teacher" id="roleTeacher">
                            <span>👩‍🏫 Tôi đóng vai giáo viên</span>
                        </label>
                        <label class="role-option">
                            <input type="radio" name="userRole" value="student" id="roleStudent" checked>
                            <span>👩‍🎓 Tôi đóng vai học viên</span>
                        </label>
                    </div>
                </div>
                
                <button class="save-btn" id="saveNames">💾 Lưu thông tin & Bắt đầu</button>
            </div>
            
            <div class="conversation-container" id="conversationContainer" style="display: none;">
            
            <div class="progress-text">Tiến độ hội thoại</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            
            <div class="current-roles" id="currentRoles">
                <div class="role-display">
                    <strong>👤 Bạn đóng vai:</strong> <span id="userRoleDisplay">Chưa chọn</span>
                </div>
                <div class="role-display">
                    <strong>🤖 AI đóng vai:</strong> <span id="aiRoleDisplay">Chưa chọn</span>
                </div>
            </div>
            
            <div class="expected-response" id="expectedResponse">
                <strong>Chuẩn bị bắt đầu cuộc hội thoại...</strong>
            </div>
            
            <div class="conversation-area" id="conversationArea"></div>
            
            <div class="controls">
                <button class="control-btn mic-btn" id="micBtn">
                    🎤 Nói
                </button>
                <button class="control-btn speak-btn" id="speakBtn">
                    🔊 Phát lại
                </button>
                <button class="control-btn restart-btn" id="restartBtn">
                    🔄 Bắt đầu lại
                </button>
                <button class="control-btn clear-btn" id="clearBtn">
                    🗑️ Xóa hết
                </button>
                <button class="control-btn clear-btn" id="newConversationBtn">
                    ⚙️ Cài đặt mới
                </button>
            </div>
            
            <div class="voice-controls">
                <select class="voice-select" id="voiceSelect">
                    <option value="">Chọn giọng nói...</option>
                </select>
                <div class="speed-control">
                    <label>Tốc độ:</label>
                    <input type="range" class="speed-slider" id="speedSlider" min="0.5" max="2" step="0.1" value="1">
                    <span id="speedValue">1.0x</span>
                </div>
            </div>
            
            <div class="debug-info" id="debugInfo" style="display: none;">
                <h4>Debug Info:</h4>
                <div id="debugContent"></div>
            </div>
            
            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        class GermanConversationAI {
            constructor() {
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                this.voices = [];
                this.currentVoice = null;
                this.isRecording = false;
                this.conversationHistory = [];
                this.speed = 1.0;
                this.currentStep = 0;
                this.teacherName = 'Frau Schwarz';
                this.studentFirstName = 'Marie';
                this.studentLastName = 'Platini';
                this.studentCity = 'Fribourg';
                this.studentCountry = 'Schweiz';
                this.studentAddress = 'Hauptstraße 15';
                this.courseLevel = 'A 1.1';
                this.schoolName = 'LinguaTreff';
                this.userRole = 'student'; // 'teacher' or 'student'
                this.conversationStarted = false;
                this.waitingForAI = false;
                this.debugMode = false;
                
                // Complete conversation sequence from the image
                this.conversationSequence = [
                    // Step 0: Teacher starts
                    {
                        speaker: 'teacher',
                        text: 'Sprachschule LinguaTreff. Sie sprechen mit Frau Schwarz. Guten Tag.',
                        expectedResponse: 'Guten Tag, ich möchte mich anmelden.',
                        keywords: ['guten tag', 'anmelden', 'möchte']
                    },
                    // Step 1: Student responds
                    {
                        speaker: 'student',
                        text: 'Guten Tag, ich möchte mich anmelden.',
                        expectedResponse: 'Gern. Für welchen Kurs denn, bitte?',
                        keywords: ['gern', 'welchen kurs', 'bitte']
                    },
                    // Step 2: Teacher responds
                    {
                        speaker: 'teacher',
                        text: 'Gern. Für welchen Kurs denn, bitte?',
                        expectedResponse: 'Anfänger, also A 1.1.',
                        keywords: ['anfänger', 'a 1.1', 'also']
                    },
                    // Step 3: Student responds
                    {
                        speaker: 'student',
                        text: 'Anfänger, also A 1.1.',
                        expectedResponse: 'Gut, ja. Wie heißen Sie, bitte?',
                        keywords: ['gut', 'wie heißen', 'bitte']
                    },
                    // Step 4: Teacher responds
                    {
                        speaker: 'teacher',
                        text: 'Gut, ja. Wie heißen Sie, bitte?',
                        expectedResponse: 'Platini.',
                        keywords: ['platini']
                    },
                    // Step 5: Student responds
                    {
                        speaker: 'student',
                        text: 'Platini.',
                        expectedResponse: 'Wiederholen Sie das bitte.',
                        keywords: ['wiederholen', 'bitte']
                    },
                    // Step 6: Teacher responds
                    {
                        speaker: 'teacher',
                        text: 'Wiederholen Sie das bitte.',
                        expectedResponse: 'Nein, nur mit „i".',
                        keywords: ['nein', 'nur mit', 'i']
                    },
                    // Step 7: Student responds
                    {
                        speaker: 'student',
                        text: 'Nein, nur mit „i".',
                        expectedResponse: 'Okay. Ich buchstabiere: P-L-A-T-I-N-I.',
                        keywords: ['okay', 'buchstabiere', 'p-l-a-t-i-n-i']
                    },
                    // Step 8: Teacher responds
                    {
                        speaker: 'teacher',
                        text: 'Okay. Ich buchstabiere: P-L-A-T-I-N-I.',
                        expectedResponse: 'Richtig.',
                        keywords: ['richtig']
                    },
                    // Step 9: Student responds
                    {
                        speaker: 'student',
                        text: 'Richtig.',
                        expectedResponse: 'Und Ihr Vorname, bitte?',
                        keywords: ['vorname', 'bitte']
                    },
                    // Step 10: Teacher asks for first name
                    {
                        speaker: 'teacher',
                        text: 'Und Ihr Vorname, bitte?',
                        expectedResponse: 'Marie.',
                        keywords: ['marie']
                    },
                    // Step 11: Student gives first name
                    {
                        speaker: 'student',
                        text: 'Marie.',
                        expectedResponse: 'Maria?',
                        keywords: ['maria']
                    },
                    // Step 12: Teacher clarifies
                    {
                        speaker: 'teacher',
                        text: 'Maria?',
                        expectedResponse: 'Äh, nein. Marie. Mit „e" am Ende. ... M-A-R-I-E.',
                        keywords: ['nein', 'marie', 'mit e', 'ende', 'm-a-r-i-e']
                    },
                    // Step 13: Student corrects and spells
                    {
                        speaker: 'student',
                        text: 'Äh, nein. Marie. Mit „e" am Ende. ... M-A-R-I-E.',
                        expectedResponse: 'Also Marie Platini.',
                        keywords: ['also', 'marie platini']
                    },
                    // Step 14: Teacher confirms full name
                    {
                        speaker: 'teacher',
                        text: 'Also Marie Platini.',
                        expectedResponse: 'Richtig.',
                        keywords: ['richtig']
                    },
                    // Step 15: Student confirms
                    {
                        speaker: 'student',
                        text: 'Richtig.',
                        expectedResponse: 'Und woher kommen Sie Frau Platini?',
                        keywords: ['woher kommen', 'frau platini']
                    },
                    // Step 16: Teacher asks about origin
                    {
                        speaker: 'teacher',
                        text: 'Und woher kommen Sie Frau Platini?',
                        expectedResponse: 'Ich bin aus Fribourg.',
                        keywords: ['ich bin aus', 'fribourg']
                    },
                    // Step 17: Student answers origin
                    {
                        speaker: 'student',
                        text: 'Ich bin aus Fribourg.',
                        expectedResponse: 'Aus Freiburg?',
                        keywords: ['freiburg']
                    },
                    // Step 18: Teacher clarifies city
                    {
                        speaker: 'teacher',
                        text: 'Aus Freiburg?',
                        expectedResponse: 'Ja, Freiburg in der Schweiz. Das heißt Fribourg. Ich buchstabiere: F-R-I-B-O-U-R-G.',
                        keywords: ['ja', 'freiburg', 'schweiz', 'heißt', 'fribourg', 'buchstabiere', 'f-r-i-b-o-u-r-g']
                    },
                    // Step 19: Student explains and spells city
                    {
                        speaker: 'student',
                        text: 'Ja, Freiburg in der Schweiz. Das heißt Fribourg. Ich buchstabiere: F-R-I-B-O-U-R-G.',
                        expectedResponse: 'Aha. Danke. Das hab ich. Nun noch die Adresse.',
                        keywords: ['aha', 'danke', 'hab ich', 'adresse']
                    },
                    // Step 20: Teacher asks for address
                    {
                        speaker: 'teacher',
                        text: 'Aha. Danke. Das hab ich. Nun noch die Adresse.',
                        expectedResponse: 'Die ist einfach. Also, ich wohne in der Hauptstraße 15.',
                        keywords: ['einfach', 'also', 'wohne', 'hauptstraße 15']
                    },
                    // Step 21: Student gives address
                    {
                        speaker: 'student',
                        text: 'Die ist einfach. Also, ich wohne in der Hauptstraße 15.',
                        expectedResponse: 'Hauptstraße 15. Gut, danke. Das war\'s.',
                        keywords: ['hauptstraße 15', 'gut', 'danke', 'das wars']
                    }
                ];
                
                this.initializeElements();
                this.setupEventListeners();
                this.initializeSpeechRecognition();
                this.loadVoices();
                this.loadSavedData();
                this.updateProgress();
                this.updateExpectedResponse();
                
                // Enable debug mode with Ctrl+D
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'd') {
                        e.preventDefault();
                        this.toggleDebug();
                    }
                });
            }
            
            initializeElements() {
                this.conversationArea = document.getElementById('conversationArea');
                this.micBtn = document.getElementById('micBtn');
                this.speakBtn = document.getElementById('speakBtn');
                this.restartBtn = document.getElementById('restartBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.status = document.getElementById('status');
                this.voiceSelect = document.getElementById('voiceSelect');
                this.speedSlider = document.getElementById('speedSlider');
                this.speedValue = document.getElementById('speedValue');
                this.progressFill = document.getElementById('progressFill');
                this.expectedResponse = document.getElementById('expectedResponse');
                this.teacherNameInput = document.getElementById('teacherName');
                this.studentFirstNameInput = document.getElementById('studentFirstName');
                this.studentLastNameInput = document.getElementById('studentLastName');
                this.studentCityInput = document.getElementById('studentCity');
                this.studentCountryInput = document.getElementById('studentCountry');
                this.studentAddressInput = document.getElementById('studentAddress');
                this.courseLevelInput = document.getElementById('courseLevel');
                this.schoolNameInput = document.getElementById('schoolName');
                this.saveNamesBtn = document.getElementById('saveNames');
                this.roleTeacherInput = document.getElementById('roleTeacher');
                this.roleStudentInput = document.getElementById('roleStudent');
                this.nameSettings = document.getElementById('nameSettings');
                this.conversationContainer = document.getElementById('conversationContainer');
                this.userRoleDisplay = document.getElementById('userRoleDisplay');
                this.aiRoleDisplay = document.getElementById('aiRoleDisplay');
                this.newConversationBtn = document.getElementById('newConversationBtn');
                this.debugInfo = document.getElementById('debugInfo');
                this.debugContent = document.getElementById('debugContent');
            }
            
            setupEventListeners() {
                this.micBtn.addEventListener('click', () => this.toggleRecording());
                this.speakBtn.addEventListener('click', () => this.repeatLastMessage());
                this.restartBtn.addEventListener('click', () => this.restartConversation());
                this.clearBtn.addEventListener('click', () => this.clearConversation());
                this.newConversationBtn.addEventListener('click', () => this.startNewConversation());
                this.saveNamesBtn.addEventListener('click', () => this.saveNamesAndStart());
                
                this.voiceSelect.addEventListener('change', (e) => this.selectVoice(e.target.value));
                this.speedSlider.addEventListener('input', (e) => this.updateSpeed(e.target.value));
                
                // Load voices when they become available
                this.synthesis.addEventListener('voiceschanged', () => this.loadVoices());
            }
            
            toggleDebug() {
                this.debugMode = !this.debugMode;
                this.debugInfo.style.display = this.debugMode ? 'block' : 'none';
                this.updateDebugInfo();
            }
            
            updateDebugInfo() {
                if (!this.debugMode) return;
                
                const currentSequence = this.conversationSequence[this.currentStep];
                const debugData = {
                    'Current Step': this.currentStep,
                    'Total Steps': this.conversationSequence.length,
                    'User Role': this.userRole,
                    'Conversation Started': this.conversationStarted,
                    'Waiting for AI': this.waitingForAI,
                    'Current Speaker': currentSequence ? currentSequence.speaker : 'None',
                    'Is User Turn': this.isUserTurn(),
                    'Expected Response': currentSequence ? currentSequence.expectedResponse : 'None'
                };
                
                this.debugContent.innerHTML = Object.entries(debugData)
                    .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                    .join('<br>');
            }
            
            loadSavedData() {
                // Since we can't use localStorage in artifacts, we'll use variables
                // In a real environment, you would use localStorage here
                this.updateConversationSequence();
            }
            
            saveData() {
                // Since we can't use localStorage in artifacts, this is a placeholder
                // In a real environment, you would save to localStorage here
                console.log('Data saved (placeholder)');
            }
            
            saveNamesAndStart() {
                const newTeacherName = this.teacherNameInput.value.trim();
                const newStudentFirstName = this.studentFirstNameInput.value.trim();
                const newStudentLastName = this.studentLastNameInput.value.trim();
                const newStudentCity = this.studentCityInput.value.trim();
                const newStudentCountry = this.studentCountryInput.value.trim();
                const newStudentAddress = this.studentAddressInput.value.trim();
                const newCourseLevel = this.courseLevelInput.value.trim();
                const newSchoolName = this.schoolNameInput.value.trim();
                const selectedRole = this.roleTeacherInput.checked ? 'teacher' : 'student';
                
                if (newTeacherName && newStudentFirstName && newStudentLastName && newStudentCity && newStudentCountry && newStudentAddress && newCourseLevel && newSchoolName) {
                    this.teacherName = newTeacherName;
                    this.studentFirstName = newStudentFirstName;
                    this.studentLastName = newStudentLastName;
                    this.studentCity = newStudentCity;
                    this.studentCountry = newStudentCountry;
                    this.studentAddress = newStudentAddress;
                    this.courseLevel = newCourseLevel;
                    this.schoolName = newSchoolName;
                    this.userRole = selectedRole;
                    
                    // Save to localStorage (placeholder)
                    this.saveData();
                    
                    // Update conversation sequence
                    this.updateConversationSequence();
                    
                    // Start conversation
                    this.startConversation();
                    
                    this.showStatus('Cuộc hội thoại bắt đầu!', 'success');
                } else {
                    this.showStatus('Vui lòng nhập đầy đủ tất cả thông tin!', 'error');
                }
            }
            
            startConversation() {
                this.conversationStarted = true;
                this.currentStep = 0;
                this.conversationHistory = [];
                this.waitingForAI = false;
                
                // Hide settings, show conversation
                this.nameSettings.style.display = 'none';
                this.conversationContainer.style.display = 'block';
                
                // Update role displays
                if (this.userRole === 'teacher') {
                    this.userRoleDisplay.textContent = this.teacherName;
                    this.aiRoleDisplay.textContent = `${this.studentFirstName} ${this.studentLastName}`;
                } else {
                    this.userRoleDisplay.textContent = `${this.studentFirstName} ${this.studentLastName}`;
                    this.aiRoleDisplay.textContent = this.teacherName;
                }
                
                // Clear conversation area
                this.conversationArea.innerHTML = '';
                
                // Start with first step
                this.updateProgress();
                this.updateExpectedResponse();
                this.updateDebugInfo();
                
                // If AI needs to speak first
                if (!this.isUserTurn()) {
                    setTimeout(() => {
                        this.playAIResponse();
                    }, 1000);
                }
            }
            
            startNewConversation() {
                this.conversationStarted = false;
                this.currentStep = 0;
                this.conversationHistory = [];
                this.waitingForAI = false;
                
                // Show settings, hide conversation
                this.nameSettings.style.display = 'block';
                this.conversationContainer.style.display = 'none';
                
                // Clear conversation area
                this.conversationArea.innerHTML = '';
                this.updateProgress();
                this.updateDebugInfo();
                
                this.showStatus('Có thể cài đặt thông tin mới', 'success');
            }
            
            updateConversationSequence() {
                // Update dynamic parts of the conversation with all customizable fields
                this.conversationSequence[0].text = `Sprachschule ${this.schoolName}. Sie sprechen mit ${this.teacherName}. Guten Tag.`;
                
                // Update course level
                this.conversationSequence[2].expectedResponse = `Anfänger, also ${this.courseLevel}.`;
                this.conversationSequence[3].text = `Anfänger, also ${this.courseLevel}.`;
                
                // Update student last name
                this.conversationSequence[4].expectedResponse = `${this.studentLastName}.`;
                this.conversationSequence[5].text = `${this.studentLastName}.`;
                
                // Update spelling of last name
                const lastNameSpelling = this.studentLastName.split('').join('-');
                this.conversationSequence[7].expectedResponse = `Okay. Ich buchstabiere: ${lastNameSpelling}.`;
                this.conversationSequence[8].text = `Okay. Ich buchstabiere: ${lastNameSpelling}.`;
                
                // Update first name
                this.conversationSequence[10].expectedResponse = `${this.studentFirstName}.`;
                this.conversationSequence[11].text = `${this.studentFirstName}.`;
                
                // Handle different first name spellings
                const firstNameSpelling = this.studentFirstName.split('').join('-');
                this.conversationSequence[12].expectedResponse = `Äh, nein. ${this.studentFirstName}. Mit „${this.studentFirstName.slice(-1)}" am Ende. ... ${firstNameSpelling}.`;
                this.conversationSequence[13].text = `Äh, nein. ${this.studentFirstName}. Mit „${this.studentFirstName.slice(-1)}" am Ende. ... ${firstNameSpelling}.`;
                
                // Update full name confirmation
                this.conversationSequence[14].text = `Also ${this.studentFirstName} ${this.studentLastName}.`;
                this.conversationSequence[15].expectedResponse = `Und woher kommen Sie Frau ${this.studentLastName}?`;
                this.conversationSequence[16].text = `Und woher kommen Sie Frau ${this.studentLastName}?`;
                
                // Update city
                this.conversationSequence[16].expectedResponse = `Ich bin aus ${this.studentCity}.`;
                this.conversationSequence[17].text = `Ich bin aus ${this.studentCity}.`;
                this.conversationSequence[18].text = `Aus ${this.studentCity === 'Fribourg' ? 'Freiburg' : this.studentCity}?`;
                
                // Handle different country contexts
                let countryExplanation = '';
                if (this.studentCountry === 'Schweiz' && this.studentCity === 'Fribourg') {
                    countryExplanation = `Ja, Freiburg in der ${this.studentCountry}. Das heißt ${this.studentCity}. Ich buchstabiere: ${this.studentCity.split('').join('-')}.`;
                } else {
                    countryExplanation = `Ja, ${this.studentCity} in der ${this.studentCountry}. Ich buchstabiere: ${this.studentCity.split('').join('-')}.`;
                }
                this.conversationSequence[18].expectedResponse = countryExplanation;
                this.conversationSequence[19].text = countryExplanation;
                
                // Update address
                this.conversationSequence[20].expectedResponse = `Die ist einfach. Also, ich wohne in der ${this.studentAddress}.`;
                this.conversationSequence[21].text = `Die ist einfach. Also, ich wohne in der ${this.studentAddress}.`;
                this.conversationSequence[21].expectedResponse = `${this.studentAddress}. Gut, danke. Das war's.`;
                
                // Update keywords for all steps
                this.updateKeywords();
            }
            
            updateKeywords() {
                // Update keywords based on dynamic content
                this.conversationSequence[2].keywords = ['anfänger', 'also', this.courseLevel.toLowerCase()];
                this.conversationSequence[4].keywords = [this.studentLastName.toLowerCase()];
                this.conversationSequence[7].keywords = ['okay', 'buchstabiere', this.studentLastName.toLowerCase()];
                this.conversationSequence[10].keywords = [this.studentFirstName.toLowerCase()];
                this.conversationSequence[12].keywords = ['nein', this.studentFirstName.toLowerCase(), 'mit', 'ende'];
                this.conversationSequence[14].keywords = ['also', this.studentFirstName.toLowerCase(), this.studentLastName.toLowerCase()];
                this.conversationSequence[16].keywords = ['ich bin aus', this.studentCity.toLowerCase()];
                this.conversationSequence[18].keywords = ['ja', this.studentCity.toLowerCase(), this.studentCountry.toLowerCase(), 'buchstabiere'];
                this.conversationSequence[20].keywords = ['einfach', 'also', 'wohne', this.studentAddress.toLowerCase()];
                this.conversationSequence[21].keywords = [this.studentAddress.toLowerCase(), 'gut', 'danke', 'das wars'];
            }
            
            isUserTurn() {
                if (this.currentStep >= this.conversationSequence.length) {
                    return false;
                }
                
                const currentSequence = this.conversationSequence[this.currentStep];
                return currentSequence.speaker === this.userRole;
            }
            
            playAIResponse() {
                if (this.currentStep >= this.conversationSequence.length) {
                    return;
                }
                
                const currentSequence = this.conversationSequence[this.currentStep];
                
                if (currentSequence.speaker !== this.userRole) {
                    this.waitingForAI = true;
                    this.addMessage(currentSequence.text, 'ai');
                    this.speakText(currentSequence.text);
                    
                    setTimeout(() => {
                        this.currentStep++;
                        this.waitingForAI = false;
                        this.updateProgress();
                        this.updateExpectedResponse();
                        this.updateDebugInfo();
                    }, 1000);
                }
            }
            
            initializeSpeechRecognition() {
                if ('webkitSpeechRecognition' in window) {
                    this.recognition = new webkitSpeechRecognition();
                } else if ('SpeechRecognition' in window) {
                    this.recognition = new SpeechRecognition();
                } else {
                    this.showStatus('Trình duyệt không hỗ trợ nhận diện giọng nói', 'error');
                    return;
                }
                
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                this.recognition.lang = 'de-DE';
                
                this.recognition.onstart = () => {
                    this.showStatus('Đang nghe...', 'listening');
                    this.isRecording = true;
                    this.micBtn.classList.add('recording');
                    this.micBtn.textContent = '🛑 Dừng';
                };
                
                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    this.processUserInput(transcript);
                };
                
                this.recognition.onerror = (event) => {
                    this.showStatus('Lỗi nhận diện: ' + event.error, 'error');
                    this.stopRecording();
                };
                
                this.recognition.onend = () => {
                    this.stopRecording();
                };
            }
            
            processUserInput(transcript) {
                this.addMessage(transcript, 'user');
                
                // Check if conversation is completed
                if (this.currentStep >= this.conversationSequence.length) {
                    this.addMessage('Cuộc hội thoại đã hoàn thành! 🎉', 'success');
                    this.showStatus('Cuộc hội thoại đã hoàn thành!', 'success');
                    return;
                }
                
                // Check if it's user's turn
                if (!this.isUserTurn()) {
                    this.addMessage('❌ Chưa đến lượt bạn nói!', 'error');
                    return;
                }
                
                const currentSequence = this.conversationSequence[this.currentStep];
                const expectedText = currentSequence.expectedResponse;
                
                // Check if response matches
                if (this.isTextMatch(transcript, expectedText, currentSequence.keywords)) {
                    // Correct response
                    this.addMessage('✅ Chính xác!', 'success');
                    this.currentStep++;
                    this.updateProgress();
                    this.updateExpectedResponse();
                    this.updateDebugInfo();
                    
                    // If next step is AI's turn, play AI response
                    if (this.currentStep < this.conversationSequence.length && !this.isUserTurn()) {
                        setTimeout(() => {
                            this.playAIResponse();
                        }, 1500);
                    }
                } else {
                    // Incorrect response
                    this.addMessage(`❌ Không chính xác. Vui lòng nói: "${expectedText}"`, 'error');
                    setTimeout(() => {
                        this.speakText(expectedText);
                    }, 1000);
                }
            }
            
            normalizeText(text) {
                return text.toLowerCase()
                    .replace(/[.,!?;:„"]/g, '')
                    .replace(/\s+/g, ' ')
                    .replace(/ä/g, 'ae')
                    .replace(/ö/g, 'oe')
                    .replace(/ü/g, 'ue')
                    .replace(/ß/g, 'ss')
                    .trim();
            }
            
            isTextMatch(input, expected, keywords) {
                const normalizedInput = this.normalizeText(input);
                const normalizedExpected = this.normalizeText(expected);
                
                // First check: exact match (high threshold)
                if (this.calculateSimilarity(normalizedInput, normalizedExpected) > 0.8) {
                    return true;
                }
                
                // Second check: keyword matching
                if (keywords && keywords.length > 0) {
                    const keywordMatches = keywords.filter(keyword => 
                        normalizedInput.includes(this.normalizeText(keyword))
                    );
                    
                    if (keywordMatches.length >= Math.ceil(keywords.length * 0.6)) {
                        return true;
                    }
                }
                
                // Third check: flexible similarity for short responses
                if (normalizedExpected.length < 20) {
                    return this.calculateSimilarity(normalizedInput, normalizedExpected) > 0.6;
                }
                
                // Fourth check: contains essential words
                const essentialWords = this.extractEssentialWords(normalizedExpected);
                const inputWords = normalizedInput.split(' ');
                const matchedEssential = essentialWords.filter(word => 
                    inputWords.some(inputWord => inputWord.includes(word) || word.includes(inputWord))
                );
                
                return matchedEssential.length >= Math.ceil(essentialWords.length * 0.7);
            }
            
            extractEssentialWords(text) {
                const fillerWords = ['der', 'die', 'das', 'ein', 'eine', 'und', 'oder', 'aber', 'in', 'mit', 'von', 'zu', 'auf', 'für', 'ist', 'sind', 'war', 'waren', 'haben', 'hat', 'werden', 'wird', 'ich', 'sie', 'er', 'wir', 'ihr', 'also', 'ja', 'nein', 'gut', 'okay', 'äh', 'nun'];
                
                return text.split(' ').filter(word => 
                    word.length > 2 && !fillerWords.includes(word)
                );
            }
            
            calculateSimilarity(str1, str2) {
                const words1 = str1.split(' ').filter(w => w.length > 0);
                const words2 = str2.split(' ').filter(w => w.length > 0);
                const maxLength = Math.max(words1.length, words2.length);
                
                if (maxLength === 0) return 1;
                
                let matches = 0;
                for (let word1 of words1) {
                    for (let word2 of words2) {
                        if (word1 === word2 || word1.includes(word2) || word2.includes(word1)) {
                            matches++;
                            break;
                        }
                    }
                }
                
                return matches / maxLength;
            }
            
            updateProgress() {
                const progress = (this.currentStep / this.conversationSequence.length) * 100;
                this.progressFill.style.width = `${progress}%`;
            }
            
            updateExpectedResponse() {
                if (this.currentStep >= this.conversationSequence.length) {
                    this.expectedResponse.innerHTML = `<strong>🎉 Cuộc hội thoại hoàn thành!</strong> Chúc mừng bạn đã hoàn thành bài luyện tập.`;
                    this.micBtn.disabled = true;
                    this.micBtn.textContent = '🎤 Hoàn thành';
                    return;
                }
                
                const currentSequence = this.conversationSequence[this.currentStep];
                
                if (this.isUserTurn()) {
                    // User's turn - show expected response
                    this.expectedResponse.innerHTML = `<strong>Đến lượt bạn nói:</strong> ${currentSequence.expectedResponse}`;
                    this.expectedResponse.style.display = 'block';
                    this.micBtn.disabled = false;
                    this.micBtn.textContent = '🎤 Nói';
                } else {
                    // AI's turn - show what AI will say
                    this.expectedResponse.innerHTML = `<strong>AI sẽ nói:</strong> ${currentSequence.text}`;
                    this.expectedResponse.style.display = 'block';
                    this.micBtn.disabled = true;
                    this.micBtn.textContent = '🎤 Chờ lượt AI';
                }
            }
            
            loadVoices() {
                this.voices = this.synthesis.getVoices();
                this.voiceSelect.innerHTML = '<option value="">Chọn giọng nói...</option>';
                
                // Filter German voices
                const germanVoices = this.voices.filter(voice => 
                    voice.lang.startsWith('de') || voice.name.toLowerCase().includes('german')
                );
                
                germanVoices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = this.voices.indexOf(voice);
                    option.textContent = `${voice.name} (${voice.lang})`;
                    this.voiceSelect.appendChild(option);
                });
                
                // Set default German voice
                if (germanVoices.length > 0) {
                    this.currentVoice = germanVoices[0];
                    this.voiceSelect.value = this.voices.indexOf(germanVoices[0]);
                }
            }
            
            selectVoice(voiceIndex) {
                if (voiceIndex !== '') {
                    this.currentVoice = this.voices[voiceIndex];
                }
            }
            
            updateSpeed(speed) {
                this.speed = parseFloat(speed);
                this.speedValue.textContent = speed + 'x';
            }
            
            toggleRecording() {
                if (!this.recognition) {
                    this.showStatus('Nhận diện giọng nói không khả dụng', 'error');
                    return;
                }
                
                if (this.micBtn.disabled) {
                    this.showStatus('Chưa đến lượt bạn nói', 'error');
                    return;
                }
                
                if (this.isRecording) {
                    this.recognition.stop();
                } else {
                    this.recognition.start();
                }
            }
            
            stopRecording() {
                this.isRecording = false;
                this.micBtn.classList.remove('recording');
                this.micBtn.textContent = '🎤 Nói';
                this.showStatus('');
            }
            
            restartConversation() {
                this.currentStep = 0;
                this.conversationHistory = [];
                this.waitingForAI = false;
                this.conversationArea.innerHTML = '';
                
                this.updateProgress();
                this.updateExpectedResponse();
                this.updateDebugInfo();
                this.showStatus('Cuộc hội thoại đã được khởi động lại', 'success');
                
                // If AI needs to speak first
                if (!this.isUserTurn()) {
                    setTimeout(() => {
                        this.playAIResponse();
                    }, 1000);
                }
            }
            
            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                let speaker = '';
                if (sender === 'user') {
                    speaker = this.userRole === 'teacher' ? this.teacherName : `${this.studentFirstName} ${this.studentLastName}`;
                } else if (sender === 'ai') {
                    speaker = this.userRole === 'teacher' ? `${this.studentFirstName} ${this.studentLastName}` : this.teacherName;
                }
                
                if (sender === 'error' || sender === 'success') {
                    messageDiv.innerHTML = `<div>${text}</div>`;
                } else {
                    messageDiv.innerHTML = `
                        <div class="speaker">${speaker}:</div>
                        <div>${text}</div>
                    `;
                }
                
                this.conversationArea.appendChild(messageDiv);
                this.conversationArea.scrollTop = this.conversationArea.scrollHeight;
                
                if (sender !== 'error' && sender !== 'success') {
                    this.conversationHistory.push({
                        speaker: speaker,
                        text: text,
                        timestamp: Date.now()
                    });
                }
            }
            
            speakText(text) {
                if (!this.synthesis) return;
                
                this.synthesis.cancel(); // Stop any ongoing speech
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'de-DE';
                utterance.rate = this.speed;
                
                if (this.currentVoice) {
                    utterance.voice = this.currentVoice;
                }
                
                utterance.onstart = () => {
                    this.showStatus('Đang phát âm...', 'speaking');
                };
                
                utterance.onend = () => {
                    this.showStatus('');
                };
                
                utterance.onerror = (event) => {
                    this.showStatus('Lỗi phát âm: ' + event.error, 'error');
                };
                
                this.synthesis.speak(utterance);
            }
            
            repeatLastMessage() {
                if (this.conversationHistory.length === 0) {
                    this.showStatus('Chưa có tin nhắn nào để phát lại', 'error');
                    return;
                }
                
                const lastMessage = this.conversationHistory[this.conversationHistory.length - 1];
                this.speakText(lastMessage.text);
            }
            
            clearConversation() {
                this.conversationArea.innerHTML = '';
                this.conversationHistory = [];
                this.currentStep = 0;
                this.waitingForAI = false;
                this.updateProgress();
                this.updateExpectedResponse();
                this.updateDebugInfo();
                this.showStatus('Cuộc hội thoại đã được xóa', 'success');
            }
            
            showStatus(message, type = '') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
                
                if (message && type !== 'error' && type !== 'success') {
                    setTimeout(() => {
                        this.status.textContent = '';
                        this.status.className = 'status';
                    }, 3000);
                }
                
                if (type === 'success' || type === 'error') {
                    setTimeout(() => {
                        this.status.textContent = '';
                        this.status.className = 'status';
                    }, 5000);
                }
            }
        }
        
        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new GermanConversationAI();
        });
    </script>
</body>
</html>