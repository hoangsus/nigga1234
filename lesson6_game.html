<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>German Conversation AI - LinguaTreff (Strict Mode)</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        width: 100%;
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #ff6b6b, #ffa726);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .main-content {
        padding: 30px;
      }

      .name-settings {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        border: 2px solid #e9ecef;
      }

      .name-settings h3 {
        margin-bottom: 15px;
        color: #333;
        text-align: center;
      }

      .name-inputs {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .name-input-group {
        flex: 1;
        min-width: 200px;
      }

      .name-input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }

      .name-input {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 1em;
        transition: border-color 0.3s ease;
      }

      .name-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .save-btn {
        background: linear-gradient(135deg, #00b894, #00cec9);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 20px;
        font-size: 1em;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        display: block;
        margin: 0 auto;
      }

      .save-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 206, 201, 0.3);
      }

      .role-selector {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        justify-content: center;
      }

      .role-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }

      .role-option:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .role-option input[type="radio"] {
        accent-color: #667eea;
      }

      .role-option input[type="radio"]:checked + span {
        color: #667eea;
        font-weight: bold;
      }

      .conversation-container {
        margin-top: 20px;
      }

      .current-roles {
        background: #e8f4f8;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 2px solid #b8daff;
      }

      .role-display {
        margin-bottom: 8px;
      }

      .role-display:last-child {
        margin-bottom: 0;
      }

      .conversation-area {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        min-height: 300px;
        max-height: 400px;
        overflow-y: auto;
        border: 2px solid #e9ecef;
      }

      .message {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 10px;
        max-width: 80%;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease;
      }

      .message.user {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        margin-left: auto;
        text-align: right;
      }

      .message.ai {
        background: linear-gradient(135deg, #ffeaa7, #fab1a0);
        color: #2d3436;
      }

      .message.error {
        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        color: white;
        margin: 0 auto;
        text-align: center;
        max-width: 90%;
      }

      .message.success {
        background: linear-gradient(135deg, #00b894, #00cec9);
        color: white;
        margin: 0 auto;
        text-align: center;
        max-width: 90%;
      }

      .message .speaker {
        font-weight: bold;
        font-size: 0.9em;
        margin-bottom: 5px;
        opacity: 0.8;
      }

      .progress-bar {
        background: #e9ecef;
        border-radius: 10px;
        height: 20px;
        margin-bottom: 20px;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(135deg, #00b894, #00cec9);
        height: 100%;
        transition: width 0.3s ease;
        border-radius: 10px;
      }

      .progress-text {
        text-align: center;
        margin-bottom: 10px;
        font-weight: bold;
        color: #555;
      }

      .expected-response {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        font-style: italic;
        color: #155724;
      }

      .expected-response strong {
        color: #0c5460;
      }

      .strict-mode-notice {
        background: #fff3cd;
        border: 2px solid #ffeaa7;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
        color: #856404;
      }

      .controls {
        display: flex;
        gap: 15px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
      }

      .control-btn {
        padding: 15px 25px;
        border: none;
        border-radius: 25px;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .mic-btn {
        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        color: white;
      }

      .mic-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(238, 90, 111, 0.3);
      }

      .mic-btn.recording {
        background: linear-gradient(135deg, #fd79a8, #e84393);
        animation: pulse 1s infinite;
      }

      .mic-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .speak-btn {
        background: linear-gradient(135deg, #00b894, #00cec9);
        color: white;
      }

      .speak-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 206, 201, 0.3);
      }

      .restart-btn {
        background: linear-gradient(135deg, #fdcb6e, #e17055);
        color: white;
      }

      .restart-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(225, 112, 85, 0.3);
      }

      .clear-btn {
        background: linear-gradient(135deg, #636e72, #2d3436);
        color: white;
      }

      .clear-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(99, 110, 114, 0.3);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .status {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        border-radius: 10px;
        font-weight: bold;
      }

      .status.listening {
        background: #dff0d8;
        color: #3c763d;
      }

      .status.speaking {
        background: #d9edf7;
        color: #31708f;
      }

      .status.error {
        background: #f2dede;
        color: #a94442;
      }

      .mic-tips {
        background: #e8f5e8;
        border: 2px solid #4caf50;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 15px;
        font-size: 0.9em;
        color: #2e7d32;
      }

      .voice-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 15px;
        justify-content: center;
        flex-direction: column;
      }

      .voice-select {
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 20px;
        font-size: 1em;
        background: white;
        cursor: pointer;
      }

      .speed-control {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .speed-slider {
        width: 100px;
      }

      .debug-info {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
        font-size: 0.9em;
        color: #666;
      }

      .debug-info h4 {
        margin-bottom: 10px;
        color: #333;
      }

      @media (max-width: 768px) {
        .name-inputs {
          flex-direction: column;
        }

        .role-selector {
          flex-direction: column;
          align-items: center;
        }

        .controls {
          flex-direction: column;
        }

        .voice-controls {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üéØ LinguaTreff AI</h1>
        <p>Luy·ªán t·∫≠p h·ªôi tho·∫°i ti·∫øng ƒê·ª©c v·ªõi AI - Ch·∫ø ƒë·ªô nghi√™m ng·∫∑t</p>
      </div>

      <div class="main-content">
        <div class="name-settings" id="nameSettings">
          <h3>‚öôÔ∏è C√†i ƒë·∫∑t th√¥ng tin nh√¢n v·∫≠t</h3>
          <div class="name-inputs">
            <div class="name-input-group">
              <label for="teacherName">T√™n gi√°o vi√™n:</label>
              <input
                type="text"
                id="teacherName"
                class="name-input"
                value="Frau Schwarz"
                placeholder="Nh·∫≠p t√™n gi√°o vi√™n"
              />
            </div>
            <div class="name-input-group">
              <label for="studentFirstName">T√™n (Vorname) h·ªçc vi√™n:</label>
              <input
                type="text"
                id="studentFirstName"
                class="name-input"
                value="Marie"
                placeholder="Nh·∫≠p t√™n h·ªçc vi√™n"
              />
            </div>
            <div class="name-input-group">
              <label for="studentLastName">H·ªç (Familienname) h·ªçc vi√™n:</label>
              <input
                type="text"
                id="studentLastName"
                class="name-input"
                value="Platini"
                placeholder="Nh·∫≠p h·ªç h·ªçc vi√™n"
              />
            </div>
            <div class="name-input-group">
              <label for="studentCity">Th√†nh ph·ªë h·ªçc vi√™n:</label>
              <input
                type="text"
                id="studentCity"
                class="name-input"
                value="Fribourg"
                placeholder="Nh·∫≠p th√†nh ph·ªë"
              />
            </div>
            <div class="name-input-group">
              <label for="studentCountry">ƒê·∫•t n∆∞·ªõc:</label>
              <input
                type="text"
                id="studentCountry"
                class="name-input"
                value="Schweiz"
                placeholder="Nh·∫≠p ƒë·∫•t n∆∞·ªõc (ti·∫øng ƒê·ª©c)"
              />
            </div>
            <div class="name-input-group">
              <label for="studentAddress">ƒê·ªãa ch·ªâ h·ªçc vi√™n:</label>
              <input
                type="text"
                id="studentAddress"
                class="name-input"
                value="Hauptstra√üe 15"
                placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ"
              />
            </div>
            <div class="name-input-group">
              <label for="courseLevel">C·∫•p ƒë·ªô kh√≥a h·ªçc:</label>
              <input
                type="text"
                id="courseLevel"
                class="name-input"
                value="A 1.1"
                placeholder="Nh·∫≠p c·∫•p ƒë·ªô kh√≥a h·ªçc"
              />
            </div>
            <div class="name-input-group">
              <label for="schoolName">T√™n tr∆∞·ªùng:</label>
              <input
                type="text"
                id="schoolName"
                class="name-input"
                value="LinguaTreff"
                placeholder="Nh·∫≠p t√™n tr∆∞·ªùng"
              />
            </div>
          </div>

          <div class="role-selector">
            <h4>Ch·ªçn vai c·ªßa b·∫°n:</h4>
            <div
              style="
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-top: 10px;
              "
            >
              <label class="role-option">
                <input
                  type="radio"
                  name="userRole"
                  value="teacher"
                  id="roleTeacher"
                />
                <span>üë©‚Äçüè´ T√¥i ƒë√≥ng vai gi√°o vi√™n</span>
              </label>
              <label class="role-option">
                <input
                  type="radio"
                  name="userRole"
                  value="student"
                  id="roleStudent"
                  checked
                />
                <span>üë©‚Äçüéì T√¥i ƒë√≥ng vai h·ªçc vi√™n</span>
              </label>
            </div>
          </div>

          <button class="save-btn" id="saveNames">
            üíæ L∆∞u th√¥ng tin & B·∫Øt ƒë·∫ßu
          </button>
        </div>

        <div
          class="conversation-container"
          id="conversationContainer"
          style="display: none"
        >
          <div class="strict-mode-notice">
            ‚ö†Ô∏è CH·∫æ ƒê·ªò NGHI√äM NG·∫∂T: Ph·∫£i n√≥i ch√≠nh x√°c 100% - Sai 1 t·ª´ l√† ph·∫£i
            n√≥i l·∫°i!
          </div>

          <div class="progress-text">Ti·∫øn ƒë·ªô h·ªôi tho·∫°i</div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="progressFill"
              style="width: 0%"
            ></div>
          </div>

          <div class="current-roles" id="currentRoles">
            <div class="role-display">
              <strong>üë§ B·∫°n ƒë√≥ng vai:</strong>
              <span id="userRoleDisplay">Ch∆∞a ch·ªçn</span>
            </div>
            <div class="role-display">
              <strong>ü§ñ AI ƒë√≥ng vai:</strong>
              <span id="aiRoleDisplay">Ch∆∞a ch·ªçn</span>
            </div>
          </div>

          <div class="expected-response" id="expectedResponse">
            <strong>Chu·∫©n b·ªã b·∫Øt ƒë·∫ßu cu·ªôc h·ªôi tho·∫°i...</strong>
          </div>

          <div class="conversation-area" id="conversationArea"></div>

          <div class="controls">
            <button class="control-btn mic-btn" id="micBtn">üé§ N√≥i</button>
            <button class="control-btn speak-btn" id="speakBtn">
              üîä Ph√°t l·∫°i
            </button>
            <button class="control-btn restart-btn" id="restartBtn">
              üîÑ B·∫Øt ƒë·∫ßu l·∫°i
            </button>
            <button class="control-btn clear-btn" id="clearBtn">
              üóëÔ∏è X√≥a h·∫øt
            </button>
            <button class="control-btn clear-btn" id="newConversationBtn">
              ‚öôÔ∏è C√†i ƒë·∫∑t m·ªõi
            </button>
          </div>

          <div class="voice-controls">
            <div class="mic-tips">
              <strong>üí° M·∫πo ghi √¢m t·ªët:</strong><br />
              ‚Ä¢ N√≥i ch·∫≠m v√† r√µ r√†ng<br />
              ‚Ä¢ Gi·ªØ kho·∫£ng c√°ch 15-20cm v·ªõi mic<br />
              ‚Ä¢ T·∫Øt ti·∫øng ·ªìn xung quanh<br />
              ‚Ä¢ S·ª≠ d·ª•ng headset n·∫øu c√≥ th·ªÉ
            </div>
            <select class="voice-select" id="voiceSelect">
              <option value="">Ch·ªçn gi·ªçng n√≥i...</option>
            </select>
            <div class="speed-control">
              <label>T·ªëc ƒë·ªô:</label>
              <input
                type="range"
                class="speed-slider"
                id="speedSlider"
                min="0.5"
                max="2"
                step="0.1"
                value="0.8"
              />
              <span id="speedValue">0.8x</span>
            </div>
          </div>

          <div class="debug-info" id="debugInfo" style="display: none">
            <h4>Debug Info:</h4>
            <div id="debugContent"></div>
          </div>

          <div class="status" id="status"></div>
        </div>
      </div>
    </div>

    <script>
      class StrictGermanConversationAI {
        constructor() {
          this.recognition = null;
          this.synthesis = window.speechSynthesis;
          this.voices = [];
          this.currentVoice = null;
          this.isRecording = false;
          this.conversationHistory = [];
          this.speed = 0.8; // T·ªëc ƒë·ªô m·∫∑c ƒë·ªãnh ch·∫≠m h∆°n cho ti·∫øng ƒê·ª©c
          this.currentStep = 0;
          this.teacherName = "Frau Schwarz";
          this.studentFirstName = "Marie";
          this.studentLastName = "Platini";
          this.studentCity = "Fribourg";
          this.studentCountry = "Schweiz";
          this.studentAddress = "Hauptstra√üe 15";
          this.courseLevel = "A 1.1";
          this.schoolName = "LinguaTreff";
          this.userRole = "student";
          this.conversationStarted = false;
          this.waitingForAI = false;
          this.debugMode = false;
          this.strictMode = true; // Ch·∫ø ƒë·ªô nghi√™m ng·∫∑t

          // Conversation sequence based on the provided dialogue
          this.conversationSequence = [
            {
              speaker: "teacher",
              text: "Sprachschule LinguaTreff. Sie sprechen mit Frau Schwarz. Guten Tag.",
              expectedResponse: "Guten Tag, ich m√∂chte mich anmelden.",
            },
            {
              speaker: "student",
              text: "Guten Tag, ich m√∂chte mich anmelden.",
              expectedResponse: "Gern. F√ºr welchen Kurs denn, bitte?",
            },
            {
              speaker: "teacher",
              text: "Gern. F√ºr welchen Kurs denn, bitte?",
              expectedResponse: "Anf√§nger, also A 1.1.",
            },
            {
              speaker: "student",
              text: "Anf√§nger, also A 1.1.",
              expectedResponse: "Gut, ja. Wie hei√üen Sie, bitte?",
            },
            {
              speaker: "teacher",
              text: "Gut, ja. Wie hei√üen Sie, bitte?",
              expectedResponse: "Platini.",
            },
            {
              speaker: "student",
              text: "Platini.",
              expectedResponse: "Wiederholen Sie das bitte.",
            },
            {
              speaker: "teacher",
              text: "Wiederholen Sie das bitte.",
              expectedResponse: "Ich hei√üe Platini.",
            },
            {
              speaker: "student",
              text: "Ich hei√üe Platini.",
              expectedResponse: 'Mit ‚Äûe" am Ende?',
            },
            {
              speaker: "teacher",
              text: 'Mit ‚Äûe" am Ende?',
              expectedResponse: 'Nein, nur mit ‚Äûi".',
            },
            {
              speaker: "student",
              text: 'Nein, nur mit ‚Äûi".',
              expectedResponse: "Okay. Ich buchstabiere: P-L-A-T-I-N-I.",
            },
            {
              speaker: "teacher",
              text: "Okay. Ich buchstabiere: P-L-A-T-I-N-I.",
              expectedResponse: "Richtig.",
            },
            {
              speaker: "student",
              text: "Richtig.",
              expectedResponse: "Und Ihr Vorname, bitte?",
            },
            {
              speaker: "teacher",
              text: "Und Ihr Vorname, bitte?",
              expectedResponse: "Marie.",
            },
            {
              speaker: "student",
              text: "Marie.",
              expectedResponse: "Maria?",
            },
            {
              speaker: "teacher",
              text: "Maria?",
              expectedResponse:
                '√Ñh, nein. Marie. Mit ‚Äûe" am Ende. ... M-A-R-I-E.',
            },
            {
              speaker: "student",
              text: '√Ñh, nein. Marie. Mit ‚Äûe" am Ende. ... M-A-R-I-E.',
              expectedResponse: "Also Marie Platini.",
            },
            {
              speaker: "teacher",
              text: "Also Marie Platini.",
              expectedResponse: "Richtig.",
            },
            {
              speaker: "student",
              text: "Richtig.",
              expectedResponse: "Und woher kommen Sie Frau Platini?",
            },
            {
              speaker: "teacher",
              text: "Und woher kommen Sie Frau Platini?",
              expectedResponse: "Ich bin aus Fribourg.",
            },
            {
              speaker: "student",
              text: "Ich bin aus Fribourg.",
              expectedResponse: "Aus Freiburg?",
            },
            {
              speaker: "teacher",
              text: "Aus Freiburg?",
              expectedResponse:
                "Ja, Freiburg in der Schweiz. Das hei√üt Fribourg. Ich buchstabiere: F-R-I-B-O-U-R-G.",
            },
            {
              speaker: "student",
              text: "Ja, Freiburg in der Schweiz. Das hei√üt Fribourg. Ich buchstabiere: F-R-I-B-O-U-R-G.",
              expectedResponse:
                "Aha. Danke. Das hab ich. Nun noch die Adresse.",
            },
            {
              speaker: "teacher",
              text: "Aha. Danke. Das hab ich. Nun noch die Adresse.",
              expectedResponse:
                "Die ist einfach. Also, ich wohne in der Hauptstra√üe 15.",
            },
            {
              speaker: "student",
              text: "Die ist einfach. Also, ich wohne in der Hauptstra√üe 15.",
              expectedResponse: "Hauptstra√üe 15. Gut, danke. Das war's.",
            },
            {
              speaker: "teacher",
              text: "Hauptstra√üe 15. Gut, danke. Das war's.",
              expectedResponse: "Conversation completed!",
            },
          ];

          this.initializeElements();
          this.setupEventListeners();
          this.initializeSpeechRecognition();
          this.loadVoices();
          this.updateProgress();
          this.updateExpectedResponse();

          // Enable debug mode with Ctrl+D
          document.addEventListener("keydown", (e) => {
            if (e.ctrlKey && e.key === "d") {
              e.preventDefault();
              this.toggleDebug();
            }
          });
        }

        initializeElements() {
          this.conversationArea = document.getElementById("conversationArea");
          this.micBtn = document.getElementById("micBtn");
          this.speakBtn = document.getElementById("speakBtn");
          this.restartBtn = document.getElementById("restartBtn");
          this.clearBtn = document.getElementById("clearBtn");
          this.status = document.getElementById("status");
          this.voiceSelect = document.getElementById("voiceSelect");
          this.speedSlider = document.getElementById("speedSlider");
          this.speedValue = document.getElementById("speedValue");
          this.progressFill = document.getElementById("progressFill");
          this.expectedResponse = document.getElementById("expectedResponse");
          this.teacherNameInput = document.getElementById("teacherName");
          this.studentFirstNameInput =
            document.getElementById("studentFirstName");
          this.studentLastNameInput =
            document.getElementById("studentLastName");
          this.studentCityInput = document.getElementById("studentCity");
          this.studentCountryInput = document.getElementById("studentCountry");
          this.studentAddressInput = document.getElementById("studentAddress");
          this.courseLevelInput = document.getElementById("courseLevel");
          this.schoolNameInput = document.getElementById("schoolName");
          this.saveNamesBtn = document.getElementById("saveNames");
          this.roleTeacherInput = document.getElementById("roleTeacher");
          this.roleStudentInput = document.getElementById("roleStudent");
          this.nameSettings = document.getElementById("nameSettings");
          this.conversationContainer = document.getElementById(
            "conversationContainer"
          );
          this.userRoleDisplay = document.getElementById("userRoleDisplay");
          this.aiRoleDisplay = document.getElementById("aiRoleDisplay");
          this.newConversationBtn =
            document.getElementById("newConversationBtn");
          this.debugInfo = document.getElementById("debugInfo");
          this.debugContent = document.getElementById("debugContent");
        }

        setupEventListeners() {
          this.micBtn.addEventListener("click", () => this.toggleRecording());
          this.speakBtn.addEventListener("click", () =>
            this.repeatLastMessage()
          );
          this.restartBtn.addEventListener("click", () =>
            this.restartConversation()
          );
          this.clearBtn.addEventListener("click", () =>
            this.clearConversation()
          );
          this.newConversationBtn.addEventListener("click", () =>
            this.startNewConversation()
          );
          this.saveNamesBtn.addEventListener("click", () =>
            this.saveNamesAndStart()
          );

          this.voiceSelect.addEventListener("change", (e) =>
            this.selectVoice(e.target.value)
          );
          this.speedSlider.addEventListener("input", (e) =>
            this.updateSpeed(e.target.value)
          );

          this.synthesis.addEventListener("voiceschanged", () =>
            this.loadVoices()
          );
        }

        toggleDebug() {
          this.debugMode = !this.debugMode;
          this.debugInfo.style.display = this.debugMode ? "block" : "none";
          this.updateDebugInfo();
        }

        updateDebugInfo() {
          if (!this.debugMode) return;

          const currentSequence = this.conversationSequence[this.currentStep];
          const debugData = {
            "Current Step": this.currentStep,
            "Total Steps": this.conversationSequence.length,
            "User Role": this.userRole,
            "Conversation Started": this.conversationStarted,
            "Waiting for AI": this.waitingForAI,
            "Current Speaker": currentSequence
              ? currentSequence.speaker
              : "None",
            "Is User Turn": this.isUserTurn(),
            "Expected Response": currentSequence
              ? currentSequence.expectedResponse
              : "None",
            "Strict Mode": this.strictMode,
          };

          this.debugContent.innerHTML = Object.entries(debugData)
            .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
            .join("<br>");
        }

        saveNamesAndStart() {
          const newTeacherName = this.teacherNameInput.value.trim();
          const newStudentFirstName = this.studentFirstNameInput.value.trim();
          const newStudentLastName = this.studentLastNameInput.value.trim();
          const newStudentCity = this.studentCityInput.value.trim();
          const newStudentCountry = this.studentCountryInput.value.trim();
          const newStudentAddress = this.studentAddressInput.value.trim();
          const newCourseLevel = this.courseLevelInput.value.trim();
          const newSchoolName = this.schoolNameInput.value.trim();
          const selectedRole = this.roleTeacherInput.checked
            ? "teacher"
            : "student";

          if (
            newTeacherName &&
            newStudentFirstName &&
            newStudentLastName &&
            newStudentCity &&
            newStudentCountry &&
            newStudentAddress &&
            newCourseLevel &&
            newSchoolName
          ) {
            this.teacherName = newTeacherName;
            this.studentFirstName = newStudentFirstName;
            this.studentLastName = newStudentLastName;
            this.studentCity = newStudentCity;
            this.studentCountry = newStudentCountry;
            this.studentAddress = newStudentAddress;
            this.courseLevel = newCourseLevel;
            this.schoolName = newSchoolName;
            this.userRole = selectedRole;

            this.updateConversationSequence();
            this.startConversation();

            this.showStatus(
              "Cu·ªôc h·ªôi tho·∫°i b·∫Øt ƒë·∫ßu! (Ch·∫ø ƒë·ªô nghi√™m ng·∫∑t)",
              "success"
            );
          } else {
            this.showStatus("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ th√¥ng tin!", "error");
          }
        }

        startConversation() {
          this.conversationStarted = true;
          this.currentStep = 0;
          this.conversationHistory = [];
          this.waitingForAI = false;

          this.nameSettings.style.display = "none";
          this.conversationContainer.style.display = "block";

          if (this.userRole === "teacher") {
            this.userRoleDisplay.textContent = this.teacherName;
            this.aiRoleDisplay.textContent = `${this.studentFirstName} ${this.studentLastName}`;
          } else {
            this.userRoleDisplay.textContent = `${this.studentFirstName} ${this.studentLastName}`;
            this.aiRoleDisplay.textContent = this.teacherName;
          }

          this.conversationArea.innerHTML = "";
          this.updateProgress();
          this.updateExpectedResponse();
          this.updateDebugInfo();

          if (!this.isUserTurn()) {
            setTimeout(() => {
              this.playAIResponse();
            }, 1000);
          }
        }

        startNewConversation() {
          this.conversationStarted = false;
          this.currentStep = 0;
          this.conversationHistory = [];
          this.waitingForAI = false;

          this.nameSettings.style.display = "block";
          this.conversationContainer.style.display = "none";

          this.conversationArea.innerHTML = "";
          this.updateProgress();
          this.updateDebugInfo();

          this.showStatus("C√≥ th·ªÉ c√†i ƒë·∫∑t th√¥ng tin m·ªõi", "success");
        }

        updateConversationSequence() {
          // Update the first message with school name and teacher name
          this.conversationSequence[0].text = `Sprachschule ${this.schoolName}. Sie sprechen mit ${this.teacherName}. Guten Tag.`;

          // Update course level
          this.conversationSequence[2].expectedResponse = `Anf√§nger, also ${this.courseLevel}.`;
          this.conversationSequence[3].text = `Anf√§nger, also ${this.courseLevel}.`;

          // Update student last name
          this.conversationSequence[4].expectedResponse = `${this.studentLastName}.`;
          this.conversationSequence[5].text = `${this.studentLastName}.`;

          // Update spelling of last name
          const lastNameSpelling = this.studentLastName.split("").join("-");
          this.conversationSequence[9].expectedResponse = `Okay. Ich buchstabiere: ${lastNameSpelling}.`;
          this.conversationSequence[10].text = `Okay. Ich buchstabiere: ${lastNameSpelling}.`;

          // Update first name
          this.conversationSequence[12].expectedResponse = `${this.studentFirstName}.`;
          this.conversationSequence[13].text = `${this.studentFirstName}.`;

          // Update first name spelling
          const firstNameSpelling = this.studentFirstName.split("").join("-");
          this.conversationSequence[14].expectedResponse = `√Ñh, nein. ${
            this.studentFirstName
          }. Mit ‚Äû${this.studentFirstName.slice(
            -1
          )}" am Ende. ... ${firstNameSpelling}.`;
          this.conversationSequence[15].text = `√Ñh, nein. ${
            this.studentFirstName
          }. Mit ‚Äû${this.studentFirstName.slice(
            -1
          )}" am Ende. ... ${firstNameSpelling}.`;

          // Update full name confirmation
          this.conversationSequence[16].text = `Also ${this.studentFirstName} ${this.studentLastName}.`;
          this.conversationSequence[17].expectedResponse = `Und woher kommen Sie Frau ${this.studentLastName}?`;
          this.conversationSequence[18].text = `Und woher kommen Sie Frau ${this.studentLastName}?`;

          // Update city
          this.conversationSequence[18].expectedResponse = `Ich bin aus ${this.studentCity}.`;
          this.conversationSequence[19].text = `Ich bin aus ${this.studentCity}.`;

          // Update city clarification
          const cityGermanName =
            this.studentCity === "Fribourg" ? "Freiburg" : this.studentCity;
          this.conversationSequence[20].text = `Aus ${cityGermanName}?`;

          // Update city and country explanation
          const citySpelling = this.studentCity.split("").join("-");
          this.conversationSequence[20].expectedResponse = `Ja, ${cityGermanName} in der ${this.studentCountry}. Das hei√üt ${this.studentCity}. Ich buchstabiere: ${citySpelling}.`;
          this.conversationSequence[21].text = `Ja, ${cityGermanName} in der ${this.studentCountry}. Das hei√üt ${this.studentCity}. Ich buchstabiere: ${citySpelling}.`;

          // Update address
          this.conversationSequence[22].expectedResponse = `Die ist einfach. Also, ich wohne in der ${this.studentAddress}.`;
          this.conversationSequence[23].text = `Die ist einfach. Also, ich wohne in der ${this.studentAddress}.`;
          this.conversationSequence[24].text = `${this.studentAddress}. Gut, danke. Das war's.`;
        }

        isUserTurn() {
          if (this.currentStep >= this.conversationSequence.length) {
            return false;
          }

          const currentSequence = this.conversationSequence[this.currentStep];

          if (this.userRole === "student") {
            return currentSequence.speaker === "student";
          } else {
            return currentSequence.speaker === "teacher";
          }
        }

        playAIResponse() {
          if (this.currentStep >= this.conversationSequence.length) {
            return;
          }

          const currentSequence = this.conversationSequence[this.currentStep];

          if (!this.isUserTurn()) {
            this.waitingForAI = true;
            this.addMessage(currentSequence.text, "ai");

            setTimeout(() => {
              this.speakText(currentSequence.text);
            }, 500);

            setTimeout(() => {
              this.currentStep++;
              this.waitingForAI = false;
              this.updateProgress();
              this.updateExpectedResponse();
              this.updateDebugInfo();

              if (
                this.currentStep < this.conversationSequence.length &&
                !this.isUserTurn()
              ) {
                this.playAIResponse();
              }
            }, 2000);
          }
        }

        initializeSpeechRecognition() {
          if ("webkitSpeechRecognition" in window) {
            this.recognition = new webkitSpeechRecognition();
          } else if ("SpeechRecognition" in window) {
            this.recognition = new SpeechRecognition();
          } else {
            this.showStatus(
              "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i",
              "error"
            );
            return;
          }

          // C·∫•u h√¨nh t·ªëi ∆∞u cho ti·∫øng ƒê·ª©c
          this.recognition.continuous = true; // Nghe li√™n t·ª•c
          this.recognition.interimResults = true; // Hi·ªÉn th·ªã k·∫øt qu·∫£ t·∫°m th·ªùi
          this.recognition.lang = "de-DE"; // Ti·∫øng ƒê·ª©c
          this.recognition.maxAlternatives = 5; // L·∫•y nhi·ªÅu phi√™n b·∫£n

          // Th√™m c√°c c√†i ƒë·∫∑t n√¢ng cao
          if (this.recognition.serviceURI) {
            this.recognition.serviceURI =
              "wss://www.google.com/speech-api/v2/recognize";
          }

          this.recognition.onstart = () => {
            this.showStatus("üé§ ƒêang nghe... (N√≥i r√µ r√†ng)", "listening");
            this.isRecording = true;
            this.micBtn.classList.add("recording");
            this.micBtn.textContent = "üõë D·ª´ng";
            this.recordingTimeout = null;
          };

          this.recognition.onresult = (event) => {
            let finalTranscript = "";
            let interimTranscript = "";

            // L·∫•y t·∫•t c·∫£ alternatives
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const result = event.results[i];

              if (result.isFinal) {
                // L·∫•y alternative t·ªët nh·∫•t
                let bestTranscript = result[0].transcript;
                let bestConfidence = result[0].confidence || 0;

                // Ki·ªÉm tra c√°c alternatives kh√°c
                for (let j = 1; j < result.length; j++) {
                  const alt = result[j];
                  if (alt.confidence > bestConfidence) {
                    bestTranscript = alt.transcript;
                    bestConfidence = alt.confidence;
                  }
                }

                finalTranscript += bestTranscript;

                // Hi·ªÉn th·ªã confidence
                this.showStatus(
                  `‚úÖ Nh·∫≠n ƒë∆∞·ª£c: "${bestTranscript}" (${Math.round(
                    bestConfidence * 100
                  )}%)`,
                  "success"
                );
              } else {
                interimTranscript += result[0].transcript;
              }
            }

            // Hi·ªÉn th·ªã k·∫øt qu·∫£ t·∫°m th·ªùi
            if (interimTranscript) {
              this.showStatus(
                `üé§ ƒêang nghe: "${interimTranscript}"`,
                "listening"
              );
            }

            // X·ª≠ l√Ω k·∫øt qu·∫£ cu·ªëi c√πng
            if (finalTranscript) {
              this.processUserInput(finalTranscript.trim());
            }
          };

          this.recognition.onerror = (event) => {
            let errorMessage = "L·ªói nh·∫≠n di·ªán: ";

            switch (event.error) {
              case "no-speech":
                errorMessage += "Kh√¥ng nghe th·∫•y gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.";
                break;
              case "audio-capture":
                errorMessage +=
                  "Kh√¥ng th·ªÉ truy c·∫≠p microphone. Ki·ªÉm tra quy·ªÅn truy c·∫≠p.";
                break;
              case "not-allowed":
                errorMessage += "Quy·ªÅn truy c·∫≠p microphone b·ªã t·ª´ ch·ªëi.";
                break;
              case "network":
                errorMessage += "L·ªói k·∫øt n·ªëi m·∫°ng. Ki·ªÉm tra internet.";
                break;
              case "service-not-allowed":
                errorMessage += "D·ªãch v·ª• nh·∫≠n di·ªán gi·ªçng n√≥i kh√¥ng kh·∫£ d·ª•ng.";
                break;
              case "bad-grammar":
                errorMessage += "L·ªói ng·ªØ ph√°p trong c·∫•u h√¨nh.";
                break;
              case "language-not-supported":
                errorMessage += "Kh√¥ng h·ªó tr·ª£ ti·∫øng ƒê·ª©c.";
                break;
              default:
                errorMessage += event.error;
            }

            this.showStatus(errorMessage, "error");
            this.stopRecording();
          };

          this.recognition.onend = () => {
            if (this.isRecording) {
              // T·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i n·∫øu v·∫´n ƒëang trong ch·∫ø ƒë·ªô ghi √¢m
              setTimeout(() => {
                if (this.isRecording) {
                  try {
                    this.recognition.start();
                  } catch (e) {
                    this.stopRecording();
                  }
                }
              }, 100);
            }
          };

          // Th√™m timeout t·ª± ƒë·ªông d·ª´ng
          this.recognition.onspeechend = () => {
            if (this.recordingTimeout) {
              clearTimeout(this.recordingTimeout);
            }
            this.recordingTimeout = setTimeout(() => {
              if (this.isRecording) {
                this.recognition.stop();
              }
            }, 2000); // D·ª´ng sau 2 gi√¢y kh√¥ng c√≥ ti·∫øng n√≥i
          };
        }

        processUserInput(transcript) {
          // Lo·∫°i b·ªè kho·∫£ng tr·∫Øng v√† k√Ω t·ª± ƒë·∫∑c bi·ªát
          const cleanTranscript = transcript.trim();

          if (!cleanTranscript) {
            this.showStatus(
              "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c √¢m thanh r√µ r√†ng. Vui l√≤ng th·ª≠ l·∫°i.",
              "error"
            );
            return;
          }

          this.addMessage(cleanTranscript, "user");

          if (this.currentStep >= this.conversationSequence.length) {
            this.addMessage("Cu·ªôc h·ªôi tho·∫°i ƒë√£ ho√†n th√†nh! üéâ", "success");
            this.showStatus("Cu·ªôc h·ªôi tho·∫°i ƒë√£ ho√†n th√†nh!", "success");
            this.stopRecording();
            return;
          }

          if (!this.isUserTurn()) {
            this.addMessage("‚ùå Ch∆∞a ƒë·∫øn l∆∞·ª£t b·∫°n n√≥i!", "error");
            return;
          }

          const currentSequence = this.conversationSequence[this.currentStep];
          const expectedText = currentSequence.text;

          // T·∫°m d·ª´ng ghi √¢m khi x·ª≠ l√Ω
          this.stopRecording();

          // STRICT MODE: Ki·ªÉm tra ch√≠nh x√°c v·ªõi nhi·ªÅu ph∆∞∆°ng ph√°p
          const matchResult = this.isStrictMatch(cleanTranscript, expectedText);

          if (matchResult.isMatch) {
            this.addMessage(
              `‚úÖ Ch√≠nh x√°c! ${
                matchResult.confidence
                  ? `(${matchResult.confidence}% ƒë·ªô ch√≠nh x√°c)`
                  : ""
              }`,
              "success"
            );
            this.currentStep++;
            this.updateProgress();
            this.updateExpectedResponse();
            this.updateDebugInfo();

            if (this.currentStep >= this.conversationSequence.length) {
              this.addMessage(
                "üéâ Cu·ªôc h·ªôi tho·∫°i ƒë√£ ho√†n th√†nh! Ch√∫c m·ª´ng b·∫°n!",
                "success"
              );
              this.showStatus("Cu·ªôc h·ªôi tho·∫°i ƒë√£ ho√†n th√†nh!", "success");
              return;
            }

            if (!this.isUserTurn()) {
              setTimeout(() => {
                this.playAIResponse();
              }, 1500);
            }
          } else {
            // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói chi ti·∫øt
            const errorMessage =
              `‚ùå Kh√¥ng ch√≠nh x√°c! ${
                matchResult.confidence
                  ? `(${matchResult.confidence}% ƒë·ªô ch√≠nh x√°c)`
                  : ""
              }<br><br>` +
              `<strong>C·∫ßn n√≥i:</strong> "${expectedText}"<br>` +
              `<strong>B·∫°n n√≥i:</strong> "${cleanTranscript}"<br><br>` +
              `<em>üí° M·∫πo: N√≥i ch·∫≠m, r√µ r√†ng v√† ch√≠nh x√°c t·ª´ng t·ª´!</em>`;

            this.addMessage(errorMessage, "error");

            // Ph√°t l·∫°i c√¢u c·∫ßn n√≥i
            setTimeout(() => {
              this.speakText(expectedText);
            }, 1000);
          }
        }

        // STRICT MODE: Ki·ªÉm tra ch√≠nh x√°c v·ªõi nhi·ªÅu ph∆∞∆°ng ph√°p
        isStrictMatch(input, expected) {
          const normalizedInput = this.normalizeForStrictComparison(input);
          const normalizedExpected =
            this.normalizeForStrictComparison(expected);

          // 1. Ki·ªÉm tra exact match
          if (normalizedInput === normalizedExpected) {
            return { isMatch: true, confidence: 100 };
          }

          // 2. Ki·ªÉm tra word-by-word similarity
          const wordSimilarity = this.calculateWordSimilarity(
            normalizedInput,
            normalizedExpected
          );
          const wordConfidence = Math.round(wordSimilarity * 100);

          if (wordSimilarity >= 0.6) {
            return { isMatch: true, confidence: wordConfidence };
          }

          // 3. Ki·ªÉm tra Levenshtein distance cho c√°c l·ªói typo nh·ªè
          const editDistance = this.calculateEditDistance(
            normalizedInput,
            normalizedExpected
          );
          const maxLength = Math.max(
            normalizedInput.length,
            normalizedExpected.length
          );
          const editSimilarity = 1 - editDistance / maxLength;
          const editConfidence = Math.round(editSimilarity * 100);

          if (editSimilarity >= 0.9) {
            return { isMatch: true, confidence: editConfidence };
          }

          // 4. Ki·ªÉm tra c√°c t·ª´ kh√≥a quan tr·ªçng
          const keywordMatch = this.checkKeywordMatch(
            normalizedInput,
            normalizedExpected
          );
          if (keywordMatch.isMatch) {
            return { isMatch: true, confidence: keywordMatch.confidence };
          }

          // Kh√¥ng match
          return {
            isMatch: false,
            confidence: Math.max(
              wordConfidence,
              editConfidence,
              keywordMatch.confidence
            ),
          };
        }

        // T√≠nh to√°n Levenshtein distance
        calculateEditDistance(str1, str2) {
          const matrix = [];
          const len1 = str1.length;
          const len2 = str2.length;

          for (let i = 0; i <= len1; i++) {
            matrix[i] = [i];
          }

          for (let j = 0; j <= len2; j++) {
            matrix[0][j] = j;
          }

          for (let i = 1; i <= len1; i++) {
            for (let j = 1; j <= len2; j++) {
              if (str1.charAt(i - 1) === str2.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
              } else {
                matrix[i][j] = Math.min(
                  matrix[i - 1][j - 1] + 1, // substitution
                  matrix[i][j - 1] + 1, // insertion
                  matrix[i - 1][j] + 1 // deletion
                );
              }
            }
          }

          return matrix[len1][len2];
        }

        // Ki·ªÉm tra t·ª´ kh√≥a quan tr·ªçng
        checkKeywordMatch(input, expected) {
          const inputWords = input.split(" ").filter((w) => w.length > 0);
          const expectedWords = expected.split(" ").filter((w) => w.length > 0);

          // L·ªçc c√°c t·ª´ quan tr·ªçng (lo·∫°i b·ªè articles, prepositions, etc.)
          const fillerWords = [
            "der",
            "die",
            "das",
            "ein",
            "eine",
            "und",
            "oder",
            "aber",
            "in",
            "mit",
            "von",
            "zu",
            "auf",
            "f√ºr",
            "ist",
            "sind",
            "war",
            "waren",
            "haben",
            "hat",
            "werden",
            "wird",
            "ich",
            "sie",
            "er",
            "wir",
            "ihr",
            "also",
            "ja",
            "nein",
            "gut",
            "okay",
            "√§h",
            "nun",
            "noch",
            "schon",
            "denn",
            "dann",
            "doch",
            "mal",
            "nur",
            "auch",
            "nicht",
          ];

          const importantInputWords = inputWords.filter(
            (word) => !fillerWords.includes(word) && word.length > 2
          );

          const importantExpectedWords = expectedWords.filter(
            (word) => !fillerWords.includes(word) && word.length > 2
          );

          if (importantExpectedWords.length === 0) {
            return { isMatch: false, confidence: 0 };
          }

          let matchedWords = 0;
          for (const expectedWord of importantExpectedWords) {
            for (const inputWord of importantInputWords) {
              if (
                inputWord === expectedWord ||
                inputWord.includes(expectedWord) ||
                expectedWord.includes(inputWord) ||
                this.calculateEditDistance(inputWord, expectedWord) <= 1
              ) {
                matchedWords++;
                break;
              }
            }
          }

          const keywordSimilarity =
            matchedWords / importantExpectedWords.length;
          const confidence = Math.round(keywordSimilarity * 100);

          // Trong strict mode, c·∫ßn √≠t nh·∫•t 90% keywords match
          return {
            isMatch: keywordSimilarity >= 0.9,
            confidence: confidence,
          };
        }

        normalizeForStrictComparison(text) {
          return text
            .toLowerCase()
            .replace(/[.,!?;:‚Äû"‚Äû"‚Ä¶]/g, "") // Lo·∫°i b·ªè d·∫•u c√¢u
            .replace(/\s+/g, " ") // Normalize spaces
            .replace(/√§/g, "ae") // Normalize umlauts
            .replace(/√∂/g, "oe")
            .replace(/√º/g, "ue")
            .replace(/√ü/g, "ss")
            .trim();
        }

        calculateWordSimilarity(str1, str2) {
          const words1 = str1.split(" ").filter((w) => w.length > 0);
          const words2 = str2.split(" ").filter((w) => w.length > 0);

          // N·∫øu s·ªë t·ª´ kh√°c nhau qu√° nhi·ªÅu, coi nh∆∞ sai
          if (Math.abs(words1.length - words2.length) > 1) {
            return 0;
          }

          const maxLength = Math.max(words1.length, words2.length);
          if (maxLength === 0) return 1;

          let exactMatches = 0;
          let usedIndices = new Set();

          // ƒê·∫øm exact matches
          for (let i = 0; i < words1.length; i++) {
            for (let j = 0; j < words2.length; j++) {
              if (!usedIndices.has(j) && words1[i] === words2[j]) {
                exactMatches++;
                usedIndices.add(j);
                break;
              }
            }
          }

          return exactMatches / maxLength;
        }

        updateProgress() {
          const progress =
            (this.currentStep / this.conversationSequence.length) * 100;
          this.progressFill.style.width = `${progress}%`;
        }

        updateExpectedResponse() {
          if (this.currentStep >= this.conversationSequence.length) {
            this.expectedResponse.innerHTML = `<strong>üéâ Cu·ªôc h·ªôi tho·∫°i ho√†n th√†nh!</strong> Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i luy·ªán t·∫≠p.`;
            this.micBtn.disabled = true;
            this.micBtn.textContent = "üé§ Ho√†n th√†nh";
            return;
          }

          const currentSequence = this.conversationSequence[this.currentStep];

          if (this.isUserTurn()) {
            const roleText =
              this.userRole === "teacher" ? "Gi√°o vi√™n" : "H·ªçc vi√™n";
            this.expectedResponse.innerHTML = `<strong>üéØ ƒê·∫øn l∆∞·ª£t b·∫°n (${roleText}) n√≥i CH√çNH X√ÅC:</strong><br><strong>"${currentSequence.text}"</strong>`;
            this.expectedResponse.style.display = "block";
            this.micBtn.disabled = false;
            this.micBtn.textContent = "üé§ N√≥i";
          } else {
            const aiRole =
              this.userRole === "teacher" ? "H·ªçc vi√™n" : "Gi√°o vi√™n";
            this.expectedResponse.innerHTML = `<strong>ü§ñ ${aiRole} (AI) s·∫Ω n√≥i:</strong><br>"${currentSequence.text}"`;
            this.expectedResponse.style.display = "block";
            this.micBtn.disabled = true;
            this.micBtn.textContent = "üé§ Ch·ªù AI";
          }
        }

        loadVoices() {
          this.voices = this.synthesis.getVoices();
          this.voiceSelect.innerHTML =
            '<option value="">Ch·ªçn gi·ªçng n√≥i...</option>';

          const germanVoices = this.voices.filter(
            (voice) =>
              voice.lang.startsWith("de") ||
              voice.name.toLowerCase().includes("german")
          );

          germanVoices.forEach((voice, index) => {
            const option = document.createElement("option");
            option.value = this.voices.indexOf(voice);
            option.textContent = `${voice.name} (${voice.lang})`;
            this.voiceSelect.appendChild(option);
          });

          if (germanVoices.length > 0) {
            this.currentVoice = germanVoices[0];
            this.voiceSelect.value = this.voices.indexOf(germanVoices[0]);
          }
        }

        selectVoice(voiceIndex) {
          if (voiceIndex !== "") {
            this.currentVoice = this.voices[voiceIndex];
          }
        }

        updateSpeed(speed) {
          this.speed = parseFloat(speed);
          this.speedValue.textContent = speed + "x";
        }

        toggleRecording() {
          if (!this.recognition) {
            this.showStatus("Nh·∫≠n di·ªán gi·ªçng n√≥i kh√¥ng kh·∫£ d·ª•ng", "error");
            return;
          }

          if (this.micBtn.disabled) {
            this.showStatus("Ch∆∞a ƒë·∫øn l∆∞·ª£t b·∫°n n√≥i", "error");
            return;
          }

          if (this.isRecording) {
            this.stopRecording();
          } else {
            this.startRecording();
          }
        }

        startRecording() {
          try {
            // Ki·ªÉm tra quy·ªÅn truy c·∫≠p microphone
            navigator.mediaDevices
              .getUserMedia({ audio: true })
              .then(() => {
                this.recognition.start();
                this.showStatus("üé§ B·∫Øt ƒë·∫ßu ghi √¢m...", "listening");
              })
              .catch((error) => {
                console.error("Microphone access denied:", error);
                this.showStatus(
                  "Kh√¥ng th·ªÉ truy c·∫≠p microphone. Vui l√≤ng c·∫•p quy·ªÅn truy c·∫≠p.",
                  "error"
                );
              });
          } catch (error) {
            console.error("Error starting recognition:", error);
            this.showStatus("L·ªói kh·ªüi ƒë·ªông nh·∫≠n di·ªán gi·ªçng n√≥i", "error");
          }
        }

        stopRecording() {
          try {
            if (this.recognition && this.isRecording) {
              this.recognition.stop();
            }
          } catch (error) {
            console.error("Error stopping recognition:", error);
          }

          this.isRecording = false;
          this.micBtn.classList.remove("recording");
          this.micBtn.textContent = "üé§ N√≥i";

          if (this.recordingTimeout) {
            clearTimeout(this.recordingTimeout);
            this.recordingTimeout = null;
          }

          this.showStatus("");
        }

        restartConversation() {
          this.currentStep = 0;
          this.conversationHistory = [];
          this.waitingForAI = false;
          this.conversationArea.innerHTML = "";

          this.updateProgress();
          this.updateExpectedResponse();
          this.updateDebugInfo();
          this.showStatus("Cu·ªôc h·ªôi tho·∫°i ƒë√£ ƒë∆∞·ª£c kh·ªüi ƒë·ªông l·∫°i", "success");

          if (!this.isUserTurn()) {
            setTimeout(() => {
              this.playAIResponse();
            }, 1000);
          }
        }

        addMessage(text, sender) {
          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${sender}`;

          let speaker = "";
          if (sender === "user") {
            speaker =
              this.userRole === "teacher"
                ? this.teacherName
                : `${this.studentFirstName} ${this.studentLastName}`;
          } else if (sender === "ai") {
            speaker =
              this.userRole === "teacher"
                ? `${this.studentFirstName} ${this.studentLastName}`
                : this.teacherName;
          }

          if (sender === "error" || sender === "success") {
            messageDiv.innerHTML = `<div>${text}</div>`;
          } else {
            messageDiv.innerHTML = `
                        <div class="speaker">${speaker}:</div>
                        <div>${text}</div>
                    `;
          }

          this.conversationArea.appendChild(messageDiv);
          this.conversationArea.scrollTop = this.conversationArea.scrollHeight;

          if (sender !== "error" && sender !== "success") {
            this.conversationHistory.push({
              speaker: speaker,
              text: text,
              timestamp: Date.now(),
            });
          }
        }

        speakText(text) {
          if (!this.synthesis) return;

          this.synthesis.cancel();

          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "de-DE";
          utterance.rate = this.speed;

          if (this.currentVoice) {
            utterance.voice = this.currentVoice;
          }

          utterance.onstart = () => {
            this.showStatus("ƒêang ph√°t √¢m...", "speaking");
          };

          utterance.onend = () => {
            this.showStatus("");
          };

          utterance.onerror = (event) => {
            this.showStatus("L·ªói ph√°t √¢m: " + event.error, "error");
          };

          this.synthesis.speak(utterance);
        }

        repeatLastMessage() {
          if (this.conversationHistory.length === 0) {
            this.showStatus("Ch∆∞a c√≥ tin nh·∫Øn n√†o ƒë·ªÉ ph√°t l·∫°i", "error");
            return;
          }

          const lastMessage =
            this.conversationHistory[this.conversationHistory.length - 1];
          this.speakText(lastMessage.text);
        }

        clearConversation() {
          this.conversationArea.innerHTML = "";
          this.conversationHistory = [];
          this.currentStep = 0;
          this.waitingForAI = false;
          this.updateProgress();
          this.updateExpectedResponse();
          this.updateDebugInfo();
          this.showStatus("Cu·ªôc h·ªôi tho·∫°i ƒë√£ ƒë∆∞·ª£c x√≥a", "success");
        }

        showStatus(message, type = "") {
          this.status.textContent = message;
          this.status.className = `status ${type}`;

          if (message && type !== "error" && type !== "success") {
            setTimeout(() => {
              this.status.textContent = "";
              this.status.className = "status";
            }, 3000);
          }

          if (type === "success" || type === "error") {
            setTimeout(() => {
              this.status.textContent = "";
              this.status.className = "status";
            }, 5000);
          }
        }
      }

      // Initialize the app when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        new StrictGermanConversationAI();
      });
    </script>
  </body>
</html>
