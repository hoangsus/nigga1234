<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>German Conversation AI - LinguaTreff (Bilingual)</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        max-width: 900px;
        width: 100%;
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #ff6b6b, #ffa726);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .main-content {
        padding: 30px;
      }

      .name-settings {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        border: 2px solid #e9ecef;
      }

      .name-settings h3 {
        margin-bottom: 15px;
        color: #333;
        text-align: center;
      }

      .name-inputs {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .name-input-group {
        flex: 1;
        min-width: 200px;
      }

      .name-input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }

      .name-input {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 1em;
        transition: border-color 0.3s ease;
      }

      .name-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .save-btn {
        background: linear-gradient(135deg, #00b894, #00cec9);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 20px;
        font-size: 1em;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        display: block;
        margin: 0 auto;
      }

      .save-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 206, 201, 0.3);
      }

      .role-selector {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        justify-content: center;
      }

      .role-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
      }

      .role-option:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .role-option input[type="radio"] {
        accent-color: #667eea;
      }

      .role-option input[type="radio"]:checked + span {
        color: #667eea;
        font-weight: bold;
      }

      .language-settings {
        background: #e8f4f8;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 2px solid #b8daff;
      }

      .language-settings h4 {
        margin-bottom: 10px;
        color: #333;
        text-align: center;
      }

      .language-options {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .conversation-container {
        margin-top: 20px;
      }

      .current-roles {
        background: #e8f4f8;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 2px solid #b8daff;
      }

      .role-display {
        margin-bottom: 8px;
      }

      .role-display:last-child {
        margin-bottom: 0;
      }

      .conversation-area {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        min-height: 300px;
        max-height: 400px;
        overflow-y: auto;
        border: 2px solid #e9ecef;
      }

      .message {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 10px;
        max-width: 80%;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease;
      }

      .message.user {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        margin-left: auto;
        text-align: right;
      }

      .message.ai {
        background: linear-gradient(135deg, #ffeaa7, #fab1a0);
        color: #2d3436;
      }

      .message.error {
        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        color: white;
        margin: 0 auto;
        text-align: center;
        max-width: 90%;
      }

      .message.success {
        background: linear-gradient(135deg, #00b894, #00cec9);
        color: white;
        margin: 0 auto;
        text-align: center;
        max-width: 90%;
      }

      .message .speaker {
        font-weight: bold;
        font-size: 0.9em;
        margin-bottom: 5px;
        opacity: 0.8;
      }

      .progress-bar {
        background: #e9ecef;
        border-radius: 10px;
        height: 20px;
        margin-bottom: 20px;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(135deg, #00b894, #00cec9);
        height: 100%;
        transition: width 0.3s ease;
        border-radius: 10px;
      }

      .progress-text {
        text-align: center;
        margin-bottom: 10px;
        font-weight: bold;
        color: #555;
      }

      .expected-response {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        color: #155724;
      }

      .expected-response .german-text {
        font-style: italic;
        font-size: 1.1em;
        margin-bottom: 10px;
        color: #0c5460;
      }

      .expected-response .vietnamese-text {
        font-size: 0.9em;
        color: #666;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #28a745;
      }

      .expected-response .alternatives {
        margin-top: 10px;
        padding: 10px;
        background: #fff3cd;
        border-radius: 5px;
        border-left: 4px solid #ffc107;
        font-size: 0.9em;
      }

      .expected-response strong {
        color: #0c5460;
      }

      .strict-mode-notice {
        background: #fff3cd;
        border: 2px solid #ffeaa7;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: bold;
        color: #856404;
      }

      .controls {
        display: flex;
        gap: 15px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
      }

      .control-btn {
        padding: 15px 25px;
        border: none;
        border-radius: 25px;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .mic-btn {
        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        color: white;
      }

      .mic-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(238, 90, 111, 0.3);
      }

      .mic-btn.recording {
        background: linear-gradient(135deg, #fd79a8, #e84393);
        animation: pulse 1s infinite;
      }

      .mic-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .speak-btn {
        background: linear-gradient(135deg, #00b894, #00cec9);
        color: white;
      }

      .speak-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 206, 201, 0.3);
      }

      .restart-btn {
        background: linear-gradient(135deg, #fdcb6e, #e17055);
        color: white;
      }

      .restart-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(225, 112, 85, 0.3);
      }

      .clear-btn {
        background: linear-gradient(135deg, #636e72, #2d3436);
        color: white;
      }

      .clear-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(99, 110, 114, 0.3);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .status {
        text-align: center;
        margin-top: 20px;
        padding: 10px;
        border-radius: 10px;
        font-weight: bold;
      }

      .status.listening {
        background: #dff0d8;
        color: #3c763d;
      }

      .status.speaking {
        background: #d9edf7;
        color: #31708f;
      }

      .status.error {
        background: #f2dede;
        color: #a94442;
      }

      .voice-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 15px;
        justify-content: center;
      }

      .voice-select {
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 20px;
        font-size: 1em;
        background: white;
        cursor: pointer;
      }

      .speed-control {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .speed-slider {
        width: 100px;
      }

      .tolerance-control {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
        justify-content: center;
      }

      .tolerance-slider {
        width: 150px;
      }

      @media (max-width: 768px) {
        .name-inputs {
          flex-direction: column;
        }

        .role-selector {
          flex-direction: column;
          align-items: center;
        }

        .controls {
          flex-direction: column;
        }

        .voice-controls {
          flex-direction: column;
        }

        .language-options {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🎯 LinguaTreff AI</h1>
        <p>Luyện tập hội thoại tiếng Đức với AI - Hỗ trợ song ngữ</p>
      </div>

      <div class="main-content">
        <div class="name-settings" id="nameSettings">
          <h3>⚙️ Cài đặt thông tin nhân vật</h3>
          <div class="name-inputs">
            <div class="name-input-group">
              <label for="teacherName">Tên giáo viên:</label>
              <input
                type="text"
                id="teacherName"
                class="name-input"
                value="Frau Schwarz"
                placeholder="Nhập tên giáo viên"
              />
            </div>
            <div class="name-input-group">
              <label for="studentFirstName">Tên (Vorname) học viên:</label>
              <input
                type="text"
                id="studentFirstName"
                class="name-input"
                value="Nguyễn Văn An"
                placeholder="Nhập tên học viên"
              />
            </div>
            <div class="name-input-group">
              <label for="studentLastName">Họ (Familienname) học viên:</label>
              <input
                type="text"
                id="studentLastName"
                class="name-input"
                value="Nguyen"
                placeholder="Nhập họ học viên"
              />
            </div>
            <div class="name-input-group">
              <label for="studentCity">Thành phố học viên:</label>
              <input
                type="text"
                id="studentCity"
                class="name-input"
                value="Hanoi"
                placeholder="Nhập thành phố"
              />
            </div>
            <div class="name-input-group">
              <label for="studentCountry">Đất nước:</label>
              <input
                type="text"
                id="studentCountry"
                class="name-input"
                value="Vietnam"
                placeholder="Nhập đất nước (tiếng Đức)"
              />
            </div>
            <div class="name-input-group">
              <label for="studentAddress">Địa chỉ học viên:</label>
              <input
                type="text"
                id="studentAddress"
                class="name-input"
                value="Hauptstraße 15"
                placeholder="Nhập địa chỉ"
              />
            </div>
            <div class="name-input-group">
              <label for="courseLevel">Cấp độ khóa học:</label>
              <input
                type="text"
                id="courseLevel"
                class="name-input"
                value="A 1.1"
                placeholder="Nhập cấp độ khóa học"
              />
            </div>
            <div class="name-input-group">
              <label for="schoolName">Tên trường:</label>
              <input
                type="text"
                id="schoolName"
                class="name-input"
                value="LinguaTreff"
                placeholder="Nhập tên trường"
              />
            </div>
          </div>

          <div class="language-settings">
            <h4>🗣️ Cài đặt ngôn ngữ nhận diện</h4>
            <div class="language-options">
              <label class="role-option">
                <input type="checkbox" id="enableGerman" checked />
                <span>🇩🇪 Tiếng Đức</span>
              </label>
              <label class="role-option">
                <input type="checkbox" id="enableVietnamese" checked />
                <span>🇻🇳 Tiếng Việt</span>
              </label>
            </div>
          </div>

          <div class="role-selector">
            <h4>Chọn vai của bạn:</h4>
            <div
              style="
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-top: 10px;
              "
            >
              <label class="role-option">
                <input
                  type="radio"
                  name="userRole"
                  value="teacher"
                  id="roleTeacher"
                />
                <span>👩‍🏫 Tôi đóng vai giáo viên</span>
              </label>
              <label class="role-option">
                <input
                  type="radio"
                  name="userRole"
                  value="student"
                  id="roleStudent"
                  checked
                />
                <span>👩‍🎓 Tôi đóng vai học viên</span>
              </label>
            </div>
          </div>

          <div class="tolerance-control">
            <label>Độ khắt khe:</label>
            <input
              type="range"
              class="tolerance-slider"
              id="toleranceSlider"
              min="0.7"
              max="1.0"
              step="0.05"
              value="0.85"
            />
            <span id="toleranceValue">85%</span>
          </div>

          <button class="save-btn" id="saveNames">
            💾 Lưu thông tin & Bắt đầu
          </button>
        </div>

        <div
          class="conversation-container"
          id="conversationContainer"
          style="display: none"
        >
          <div class="strict-mode-notice">
            ⚠️ CHẾ ĐỘ SONG NGỮ: Có thể nói tiếng Đức hoặc tiếng Việt!
          </div>

          <div class="progress-text">Tiến độ hội thoại</div>
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="progressFill"
              style="width: 0%"
            ></div>
          </div>

          <div class="current-roles" id="currentRoles">
            <div class="role-display">
              <strong>👤 Bạn đóng vai:</strong>
              <span id="userRoleDisplay">Chưa chọn</span>
            </div>
            <div class="role-display">
              <strong>🤖 AI đóng vai:</strong>
              <span id="aiRoleDisplay">Chưa chọn</span>
            </div>
          </div>

          <div class="expected-response" id="expectedResponse">
            <strong>Chuẩn bị bắt đầu cuộc hội thoại...</strong>
          </div>

          <div class="conversation-area" id="conversationArea"></div>

          <div class="controls">
            <button class="control-btn mic-btn" id="micBtn">🎤 Nói</button>
            <button class="control-btn speak-btn" id="speakBtn">
              🔊 Phát lại
            </button>
            <button class="control-btn restart-btn" id="restartBtn">
              🔄 Bắt đầu lại
            </button>
            <button class="control-btn clear-btn" id="clearBtn">
              🗑️ Xóa hết
            </button>
            <button class="control-btn clear-btn" id="newConversationBtn">
              ⚙️ Cài đặt mới
            </button>
          </div>

          <div class="voice-controls">
            <select class="voice-select" id="voiceSelect">
              <option value="">Chọn giọng nói...</option>
            </select>
            <div class="speed-control">
              <label>Tốc độ:</label>
              <input
                type="range"
                class="speed-slider"
                id="speedSlider"
                min="0.5"
                max="2"
                step="0.1"
                value="1"
              />
              <span id="speedValue">1.0x</span>
            </div>
          </div>

          <div class="status" id="status"></div>
        </div>
      </div>
    </div>

    <script>
      class BilingualGermanConversationAI {
        constructor() {
          this.recognition = null;
          this.synthesis = window.speechSynthesis;
          this.voices = [];
          this.currentVoice = null;
          this.isRecording = false;
          this.conversationHistory = [];
          this.speed = 1.0;
          this.tolerance = 0.85;
          this.currentStep = 0;
          this.teacherName = "Frau Schwarz";
          this.studentFirstName = "Nguyễn Văn An";
          this.studentLastName = "Nguyen";
          this.studentCity = "Hanoi";
          this.studentCountry = "Vietnam";
          this.studentAddress = "Hauptstraße 15";
          this.courseLevel = "A 1.1";
          this.schoolName = "LinguaTreff";
          this.userRole = "student";
          this.conversationStarted = false;
          this.waitingForAI = false;
          this.enableGerman = true;
          this.enableVietnamese = true;

          // Base conversation template - will be updated with user data
          this.conversationTemplate = [
            {
              speaker: "teacher",
              textTemplate:
                "Sprachschule {schoolName}. Sie sprechen mit {teacherName}. Guten Tag.",
              vietnamese:
                "Trường ngoại ngữ {schoolName}. Chị đang nói chuyện với {teacherName}. Chào chị.",
              expectedTemplate: "Guten Tag, ich möchte mich anmelden.",
              expectedVietnamese: "Chào bà, tôi muốn đăng ký học.",
              alternatives: ["Xin chào", "Chào bà", "Guten Tag"],
            },
            {
              speaker: "student",
              textTemplate: "Guten Tag, ich möchte mich anmelden.",
              vietnamese: "Chào bà, tôi muốn đăng ký học.",
              expectedTemplate: "Gern. Für welchen Kurs denn, bitte?",
              expectedVietnamese: "Được chứ. Chị muốn đăng ký khóa học nào?",
              alternatives: ["Được", "Được chứ", "Gern"],
            },
            {
              speaker: "teacher",
              textTemplate: "Gern. Für welchen Kurs denn, bitte?",
              vietnamese: "Được chứ. Chị muốn đăng ký khóa học nào?",
              expectedTemplate: "Anfänger, also {courseLevel}.",
              expectedVietnamese: "Người mới bắt đầu, tức là {courseLevel}.",
              alternatives: ["Anfänger", "Người mới bắt đầu", "{courseLevel}"],
            },
            {
              speaker: "student",
              textTemplate: "Anfänger, also {courseLevel}.",
              vietnamese: "Người mới bắt đầu, tức là {courseLevel}.",
              expectedTemplate: "Gut, ja. Wie heißen Sie, bitte?",
              expectedVietnamese: "Tốt. Chị tên gì?",
              alternatives: ["Gut", "Tốt", "Wie heißen Sie"],
            },
            {
              speaker: "teacher",
              textTemplate: "Gut, ja. Wie heißen Sie, bitte?",
              vietnamese: "Tốt. Chị tên gì?",
              expectedTemplate: "{studentLastName}.",
              expectedVietnamese: "{studentLastName}.",
              alternatives: ["{studentLastName}", "{studentVietnameseName}"],
            },
            {
              speaker: "student",
              textTemplate: "{studentLastName}.",
              vietnamese: "{studentLastName}.",
              expectedTemplate: "Wiederholen Sie das bitte.",
              expectedVietnamese: "Xin chị lặp lại.",
              alternatives: ["Wiederholen Sie", "Lặp lại", "Bitte wiederholen"],
            },
            {
              speaker: "teacher",
              textTemplate: "Wiederholen Sie das bitte.",
              vietnamese: "Xin chị lặp lại.",
              expectedTemplate: "Ich heiße {studentLastName}.",
              expectedVietnamese: "Tôi tên là {studentLastName}.",
              alternatives: [
                "Ich heiße",
                "Tôi tên là",
                "Tôi là {studentLastName}",
              ],
            },
            {
              speaker: "student",
              textTemplate: "Ich heiße {studentLastName}.",
              vietnamese: "Tôi tên là {studentLastName}.",
              expectedTemplate: "Mit „e am Ende?",
              expectedVietnamese: 'Có chữ "e" ở cuối không?',
              alternatives: ["Mit e", "Có chữ e", "e am Ende"],
            },
            {
              speaker: "teacher",
              textTemplate: "Mit „e am Ende?",
              vietnamese: 'Có chữ "e" ở cuối không?',
              expectedTemplate: "Nein, nur mit „{lastLetter}.",
              expectedVietnamese: 'Không, chỉ có chữ "{lastLetter}".',
              alternatives: ["Nein", "Không", "nur mit {lastLetter}"],
            },
            {
              speaker: "student",
              textTemplate: "Nein, nur mit „{lastLetter}.",
              vietnamese: 'Không, chỉ có chữ "{lastLetter}".',
              expectedTemplate:
                "Okay. Ich buchstabiere: {studentLastNameSpelled}.",
              expectedVietnamese:
                "Được. Tôi đánh vần: {studentLastNameSpelled}.",
              alternatives: [
                "Okay",
                "Được",
                "Ich buchstabiere",
                "Tôi đánh vần",
              ],
            },
            {
              speaker: "teacher",
              textTemplate: "Okay. Ich buchstabiere: {studentLastNameSpelled}.",
              vietnamese: "Được. Tôi đánh vần: {studentLastNameSpelled}.",
              expectedTemplate: "Richtig.",
              expectedVietnamese: "Đúng rồi.",
              alternatives: ["Richtig", "Đúng", "Đúng rồi"],
            },
            {
              speaker: "student",
              textTemplate: "Richtig.",
              vietnamese: "Đúng rồi.",
              expectedTemplate: "Und Ihr Vorname, bitte?",
              expectedVietnamese: "Và tên của chị?",
              alternatives: ["Ihr Vorname", "Tên của chị", "Vorname"],
            },
            {
              speaker: "teacher",
              textTemplate: "Und Ihr Vorname, bitte?",
              vietnamese: "Và tên của chị?",
              expectedTemplate: "{studentFirstName}.",
              expectedVietnamese: "{studentFirstName}.",
              alternatives: ["{studentFirstName}", "{studentVietnameseName}"],
            },
            {
              speaker: "student",
              textTemplate: "{studentFirstName}.",
              vietnamese: "{studentFirstName}.",
              expectedTemplate: "{studentFirstNameConfusion}?",
              expectedVietnamese: "{studentFirstNameConfusion}?",
              alternatives: ["{studentFirstNameConfusion}", "Tên khác"],
            },
            {
              speaker: "teacher",
              textTemplate: "{studentFirstNameConfusion}?",
              vietnamese: "{studentFirstNameConfusion}?",
              expectedTemplate:
                "Äh, nein. {studentFirstName}. Mit „{firstNameLastLetter} am Ende. ... {studentFirstNameSpelled}.",
              expectedVietnamese:
                'Ờ, không. {studentFirstName}. Có chữ "{firstNameLastLetter}" ở cuối. ... {studentFirstNameSpelled}.',
              alternatives: [
                "Äh nein",
                "Ờ không",
                "Không",
                "{studentFirstName}",
              ],
            },
            {
              speaker: "student",
              textTemplate:
                "Äh, nein. {studentFirstName}. Mit „{firstNameLastLetter} am Ende. ... {studentFirstNameSpelled}.",
              vietnamese:
                'Ờ, không. {studentFirstName}. Có chữ "{firstNameLastLetter}" ở cuối. ... {studentFirstNameSpelled}.',
              expectedTemplate: "Also {studentFirstName} {studentLastName}.",
              expectedVietnamese:
                "Vậy là {studentFirstName} {studentLastName}.",
              alternatives: [
                "Also",
                "Vậy là",
                "{studentFirstName} {studentLastName}",
              ],
            },
            {
              speaker: "teacher",
              textTemplate: "Also {studentFirstName} {studentLastName}.",
              vietnamese: "Vậy là {studentFirstName} {studentLastName}.",
              expectedTemplate: "Richtig.",
              expectedVietnamese: "Đúng rồi.",
              alternatives: ["Richtig", "Đúng", "Đúng rồi"],
            },
            {
              speaker: "student",
              textTemplate: "Richtig.",
              vietnamese: "Đúng rồi.",
              expectedTemplate: "Und woher kommen Sie Frau {studentLastName}?",
              expectedVietnamese: "Và bà {studentLastName} đến từ đâu?",
              alternatives: [
                "woher kommen Sie",
                "đến từ đâu",
                "Frau {studentLastName}",
              ],
            },
            {
              speaker: "teacher",
              textTemplate: "Und woher kommen Sie Frau {studentLastName}?",
              vietnamese: "Và bà {studentLastName} đến từ đâu?",
              expectedTemplate: "Ich bin aus {studentCity}.",
              expectedVietnamese: "Tôi đến từ {studentCity}.",
              alternatives: [
                "Ich bin aus",
                "Tôi đến từ",
                "Tôi từ {studentCity}",
                "{studentCity}",
              ],
            },
            {
              speaker: "student",
              textTemplate: "Ich bin aus {studentCity}.",
              vietnamese: "Tôi đến từ {studentCity}.",
              expectedTemplate: "Aus {studentCityGerman}?",
              expectedVietnamese: "Từ {studentCityGerman}?",
              alternatives: [
                "Aus {studentCityGerman}",
                "Từ {studentCityGerman}",
                "{studentCityGerman}",
              ],
            },
            {
              speaker: "teacher",
              textTemplate: "Aus {studentCityGerman}?",
              vietnamese: "Từ {studentCityGerman}?",
              expectedTemplate:
                "Ja, {studentCityGerman} in {studentCountry}. Das heißt {studentCity}. Ich buchstabiere: {studentCitySpelled}.",
              expectedVietnamese:
                "Vâng, {studentCityGerman} ở {studentCountry}. Tức là {studentCity}. Tôi đánh vần: {studentCitySpelled}.",
              alternatives: [
                "Ja",
                "Vâng",
                "in {studentCountry}",
                "ở {studentCountry}",
                "Das heißt",
                "Tức là",
                "Ich buchstabiere",
                "Tôi đánh vần",
              ],
            },
            {
              speaker: "student",
              textTemplate:
                "Ja, {studentCityGerman} in {studentCountry}. Das heißt {studentCity}. Ich buchstabiere: {studentCitySpelled}.",
              vietnamese:
                "Vâng, {studentCityGerman} ở {studentCountry}. Tức là {studentCity}. Tôi đánh vần: {studentCitySpelled}.",
              expectedTemplate:
                "Aha. Danke. Das hab ich. Nun noch die Adresse.",
              expectedVietnamese:
                "À ha. Cảm ơn. Tôi đã ghi được. Bây giờ là địa chỉ.",
              alternatives: [
                "Aha",
                "À ha",
                "Danke",
                "Cảm ơn",
                "die Adresse",
                "địa chỉ",
              ],
            },
            {
              speaker: "teacher",
              textTemplate: "Aha. Danke. Das hab ich. Nun noch die Adresse.",
              vietnamese: "À ha. Cảm ơn. Tôi đã ghi được. Bây giờ là địa chỉ.",
              expectedTemplate:
                "Die ist einfach. Also, ich wohne in der {studentAddress}.",
              expectedVietnamese:
                "Địa chỉ thì đơn giản. Tôi sống ở {studentAddress}.",
              alternatives: [
                "Die ist einfach",
                "Địa chỉ đơn giản",
                "ich wohne",
                "Tôi sống",
                "in der {studentAddress}",
                "ở {studentAddress}",
              ],
            },
            {
              speaker: "student",
              textTemplate:
                "Die ist einfach. Also, ich wohne in der {studentAddress}.",
              vietnamese: "Địa chỉ thì đơn giản. Tôi sống ở {studentAddress}.",
              expectedTemplate: "{studentAddress}. Gut, danke. Das war's.",
              expectedVietnamese: "{studentAddress}. Tốt, cảm ơn. Xong rồi.",
              alternatives: [
                "Gut",
                "Tốt",
                "Danke",
                "Cảm ơn",
                "Das war's",
                "Xong rồi",
              ],
            },
            {
              speaker: "teacher",
              textTemplate: "{studentAddress}. Gut, danke. Das war's.",
              vietnamese: "{studentAddress}. Tốt, cảm ơn. Xong rồi.",
              expectedTemplate: "Conversation completed!",
              expectedVietnamese: "Cuộc hội thoại hoàn thành!",
              alternatives: ["Completed", "Hoàn thành", "Xong"],
            },
          ];

          // Processed conversation sequence
          this.conversationSequence = [];

          this.initializeElements();
          this.setupEventListeners();
          this.initializeSpeechRecognition();
          this.loadVoices();
          this.updateProgress();
          this.updateExpectedResponse();
        }

        initializeElements() {
          this.conversationArea = document.getElementById("conversationArea");
          this.micBtn = document.getElementById("micBtn");
          this.speakBtn = document.getElementById("speakBtn");
          this.restartBtn = document.getElementById("restartBtn");
          this.clearBtn = document.getElementById("clearBtn");
          this.status = document.getElementById("status");
          this.voiceSelect = document.getElementById("voiceSelect");
          this.speedSlider = document.getElementById("speedSlider");
          this.speedValue = document.getElementById("speedValue");
          this.toleranceSlider = document.getElementById("toleranceSlider");
          this.toleranceValue = document.getElementById("toleranceValue");
          this.progressFill = document.getElementById("progressFill");
          this.expectedResponse = document.getElementById("expectedResponse");
          this.teacherNameInput = document.getElementById("teacherName");
          this.studentFirstNameInput =
            document.getElementById("studentFirstName");
          this.studentLastNameInput =
            document.getElementById("studentLastName");
          this.studentCityInput = document.getElementById("studentCity");
          this.studentCountryInput = document.getElementById("studentCountry");
          this.studentAddressInput = document.getElementById("studentAddress");
          this.courseLevelInput = document.getElementById("courseLevel");
          this.schoolNameInput = document.getElementById("schoolName");
          this.saveNamesBtn = document.getElementById("saveNames");
          this.roleTeacherInput = document.getElementById("roleTeacher");
          this.roleStudentInput = document.getElementById("roleStudent");
          this.nameSettings = document.getElementById("nameSettings");
          this.conversationContainer = document.getElementById(
            "conversationContainer"
          );
          this.userRoleDisplay = document.getElementById("userRoleDisplay");
          this.aiRoleDisplay = document.getElementById("aiRoleDisplay");
          this.newConversationBtn =
            document.getElementById("newConversationBtn");
          this.enableGermanInput = document.getElementById("enableGerman");
          this.enableVietnameseInput =
            document.getElementById("enableVietnamese");
        }

        setupEventListeners() {
          this.micBtn.addEventListener("click", () => this.toggleRecording());
          this.speakBtn.addEventListener("click", () =>
            this.repeatLastMessage()
          );
          this.restartBtn.addEventListener("click", () =>
            this.restartConversation()
          );
          this.clearBtn.addEventListener("click", () =>
            this.clearConversation()
          );
          this.newConversationBtn.addEventListener("click", () =>
            this.startNewConversation()
          );
          this.saveNamesBtn.addEventListener("click", () =>
            this.saveNamesAndStart()
          );

          this.voiceSelect.addEventListener("change", (e) =>
            this.selectVoice(e.target.value)
          );
          this.speedSlider.addEventListener("input", (e) =>
            this.updateSpeed(e.target.value)
          );
          this.toleranceSlider.addEventListener("input", (e) =>
            this.updateTolerance(e.target.value)
          );

          this.synthesis.addEventListener("voiceschanged", () =>
            this.loadVoices()
          );
        }

        updateTolerance(tolerance) {
          this.tolerance = parseFloat(tolerance);
          this.toleranceValue.textContent = Math.round(tolerance * 100) + "%";
        }

        saveNamesAndStart() {
          const newTeacherName = this.teacherNameInput.value.trim();
          const newStudentFirstName = this.studentFirstNameInput.value.trim();
          const newStudentLastName = this.studentLastNameInput.value.trim();
          const newStudentCity = this.studentCityInput.value.trim();
          const newStudentCountry = this.studentCountryInput.value.trim();
          const newStudentAddress = this.studentAddressInput.value.trim();
          const newCourseLevel = this.courseLevelInput.value.trim();
          const newSchoolName = this.schoolNameInput.value.trim();
          const selectedRole = this.roleTeacherInput.checked
            ? "teacher"
            : "student";
          const enableGerman = this.enableGermanInput.checked;
          const enableVietnamese = this.enableVietnameseInput.checked;

          if (!enableGerman && !enableVietnamese) {
            this.showStatus(
              "Phải chọn ít nhất một ngôn ngữ nhận diện!",
              "error"
            );
            return;
          }

          if (
            newTeacherName &&
            newStudentFirstName &&
            newStudentLastName &&
            newStudentCity &&
            newStudentCountry &&
            newStudentAddress &&
            newCourseLevel &&
            newSchoolName
          ) {
            this.teacherName = newTeacherName;
            this.studentFirstName = newStudentFirstName;
            this.studentLastName = newStudentLastName;
            this.studentCity = newStudentCity;
            this.studentCountry = newStudentCountry;
            this.studentAddress = newStudentAddress;
            this.courseLevel = newCourseLevel;
            this.schoolName = newSchoolName;
            this.userRole = selectedRole;
            this.enableGerman = enableGerman;
            this.enableVietnamese = enableVietnamese;

            this.generateConversationSequence();
            this.startConversation();

            const languages = [];
            if (enableGerman) languages.push("Tiếng Đức");
            if (enableVietnamese) languages.push("Tiếng Việt");

            this.showStatus(
              `Cuộc hội thoại bắt đầu! Nhận diện: ${languages.join(" + ")}`,
              "success"
            );
          } else {
            this.showStatus("Vui lòng nhập đầy đủ tất cả thông tin!", "error");
          }
        }

        generateConversationSequence() {
          this.conversationSequence = [];

          // Create replacement map
          const replacements = {
            schoolName: this.schoolName,
            teacherName: this.teacherName,
            studentFirstName: this.studentFirstName,
            studentLastName: this.studentLastName,
            studentCity: this.studentCity,
            studentCountry: this.studentCountry,
            studentAddress: this.studentAddress,
            courseLevel: this.courseLevel,
            studentVietnameseName: this.studentFirstName, // For Vietnamese names
            lastLetter: this.studentLastName.slice(-1),
            firstNameLastLetter: this.studentFirstName.slice(-1),
            studentLastNameSpelled: this.studentLastName.split("").join("-"),
            studentFirstNameSpelled: this.studentFirstName.split("").join("-"),
            studentCitySpelled: this.studentCity.split("").join("-"),
            studentCityGerman: this.getGermanCityName(this.studentCity),
            studentFirstNameConfusion: this.getNameConfusion(
              this.studentFirstName
            ),
          };

          // Process each template
          this.conversationTemplate.forEach((template) => {
            const processedItem = {
              speaker: template.speaker,
              text: this.replaceTemplateVars(
                template.textTemplate,
                replacements
              ),
              vietnamese: this.replaceTemplateVars(
                template.vietnamese,
                replacements
              ),
              expectedResponse: this.replaceTemplateVars(
                template.expectedTemplate,
                replacements
              ),
              expectedVietnamese: this.replaceTemplateVars(
                template.expectedVietnamese,
                replacements
              ),
              alternatives: template.alternatives.map((alt) =>
                this.replaceTemplateVars(alt, replacements)
              ),
            };

            this.conversationSequence.push(processedItem);
          });
        }

        replaceTemplateVars(template, replacements) {
          let result = template;
          Object.keys(replacements).forEach((key) => {
            const regex = new RegExp(`\\{${key}\\}`, "g");
            result = result.replace(regex, replacements[key]);
          });
          return result;
        }

        getGermanCityName(city) {
          const cityMap = {
            Hanoi: "Hanoi",
            "Ho Chi Minh": "Ho-Chi-Minh-Stadt",
            "Da Nang": "Da Nang",
            Fribourg: "Freiburg",
            Saigon: "Saigon",
          };
          return cityMap[city] || city;
        }

        getNameConfusion(name) {
          // Generate a similar-sounding name for confusion
          const confusionMap = {
            Marie: "Maria",
            Anna: "Anne",
            Peter: "Petra",
            Michael: "Michaela",
            An: "Ann",
            Linh: "Lin",
            Minh: "Min",
            Duc: "Duck",
            Nguyen: "Ngoyen",
          };
          return confusionMap[name] || name + "a";
        }

        startConversation() {
          this.conversationStarted = true;
          this.currentStep = 0;
          this.conversationHistory = [];
          this.waitingForAI = false;

          this.nameSettings.style.display = "none";
          this.conversationContainer.style.display = "block";

          if (this.userRole === "teacher") {
            this.userRoleDisplay.textContent = this.teacherName;
            this.aiRoleDisplay.textContent = `${this.studentFirstName} ${this.studentLastName}`;
          } else {
            this.userRoleDisplay.textContent = `${this.studentFirstName} ${this.studentLastName}`;
            this.aiRoleDisplay.textContent = this.teacherName;
          }

          this.conversationArea.innerHTML = "";
          this.updateProgress();
          this.updateExpectedResponse();
          this.setupMultilingualRecognition();

          if (!this.isUserTurn()) {
            setTimeout(() => {
              this.playAIResponse();
            }, 1000);
          }
        }

        setupMultilingualRecognition() {
          if (!this.recognition) return;

          // Set primary language based on user preference
          if (this.enableGerman && this.enableVietnamese) {
            this.recognition.lang = "de-DE"; // Default to German
          } else if (this.enableGerman) {
            this.recognition.lang = "de-DE";
          } else if (this.enableVietnamese) {
            this.recognition.lang = "vi-VN";
          }
        }

        startNewConversation() {
          this.conversationStarted = false;
          this.currentStep = 0;
          this.conversationHistory = [];
          this.waitingForAI = false;

          this.nameSettings.style.display = "block";
          this.conversationContainer.style.display = "none";

          this.conversationArea.innerHTML = "";
          this.updateProgress();
          this.showStatus("Có thể cài đặt thông tin mới", "success");
        }

        isUserTurn() {
          if (this.currentStep >= this.conversationSequence.length) {
            return false;
          }

          const currentSequence = this.conversationSequence[this.currentStep];

          if (this.userRole === "student") {
            return currentSequence.speaker === "student";
          } else {
            return currentSequence.speaker === "teacher";
          }
        }

        playAIResponse() {
          if (this.currentStep >= this.conversationSequence.length) {
            return;
          }

          const currentSequence = this.conversationSequence[this.currentStep];

          if (!this.isUserTurn()) {
            this.waitingForAI = true;
            this.addMessage(currentSequence.text, "ai");

            setTimeout(() => {
              this.speakText(currentSequence.text);
            }, 500);

            setTimeout(() => {
              this.currentStep++;
              this.waitingForAI = false;
              this.updateProgress();
              this.updateExpectedResponse();

              if (
                this.currentStep < this.conversationSequence.length &&
                !this.isUserTurn()
              ) {
                this.playAIResponse();
              }
            }, 2000);
          }
        }

        initializeSpeechRecognition() {
          if ("webkitSpeechRecognition" in window) {
            this.recognition = new webkitSpeechRecognition();
          } else if ("SpeechRecognition" in window) {
            this.recognition = new SpeechRecognition();
          } else {
            this.showStatus(
              "Trình duyệt không hỗ trợ nhận diện giọng nói",
              "error"
            );
            return;
          }

          this.recognition.continuous = false;
          this.recognition.interimResults = false;
          this.recognition.lang = "de-DE";

          this.recognition.onstart = () => {
            this.showStatus("Đang nghe...", "listening");
            this.isRecording = true;
            this.micBtn.classList.add("recording");
            this.micBtn.textContent = "🛑 Dừng";
          };

          this.recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            this.processUserInput(transcript);
          };

          this.recognition.onerror = (event) => {
            if (event.error === "no-speech") {
              this.showStatus("Không nghe thấy giọng nói, thử lại", "error");
            } else {
              this.showStatus("Lỗi nhận diện: " + event.error, "error");
            }
            this.stopRecording();
          };

          this.recognition.onend = () => {
            this.stopRecording();
          };
        }

        processUserInput(transcript) {
          this.addMessage(transcript, "user");

          if (this.currentStep >= this.conversationSequence.length) {
            this.addMessage("Cuộc hội thoại đã hoàn thành! 🎉", "success");
            this.showStatus("Cuộc hội thoại đã hoàn thành!", "success");
            return;
          }

          if (!this.isUserTurn()) {
            this.addMessage("❌ Chưa đến lượt bạn nói!", "error");
            return;
          }

          const currentSequence = this.conversationSequence[this.currentStep];
          const expectedText = currentSequence.expectedResponse;
          const alternatives = currentSequence.alternatives;

          // Enhanced multilingual matching
          const matchResult = this.isMultilingualMatch(
            transcript,
            expectedText,
            alternatives
          );

          if (matchResult.isMatch) {
            this.addMessage(
              `✅ Chính xác! (${Math.round(matchResult.accuracy * 100)}%) - ${
                matchResult.matchType
              }`,
              "success"
            );
            this.currentStep++;
            this.updateProgress();
            this.updateExpectedResponse();

            if (this.currentStep >= this.conversationSequence.length) {
              this.addMessage(
                "🎉 Cuộc hội thoại đã hoàn thành! Chúc mừng bạn!",
                "success"
              );
              this.showStatus("Cuộc hội thoại đã hoàn thành!", "success");
              return;
            }

            if (!this.isUserTurn()) {
              setTimeout(() => {
                this.playAIResponse();
              }, 1500);
            }
          } else {
            this.addMessage(
              `❌ Chưa đạt yêu cầu! (${Math.round(
                matchResult.accuracy * 100
              )}% - cần ${Math.round(this.tolerance * 100)}%)<br>
              <strong>Cần nói:</strong> "${expectedText}"<br>
              <strong>Hoặc:</strong> ${alternatives.join(", ")}<br>
              <strong>Bạn đã nói:</strong> "${transcript}"`,
              "error"
            );
            setTimeout(() => {
              this.speakText(expectedText);
            }, 1000);
          }
        }

        isMultilingualMatch(input, expected, alternatives) {
          const normalizedInput = this.normalizeForComparison(input);
          let bestMatch = { accuracy: 0, matchType: "none", isMatch: false };

          // Check against main expected response
          const mainAccuracy = this.calculateAccuracy(
            normalizedInput,
            this.normalizeForComparison(expected)
          );
          if (mainAccuracy > bestMatch.accuracy) {
            bestMatch = {
              accuracy: mainAccuracy,
              matchType: "Chính xác",
              isMatch: mainAccuracy >= this.tolerance,
            };
          }

          // Check against alternatives
          alternatives.forEach((alt, index) => {
            const altAccuracy = this.calculateAccuracy(
              normalizedInput,
              this.normalizeForComparison(alt)
            );
            if (altAccuracy > bestMatch.accuracy) {
              bestMatch = {
                accuracy: altAccuracy,
                matchType: `Cách nói khác (${index + 1})`,
                isMatch: altAccuracy >= this.tolerance,
              };
            }
          });

          // Special handling for Vietnamese names
          if (!bestMatch.isMatch && this.containsVietnameseName(input)) {
            const nameMatch = this.checkVietnameseNameMatch(
              input,
              expected,
              alternatives
            );
            if (nameMatch.accuracy > bestMatch.accuracy) {
              bestMatch = nameMatch;
            }
          }

          return bestMatch;
        }

        containsVietnameseName(input) {
          const vietnameseNames = [this.studentFirstName, this.studentLastName];
          return vietnameseNames.some((name) => input.includes(name));
        }

        checkVietnameseNameMatch(input, expected, alternatives) {
          // More lenient matching for Vietnamese names
          const inputWords = input.toLowerCase().split(/\s+/);
          const expectedWords = expected.toLowerCase().split(/\s+/);

          let matches = 0;
          const totalWords = Math.max(inputWords.length, expectedWords.length);

          // Check if Vietnamese names are present
          if (
            inputWords.some(
              (word) =>
                this.studentFirstName.toLowerCase().includes(word) ||
                this.studentLastName.toLowerCase().includes(word)
            )
          ) {
            matches += 0.7; // Boost for name recognition
          }

          const accuracy = Math.min(matches, 1.0);

          return {
            accuracy: accuracy,
            matchType: "Tên tiếng Việt",
            isMatch: accuracy >= Math.max(0.6, this.tolerance - 0.2), // More lenient for names
          };
        }

        calculateAccuracy(input, expected) {
          if (input === expected) {
            return 1.0;
          }

          // Word-based similarity
          const words1 = input.split(/\s+/).filter((w) => w.length > 0);
          const words2 = expected.split(/\s+/).filter((w) => w.length > 0);

          const maxLength = Math.max(words1.length, words2.length);
          if (maxLength === 0) return 1;

          let exactMatches = 0;
          let partialMatches = 0;
          let usedIndices = new Set();

          // Count exact matches
          for (let i = 0; i < words1.length; i++) {
            for (let j = 0; j < words2.length; j++) {
              if (!usedIndices.has(j) && words1[i] === words2[j]) {
                exactMatches++;
                usedIndices.add(j);
                break;
              }
            }
          }

          // Count partial matches for remaining words
          for (let i = 0; i < words1.length; i++) {
            let matched = false;
            for (let j = 0; j < words2.length; j++) {
              if (!usedIndices.has(j) && words1[i] === words2[j]) {
                matched = true;
                break;
              }
            }

            if (!matched) {
              for (let j = 0; j < words2.length; j++) {
                if (
                  !usedIndices.has(j) &&
                  this.getLevenshteinSimilarity(words1[i], words2[j]) > 0.7
                ) {
                  partialMatches += 0.5;
                  usedIndices.add(j);
                  break;
                }
              }
            }
          }

          return (exactMatches + partialMatches) / maxLength;
        }

        getLevenshteinSimilarity(str1, str2) {
          const distance = this.levenshteinDistance(str1, str2);
          const maxLen = Math.max(str1.length, str2.length);
          return maxLen === 0 ? 1 : 1 - distance / maxLen;
        }

        levenshteinDistance(str1, str2) {
          const matrix = [];
          for (let i = 0; i <= str2.length; i++) {
            matrix[i] = [i];
          }
          for (let j = 0; j <= str1.length; j++) {
            matrix[0][j] = j;
          }
          for (let i = 1; i <= str2.length; i++) {
            for (let j = 1; j <= str1.length; j++) {
              if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
              } else {
                matrix[i][j] = Math.min(
                  matrix[i - 1][j - 1] + 1,
                  matrix[i][j - 1] + 1,
                  matrix[i - 1][j] + 1
                );
              }
            }
          }
          return matrix[str2.length][str1.length];
        }

        normalizeForComparison(text) {
          return text
            .toLowerCase()
            .replace(/[.,!?;:„"„"…]/g, "")
            .replace(/\s+/g, " ")
            .replace(/ä/g, "ae")
            .replace(/ö/g, "oe")
            .replace(/ü/g, "ue")
            .replace(/ß/g, "ss")
            .replace(/à|á|ả|ã|ạ|ă|ằ|ắ|ẳ|ẵ|ặ|â|ầ|ấ|ẩ|ẫ|ậ/g, "a")
            .replace(/è|é|ẻ|ẽ|ẹ|ê|ề|ế|ể|ễ|ệ/g, "e")
            .replace(/ì|í|ỉ|ĩ|ị/g, "i")
            .replace(/ò|ó|ỏ|õ|ọ|ô|ồ|ố|ổ|ỗ|ộ|ơ|ờ|ớ|ở|ỡ|ợ/g, "o")
            .replace(/ù|ú|ủ|ũ|ụ|ư|ừ|ứ|ử|ữ|ự/g, "u")
            .replace(/ỳ|ý|ỷ|ỹ|ỵ/g, "y")
            .replace(/đ/g, "d")
            .trim();
        }

        updateProgress() {
          const progress =
            (this.currentStep / this.conversationSequence.length) * 100;
          this.progressFill.style.width = `${progress}%`;
        }

        updateExpectedResponse() {
          if (this.currentStep >= this.conversationSequence.length) {
            this.expectedResponse.innerHTML = `
              <strong>🎉 Cuộc hội thoại hoàn thành!</strong> 
              Chúc mừng bạn đã hoàn thành bài luyện tập.
            `;
            this.micBtn.disabled = true;
            this.micBtn.textContent = "🎤 Hoàn thành";
            return;
          }

          const currentSequence = this.conversationSequence[this.currentStep];

          if (this.isUserTurn()) {
            const roleText =
              this.userRole === "teacher" ? "Giáo viên" : "Học viên";
            this.expectedResponse.innerHTML = `
              <strong>🎯 Đến lượt bạn (${roleText}) nói:</strong><br>
              <div class="german-text">"${
                currentSequence.expectedResponse
              }"</div>
              <div class="vietnamese-text">📝 Dịch nghĩa: ${
                currentSequence.expectedVietnamese
              }</div>
              <div class="alternatives">💡 Có thể nói: ${currentSequence.alternatives.join(
                ", "
              )}</div>
            `;
            this.expectedResponse.style.display = "block";
            this.micBtn.disabled = false;
            this.micBtn.textContent = "🎤 Nói";
          } else {
            const aiRole =
              this.userRole === "teacher" ? "Học viên" : "Giáo viên";
            this.expectedResponse.innerHTML = `
              <strong>🤖 ${aiRole} (AI) sẽ nói:</strong><br>
              <div class="german-text">"${currentSequence.text}"</div>
              <div class="vietnamese-text">📝 Dịch nghĩa: ${currentSequence.vietnamese}</div>
            `;
            this.expectedResponse.style.display = "block";
            this.micBtn.disabled = true;
            this.micBtn.textContent = "🎤 Chờ AI";
          }
        }

        loadVoices() {
          this.voices = this.synthesis.getVoices();
          this.voiceSelect.innerHTML =
            '<option value="">Chọn giọng nói...</option>';

          const germanVoices = this.voices.filter(
            (voice) =>
              voice.lang.startsWith("de") ||
              voice.name.toLowerCase().includes("german")
          );

          germanVoices.forEach((voice, index) => {
            const option = document.createElement("option");
            option.value = this.voices.indexOf(voice);
            option.textContent = `${voice.name} (${voice.lang})`;
            this.voiceSelect.appendChild(option);
          });

          if (germanVoices.length > 0) {
            this.currentVoice = germanVoices[0];
            this.voiceSelect.value = this.voices.indexOf(germanVoices[0]);
          }
        }

        selectVoice(voiceIndex) {
          if (voiceIndex !== "") {
            this.currentVoice = this.voices[voiceIndex];
          }
        }

        updateSpeed(speed) {
          this.speed = parseFloat(speed);
          this.speedValue.textContent = speed + "x";
        }

        toggleRecording() {
          if (!this.recognition) {
            this.showStatus("Nhận diện giọng nói không khả dụng", "error");
            return;
          }

          if (this.micBtn.disabled) {
            this.showStatus("Chưa đến lượt bạn nói", "error");
            return;
          }

          if (this.isRecording) {
            this.recognition.stop();
          } else {
            // Switch recognition language based on enabled options
            if (this.enableGerman && this.enableVietnamese) {
              // Try German first, then Vietnamese if needed
              this.recognition.lang = "de-DE";
            } else if (this.enableGerman) {
              this.recognition.lang = "de-DE";
            } else if (this.enableVietnamese) {
              this.recognition.lang = "vi-VN";
            }

            this.recognition.start();
          }
        }

        stopRecording() {
          this.isRecording = false;
          this.micBtn.classList.remove("recording");
          this.micBtn.textContent = "🎤 Nói";
          this.showStatus("");
        }

        restartConversation() {
          this.currentStep = 0;
          this.conversationHistory = [];
          this.waitingForAI = false;
          this.conversationArea.innerHTML = "";

          this.updateProgress();
          this.updateExpectedResponse();
          this.showStatus("Cuộc hội thoại đã được khởi động lại", "success");

          if (!this.isUserTurn()) {
            setTimeout(() => {
              this.playAIResponse();
            }, 1000);
          }
        }

        addMessage(text, sender) {
          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${sender}`;

          let speaker = "";
          if (sender === "user") {
            speaker =
              this.userRole === "teacher"
                ? this.teacherName
                : `${this.studentFirstName} ${this.studentLastName}`;
          } else if (sender === "ai") {
            speaker =
              this.userRole === "teacher"
                ? `${this.studentFirstName} ${this.studentLastName}`
                : this.teacherName;
          }

          if (sender === "error" || sender === "success") {
            messageDiv.innerHTML = `<div>${text}</div>`;
          } else {
            messageDiv.innerHTML = `
              <div class="speaker">${speaker}:</div>
              <div>${text}</div>
            `;
          }

          this.conversationArea.appendChild(messageDiv);
          this.conversationArea.scrollTop = this.conversationArea.scrollHeight;

          if (sender !== "error" && sender !== "success") {
            this.conversationHistory.push({
              speaker: speaker,
              text: text,
              timestamp: Date.now(),
            });
          }
        }

        speakText(text) {
          if (!this.synthesis) return;

          this.synthesis.cancel();

          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "de-DE";
          utterance.rate = this.speed;

          if (this.currentVoice) {
            utterance.voice = this.currentVoice;
          }

          utterance.onstart = () => {
            this.showStatus("Đang phát âm...", "speaking");
          };

          utterance.onend = () => {
            this.showStatus("");
          };

          utterance.onerror = (event) => {
            this.showStatus("Lỗi phát âm: " + event.error, "error");
          };

          this.synthesis.speak(utterance);
        }

        repeatLastMessage() {
          if (this.conversationHistory.length === 0) {
            this.showStatus("Chưa có tin nhắn nào để phát lại", "error");
            return;
          }

          const lastMessage =
            this.conversationHistory[this.conversationHistory.length - 1];
          this.speakText(lastMessage.text);
        }

        clearConversation() {
          this.conversationArea.innerHTML = "";
          this.conversationHistory = [];
          this.currentStep = 0;
          this.waitingForAI = false;
          this.updateProgress();
          this.updateExpectedResponse();
          this.showStatus("Cuộc hội thoại đã được xóa", "success");
        }

        showStatus(message, type = "") {
          this.status.textContent = message;
          this.status.className = `status ${type}`;

          if (message && type !== "error" && type !== "success") {
            setTimeout(() => {
              this.status.textContent = "";
              this.status.className = "status";
            }, 3000);
          }

          if (type === "success" || type === "error") {
            setTimeout(() => {
              this.status.textContent = "";
              this.status.className = "status";
            }, 5000);
          }
        }
      }

      // Initialize the app when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        new BilingualGermanConversationAI();
      });
    </script>
  </body>
</html>
