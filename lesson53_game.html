<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🎮 B1 Sprechen Master Game - Luyện thi nói B1 Goethe</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .game-container {
        max-width: 1200px;
        width: 100%;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .game-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
      }

      .game-header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .stats-bar {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
        gap: 15px;
      }

      .stat-item {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px 25px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        flex: 1;
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        margin-top: 5px;
      }

      .game-content {
        padding: 40px;
      }

      .menu-screen,
      .game-screen,
      .results-screen {
        display: none;
      }

      .menu-screen.active,
      .game-screen.active,
      .results-screen.active {
        display: block;
        animation: fadeIn 0.5s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .game-modes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-top: 30px;
      }

      .game-mode-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 30px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s;
        border: 3px solid transparent;
        position: relative;
        overflow: hidden;
      }

      .game-mode-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        opacity: 0;
        transition: opacity 0.3s;
      }

      .game-mode-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        border-color: #667eea;
      }

      .game-mode-card:hover::before {
        opacity: 0.1;
      }

      .game-mode-card > * {
        position: relative;
        z-index: 1;
      }

      .mode-icon {
        font-size: 4em;
        margin-bottom: 15px;
      }

      .mode-title {
        font-size: 1.5em;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
      }

      .mode-desc {
        color: #666;
        line-height: 1.6;
      }

      .mode-difficulty {
        display: flex;
        gap: 5px;
        margin-top: 15px;
      }

      .difficulty-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ddd;
      }

      .difficulty-dot.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .question-card {
        background: #f8f9fa;
        padding: 40px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }

      .question-text {
        font-size: 1.4em;
        color: #333;
        margin-bottom: 30px;
        line-height: 1.8;
      }

      .situation {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
        font-style: italic;
      }

      .options-grid {
        display: grid;
        gap: 15px;
      }

      .option-btn {
        background: white;
        padding: 20px;
        border: 3px solid #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        font-size: 1.1em;
        position: relative;
        overflow: hidden;
      }

      .option-btn:hover {
        border-color: #667eea;
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .option-btn.correct {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-color: #28a745;
        animation: correctPulse 0.5s;
      }

      .option-btn.wrong {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border-color: #dc3545;
        animation: wrongShake 0.5s;
      }

      @keyframes correctPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes wrongShake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }

      .fill-blank-input {
        width: 100%;
        padding: 15px;
        font-size: 1.2em;
        border: 3px solid #e0e0e0;
        border-radius: 10px;
        margin: 20px 0;
        transition: all 0.3s;
      }

      .fill-blank-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
      }

      .sentence-builder {
        min-height: 150px;
        background: white;
        border: 3px solid #667eea;
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: flex-start;
      }

      .word-bank {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
      }

      .draggable-word {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        user-select: none;
        font-weight: 600;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        transition: all 0.3s;
      }

      .draggable-word:hover {
        transform: scale(1.1);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .draggable-word.used {
        opacity: 0.3;
        pointer-events: none;
      }

      .btn {
        padding: 15px 40px;
        font-size: 1.1em;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-3px);
      }

      .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        flex-wrap: wrap;
      }

      .progress-bar {
        width: 100%;
        height: 25px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 30px;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.9em;
      }

      .timer {
        position: absolute;
        top: 30px;
        right: 30px;
        background: rgba(255, 255, 255, 0.3);
        padding: 15px 25px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        font-size: 1.5em;
        font-weight: bold;
      }

      .feedback-box {
        padding: 25px;
        border-radius: 12px;
        margin: 25px 0;
        display: none;
        animation: slideIn 0.5s;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .feedback-box.show {
        display: block;
      }

      .feedback-box.correct {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border: 3px solid #28a745;
      }

      .feedback-box.wrong {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border: 3px solid #dc3545;
      }

      .feedback-title {
        font-size: 1.3em;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .results-summary {
        text-align: center;
        padding: 40px;
      }

      .score-circle {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 30px auto;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
      }

      .score-number {
        font-size: 4em;
        font-weight: bold;
      }

      .score-label {
        font-size: 1.2em;
        margin-top: 10px;
      }

      .performance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .performance-item {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
      }

      .performance-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #667eea;
        margin: 10px 0;
      }

      .achievement-badge {
        display: inline-block;
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        padding: 10px 20px;
        border-radius: 20px;
        margin: 10px;
        font-weight: bold;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      }

      .hint-box {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
        border-left: 5px solid #ff9a56;
      }

      .matching-game {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin: 30px 0;
      }

      .matching-column {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .match-item {
        padding: 20px;
        background: white;
        border: 3px solid #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
      }

      .match-item:hover {
        border-color: #667eea;
        transform: scale(1.05);
      }

      .match-item.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
      }

      .match-item.matched {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-color: #28a745;
        pointer-events: none;
      }

      .combo-counter {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 5em;
        font-weight: bold;
        color: #667eea;
        opacity: 0;
        pointer-events: none;
        z-index: 1000;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
      }

      .combo-counter.show {
        animation: comboAnimation 1s;
      }

      @keyframes comboAnimation {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.5);
        }
        50% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.5);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      @media (max-width: 768px) {
        .game-header h1 {
          font-size: 1.8em;
        }

        .stats-bar {
          flex-direction: column;
        }

        .game-content {
          padding: 20px;
        }

        .game-modes {
          grid-template-columns: 1fr;
        }

        .matching-game {
          grid-template-columns: 1fr;
        }

        .score-circle {
          width: 150px;
          height: 150px;
        }

        .score-number {
          font-size: 3em;
        }
      }
    </style>
  </head>
  <body>
    <div class="combo-counter" id="comboCounter"></div>

    <div class="game-container">
      <div class="game-header">
        <h1>🎮 B1 SPRECHEN MASTER</h1>
        <p>Luyện tập nói tiếng Đức B1 Goethe qua game</p>

        <div class="stats-bar">
          <div class="stat-item">
            <div class="stat-label">🏆 Điểm</div>
            <div class="stat-value" id="totalScore">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">📊 Độ chính xác</div>
            <div class="stat-value" id="accuracy">0%</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">🔥 Streak</div>
            <div class="stat-value" id="streak">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">⭐ Level</div>
            <div class="stat-value" id="level">1</div>
          </div>
        </div>
      </div>

      <div class="game-content">
        <!-- MENU SCREEN -->
        <div class="menu-screen active" id="menuScreen">
          <h2
            style="
              text-align: center;
              color: #333;
              margin-bottom: 30px;
              font-size: 2em;
            "
          >
            Chọn chế độ chơi
          </h2>

          <div class="game-modes">
            <div class="game-mode-card" onclick="startGame('multiple-choice')">
              <div class="mode-icon">🎯</div>
              <div class="mode-title">Trắc nghiệm Redemittel</div>
              <div class="mode-desc">
                Chọn cụm từ đúng trong các tình huống giao tiếp. Luyện Teil 1 &
                3.
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot"></div>
              </div>
            </div>

            <div class="game-mode-card" onclick="startGame('fill-blank')">
              <div class="mode-icon">✍️</div>
              <div class="mode-title">Điền từ vào chỗ trống</div>
              <div class="mode-desc">
                Hoàn thiện câu với từ đúng. Luyện ngữ pháp và từ vựng.
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
              </div>
            </div>

            <div class="game-mode-card" onclick="startGame('sentence-builder')">
              <div class="mode-icon">🧩</div>
              <div class="mode-title">Xếp câu</div>
              <div class="mode-desc">
                Sắp xếp các từ để tạo thành câu đúng. Luyện cấu trúc câu.
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot"></div>
              </div>
            </div>

            <div class="game-mode-card" onclick="startGame('matching')">
              <div class="mode-icon">🔗</div>
              <div class="mode-title">Ghép cặp Deutsch-Việt</div>
              <div class="mode-desc">
                Ghép cụm tiếng Đức với nghĩa tiếng Việt. Luyện từ vựng nhanh.
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot"></div>
                <div class="difficulty-dot"></div>
              </div>
            </div>

            <div
              class="game-mode-card"
              onclick="startGame('situation-response')"
            >
              <div class="mode-icon">💬</div>
              <div class="mode-title">Phản ứng tình huống</div>
              <div class="mode-desc">
                Chọn cách phản ứng phù hợp trong các tình huống thực tế Teil 1.
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
              </div>
            </div>

            <div class="game-mode-card" onclick="startGame('speed-round')">
              <div class="mode-icon">⚡</div>
              <div class="mode-title">Vòng tốc độ</div>
              <div class="mode-desc">
                60 giây để trả lời càng nhiều câu càng tốt. Thử thách tốc độ!
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- GAME SCREEN -->
        <div class="game-screen" id="gameScreen">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill">Câu 1/10</div>
          </div>

          <div id="gameArea"></div>

          <div class="feedback-box" id="feedbackBox">
            <div class="feedback-title" id="feedbackTitle"></div>
            <div id="feedbackText"></div>
          </div>

          <div class="button-group">
            <button
              class="btn btn-primary"
              id="submitBtn"
              onclick="checkAnswer()"
            >
              Kiểm tra
            </button>
            <button
              class="btn btn-secondary"
              id="nextBtn"
              onclick="nextQuestion()"
              style="display: none"
            >
              Câu tiếp theo →
            </button>
            <button class="btn btn-secondary" onclick="returnToMenu()">
              ← Quay lại menu
            </button>
          </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div class="results-screen" id="resultsScreen">
          <div class="results-summary">
            <h2 style="color: #667eea; font-size: 2.5em; margin-bottom: 20px">
              🎉 Hoàn thành!
            </h2>

            <div class="score-circle">
              <div class="score-number" id="finalScore">0</div>
              <div class="score-label">điểm</div>
            </div>

            <div class="performance-grid">
              <div class="performance-item">
                <div>✅ Đúng</div>
                <div class="performance-value" id="correctCount">0</div>
              </div>
              <div class="performance-item">
                <div>❌ Sai</div>
                <div class="performance-value" id="wrongCount">0</div>
              </div>
              <div class="performance-item">
                <div>📊 Độ chính xác</div>
                <div class="performance-value" id="finalAccuracy">0%</div>
              </div>
              <div class="performance-item">
                <div>🔥 Streak tốt nhất</div>
                <div class="performance-value" id="bestStreak">0</div>
              </div>
            </div>

            <div id="achievementsList"></div>

            <div
              id="performanceMessage"
              style="font-size: 1.3em; margin: 30px 0; color: #666"
            ></div>

            <div class="button-group">
              <button class="btn btn-success" onclick="restartGame()">
                🔄 Chơi lại
              </button>
              <button class="btn btn-primary" onclick="returnToMenu()">
                🏠 Về menu
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Game State
      let gameState = {
        mode: "",
        currentQuestion: 0,
        totalQuestions: 10,
        score: 0,
        correct: 0,
        wrong: 0,
        streak: 0,
        bestStreak: 0,
        level: 1,
        timeLeft: 60,
        timerInterval: null,
        selectedAnswer: null,
      };

      // Question Banks - Game data trực tiếp từ tài liệu B1
      const questionBanks = {
        "multiple-choice": [
          {
            question:
              "Partner nói: 'Ich schlage vor, dass wir nach Freiburg fahren.' Bạn muốn ĐỒNG Ý. Nên nói gì?",
            options: [
              "Das ist eine gute Idee! Ich bin einverstanden.",
              "Nein, das finde ich nicht so gut.",
              "Ich habe aber eine Sache nicht verstanden.",
              "Entschuldigung, ich möchte dazu auch etwas sagen.",
            ],
            correct: 0,
            explanation:
              "Đây là cách bày tỏ đồng ý phổ biến nhất trong Teil 1. Dùng 'Das ist eine gute Idee' + 'Ich bin einverstanden' để nhấn mạnh sự đồng ý.",
          },
          {
            question:
              "Trong Teil 2, bạn muốn giới thiệu chủ đề thuyết trình. Nên dùng cụm nào?",
            options: [
              "Was mich betrifft, ich...",
              "Meine Präsentation ist zu dem Thema: ...",
              "In meinem Heimatland...",
              "Hiermit ist meine Präsentation zu Ende.",
            ],
            correct: 1,
            explanation:
              "Đây là cách chuẩn để giới thiệu chủ đề trong phần mở đầu Teil 2. Luôn bắt đầu với 'Meine Präsentation ist zu dem Thema: ...'.",
          },
          {
            question:
              "Partner hỏi ý kiến bạn: 'Was hältst du davon?' Bạn muốn TỪ CHỐI lịch sự. Chọn câu nào?",
            options: [
              "Super! Das finde ich auch toll.",
              "Ja, klar! Ich glaube schon.",
              "Nein, das finde ich nicht so gut, weil...",
              "Gut, das kann ich machen.",
            ],
            correct: 2,
            explanation:
              "Từ chối lịch sự bằng cách dùng 'Nein, das finde ich nicht so gut' và LUÔN đưa ra lý do với 'weil'.",
          },
          {
            question:
              "Trong Teil 3, bạn muốn đặt câu hỏi cho partner. Nên dùng cụm nào?",
            options: [
              "Vielen Dank fürs Zuhören!",
              "Ich hätte gern eine Frage für Sie.",
              "Das ist eine gute Idee!",
              "Mein Vortrag besteht aus folgenden Teilen.",
            ],
            correct: 1,
            explanation:
              "Đây là cách lịch sự để bắt đầu đặt câu hỏi trong Teil 3. Dùng Konjunktiv II 'hätte' để thể hiện sự lịch sự.",
          },
          {
            question:
              "Bạn muốn nói về kinh nghiệm cá nhân trong Teil 2. Cụm nào phù hợp?",
            options: [
              "In meinem Heimatland ist...",
              "Was mich betrifft, ich...",
              "Ein Vorteil ist, dass...",
              "Damit komme ich zum Schluss.",
            ],
            correct: 1,
            explanation:
              "Dùng 'Was mich betrifft' (Về phần tôi) để bắt đầu phần chia sẻ kinh nghiệm cá nhân trong Folie 2.",
          },
          {
            question:
              "Partner đề xuất một ý bạn không thích. Bạn muốn đưa ra ĐỀ XUẤT KHÁC. Nên nói gì?",
            options: [
              "Ich bin damit einverstanden.",
              "Das stimmt! Auch ich bin der Meinung.",
              "Aber ich habe gehört, dass... (đề xuất khác)",
              "Genau, das finde ich auch.",
            ],
            correct: 2,
            explanation:
              "Sau khi từ chối, dùng 'Aber' để đưa ra đề xuất mới. Đây là chiến thuật quan trọng khi partner ở trình độ ngang bằng.",
          },
          {
            question: "Trong Teil 2, bạn muốn nêu ƯU ĐIỂM. Chọn cụm nào?",
            options: [
              "Ein Vorteil ist, dass...",
              "Ein Nachteil ist, dass...",
              "Ich habe einmal Folgendes erlebt:",
              "Liebe Zuhörer!",
            ],
            correct: 0,
            explanation:
              "'Ein Vorteil ist, dass...' là cách chuẩn để nêu ưu điểm trong Folie 4. Sau 'dass' là mệnh đề phụ với động từ cuối câu.",
          },
          {
            question: "Bạn không nghe rõ partner nói gì. Nên hỏi thế nào?",
            options: [
              "Das ist eine gute Idee!",
              "Könnten Sie das bitte wiederholen?",
              "Ich bin einverstanden.",
              "Vielen Dank für Ihre Frage.",
            ],
            correct: 1,
            explanation:
              "Đây là cách lịch sự để nhờ partner nhắc lại. Dùng Konjunktiv II 'könnten' + 'bitte' để thể hiện sự lịch sự.",
          },
          {
            question: "Kết thúc Teil 2, bạn nên nói gì?",
            options: [
              "Zuerst möchte ich über...",
              "Was mich betrifft...",
              "Hiermit ist meine Präsentation zu Ende. Vielen Dank fürs Zuhören!",
              "Ich schlage vor, dass...",
            ],
            correct: 2,
            explanation:
              "Đây là cách kết thúc bài thuyết trình chuyên nghiệp. Luôn cảm ơn người nghe và hỏi 'Haben Sie noch Fragen?'",
          },
          {
            question:
              "Partner phản hồi tích cực về bài của bạn trong Teil 3. Bạn nên đáp lại thế nào?",
            options: [
              "Nein, das stimmt nicht.",
              "Vielen Dank, es freut mich, dass dir/Ihnen meine Präsentation gefallen hat.",
              "Ich habe eine Frage.",
              "Das ist keine gute Idee.",
            ],
            correct: 1,
            explanation:
              "Cảm ơn và bày tỏ vui mừng khi nhận phản hồi tích cực. Thể hiện sự lịch sự và chuyên nghiệp.",
          },
        ],
        "fill-blank": [
          {
            question: "Ich _____ vor, dass wir nach München fahren.",
            answer: "schlage",
            hint: "Động từ 'đề xuất' - chia ngôi ich. (vorschlagen - schlage vor)",
            explanation:
              "Dùng 'schlage vor' (đề xuất) trong Teil 1. Đây là separable verb, 'vor' đứng cuối câu trong mệnh đề chính.",
          },
          {
            question: "Das ist eine gute _____!",
            answer: "Idee",
            hint: "Danh từ nữ (die) nghĩa là 'ý tưởng', viết hoa chữ cái đầu",
            explanation:
              "Cụm 'Das ist eine gute Idee!' dùng để đồng ý. Danh từ trong tiếng Đức luôn viết hoa.",
          },
          {
            question:
              "Meine Präsentation ist zu dem _____: 'Lernen im Internet'.",
            answer: "Thema",
            hint: "Danh từ trung tính (das) nghĩa là 'chủ đề', viết hoa",
            explanation:
              "Dùng 'Thema' để giới thiệu chủ đề thuyết trình trong Teil 2. 'zu dem Thema' = 'về chủ đề'.",
          },
          {
            question: "Was mich _____, ich lerne oft online.",
            answer: "betrifft",
            hint: "Động từ 'liên quan đến' - chia ngôi es (was)",
            explanation:
              "'Was mich betrifft' = 'Về phần tôi' - cụm cố định để mở đầu phần chia sẻ kinh nghiệm trong Teil 2.",
          },
          {
            question: "Ein _____ ist, dass Online-Lernen flexibel ist.",
            answer: "Vorteil",
            hint: "Danh từ nam (der) nghĩa là 'ưu điểm', viết hoa",
            explanation:
              "Dùng 'Vorteil' để nêu ưu điểm trong Teil 2, Folie 4. Tương tự có 'Nachteil' (nhược điểm).",
          },
          {
            question: "Ich bin damit _____.",
            answer: "einverstanden",
            hint: "Tính từ nghĩa là 'đồng ý', không viết hoa",
            explanation:
              "'Ich bin damit einverstanden' = 'Tôi đồng ý với điều đó'. Cấu trúc quan trọng trong Teil 1.",
          },
          {
            question: "In meinem _____ ist die Situation anders.",
            answer: "Heimatland",
            hint: "Danh từ trung tính (das) nghĩa là 'quê hương/tổ quốc', viết hoa",
            explanation:
              "Dùng 'Heimatland' khi nói về tình hình ở quê nhà trong Teil 2, Folie 3.",
          },
          {
            question: "Ich _____ gern eine Frage für Sie.",
            answer: "hätte",
            hint: "Động từ haben ở dạng Konjunktiv II ngôi ich",
            explanation:
              "'Ich hätte gern...' là cách lịch sự để bày tỏ mong muốn. Dùng trong Teil 3 khi đặt câu hỏi.",
          },
          {
            question: "Damit komme ich zum _____ meiner Präsentation.",
            answer: "Schluss",
            hint: "Danh từ nam (der) nghĩa là 'kết thúc', viết hoa",
            explanation:
              "Dùng 'zum Schluss' để kết thúc bài thuyết trình trong Teil 2. 'Schluss' viết hoa vì là danh từ.",
          },
          {
            question: "Könnten Sie das bitte _____?",
            answer: "wiederholen",
            hint: "Động từ nguyên thể nghĩa là 'lặp lại', không tách tiền tố",
            explanation:
              "Nhờ partner nhắc lại khi không nghe rõ. 'wiederholen' không phải separable verb nên giữ nguyên.",
          },
        ],
        "sentence-builder": [
          {
            question: "Sắp xếp các từ thành câu đúng (Đề xuất):",
            words: [
              "Ich",
              "schlage",
              "vor,",
              "dass",
              "wir",
              "nach",
              "Berlin",
              "fahren.",
            ],
            correct: "Ich schlage vor, dass wir nach Berlin fahren.",
            explanation:
              "Cấu trúc đề xuất chuẩn trong Teil 1: 'Ich schlage vor, dass...' + mệnh đề phụ (động từ cuối).",
          },
          {
            question: "Sắp xếp thành câu đúng (Giới thiệu chủ đề):",
            words: [
              "Meine",
              "Präsentation",
              "ist",
              "zu",
              "dem",
              "Thema:",
              "Sport.",
            ],
            correct: "Meine Präsentation ist zu dem Thema: Sport.",
            explanation:
              "Giới thiệu chủ đề trong Teil 2. 'zu dem Thema' có thể viết tắt thành 'zum Thema'.",
          },
          {
            question: "Sắp xếp thành câu đúng (Đồng ý):",
            words: ["Das", "ist", "eine", "gute", "Idee!"],
            correct: "Das ist eine gute Idee!",
            explanation:
              "Bày tỏ đồng ý đơn giản và hiệu quả nhất. Có thể thêm 'Ich bin einverstanden' để nhấn mạnh.",
          },
          {
            question: "Sắp xếp thành câu đúng (Kinh nghiệm):",
            words: [
              "Was",
              "mich",
              "betrifft,",
              "ich",
              "lerne",
              "gern",
              "Deutsch.",
            ],
            correct: "Was mich betrifft, ich lerne gern Deutsch.",
            explanation:
              "Chia sẻ kinh nghiệm cá nhân trong Teil 2, Folie 2. Sau dấu phẩy bắt đầu mệnh đề mới.",
          },
          {
            question: "Sắp xếp thành câu đúng (Ưu điểm):",
            words: [
              "Ein",
              "Vorteil",
              "ist,",
              "dass",
              "man",
              "flexibel",
              "lernen",
              "kann.",
            ],
            correct: "Ein Vorteil ist, dass man flexibel lernen kann.",
            explanation:
              "Nêu ưu điểm với mệnh đề 'dass' - động từ chia (kann) + động từ nguyên thể (lernen) ở cuối.",
          },
          {
            question: "Sắp xếp thành câu đúng (Đặt câu hỏi):",
            words: ["Ich", "hätte", "gern", "eine", "Frage", "für", "Sie."],
            correct: "Ich hätte gern eine Frage für Sie.",
            explanation:
              "Đặt câu hỏi lịch sự trong Teil 3. Konjunktiv II 'hätte' thể hiện sự lịch sự.",
          },
          {
            question: "Sắp xếp thành câu đúng (Tình hình quê nhà):",
            words: [
              "In",
              "meinem",
              "Heimatland",
              "ist",
              "die",
              "Situation",
              "anders.",
            ],
            correct: "In meinem Heimatland ist die Situation anders.",
            explanation:
              "Mô tả tình hình ở quê nhà trong Teil 2, Folie 3. Có thể thay 'anders' bằng 'ähnlich/gleich'.",
          },
          {
            question: "Sắp xếp thành câu đúng (Từ chối):",
            words: ["Nein,", "das", "finde", "ich", "nicht", "so", "gut."],
            correct: "Nein, das finde ich nicht so gut.",
            explanation:
              "Từ chối lịch sự một đề xuất. LUÔN đưa ra lý do sau đó với 'weil...'.",
          },
          {
            question: "Sắp xếp thành câu đúng (Cảm ơn):",
            words: ["Vielen", "Dank", "fürs", "Zuhören!"],
            correct: "Vielen Dank fürs Zuhören!",
            explanation:
              "Cảm ơn người nghe khi kết thúc Teil 2. 'fürs' = 'für das' (dành cho việc).",
          },
          {
            question: "Sắp xếp thành câu đúng (Đồng ý mạnh):",
            words: ["Ich", "bin", "damit", "einverstanden."],
            correct: "Ich bin damit einverstanden.",
            explanation:
              "Thể hiện sự đồng ý rõ ràng. 'damit' = 'với điều đó' (chỉ về đề xuất vừa nghe).",
          },
        ],
        matching: [
          {
            pairs: [
              { de: "Ich schlage vor, dass...", vi: "Tôi đề xuất rằng..." },
              { de: "Das ist eine gute Idee!", vi: "Đó là một ý tưởng hay!" },
              { de: "Was hältst du davon?", vi: "Bạn nghĩ sao về điều đó?" },
              { de: "Ich bin einverstanden.", vi: "Tôi đồng ý." },
              { de: "Was mich betrifft...", vi: "Về phần tôi..." },
            ],
          },
          {
            pairs: [
              { de: "Ein Vorteil ist, dass...", vi: "Một ưu điểm là..." },
              { de: "Ein Nachteil ist, dass...", vi: "Một nhược điểm là..." },
              { de: "In meinem Heimatland...", vi: "Ở quê hương tôi..." },
              { de: "Meiner Meinung nach...", vi: "Theo ý kiến của tôi..." },
              {
                de: "Zum Schluss möchte ich sagen...",
                vi: "Cuối cùng tôi muốn nói...",
              },
            ],
          },
          {
            pairs: [
              { de: "Ich hätte gern eine Frage.", vi: "Tôi muốn hỏi một câu." },
              {
                de: "Vielen Dank für Ihre Frage.",
                vi: "Cảm ơn câu hỏi của bạn.",
              },
              { de: "Das ist interessant.", vi: "Điều đó thật thú vị." },
              {
                de: "Könnten Sie das wiederholen?",
                vi: "Bạn có thể nhắc lại được không?",
              },
              { de: "Ich verstehe nicht ganz.", vi: "Tôi không hiểu hẳn." },
            ],
          },
        ],
        "situation-response": [
          {
            situation:
              "Partner nói: 'Ich schlage vor, dass wir mit dem Zug fahren, weil das umweltfreundlich ist. Was meinst du?'",
            scenario: "Bạn đồng ý và muốn bổ sung thêm lý do",
            options: [
              "Das ist eine gute Idee! Außerdem ist der Zug auch bequemer als das Auto. Wann fahren wir?",
              "Nein, das finde ich nicht so gut. Ich würde lieber mit dem Auto fahren.",
              "Ich weiß nicht. Vielleicht können wir später entscheiden.",
              "Das verstehe ich nicht. Kannst du das wiederholen?",
            ],
            correct: 0,
            explanation:
              "Đồng ý + bổ sung lý do với 'Außerdem' (Hơn nữa) + hỏi tiếp về chi tiết khác. Đây là cách thể hiện sự hợp tác tốt.",
          },
          {
            situation:
              "Partner nói: 'Wir könnten im Hotel übernachten. Das ist am bequemsten.'",
            scenario:
              "Bạn không đồng ý vì khách sạn đắt, muốn đề xuất ở nhà trẻ",
            options: [
              "Ja, das stimmt! Hotels sind immer die beste Option.",
              "Nein, das finde ich nicht so gut, weil Hotels zu teuer sind. Ich schlage vor, dass wir in der Jugendherberge übernachten. Das ist billiger. Was hältst du davon?",
              "Ich bin einverstanden. Das machen wir!",
              "Super! Dann buche ich gleich ein Hotelzimmer.",
            ],
            correct: 1,
            explanation:
              "Từ chối lịch sự + lý do + đề xuất mới + hỏi ý kiến. Đây là cấu trúc 5 câu khi partner ngang bằng.",
          },
          {
            situation:
              "Giám khảo hỏi: 'Warum haben Sie dieses Thema gewählt?' (Tại sao bạn chọn chủ đề này?)",
            scenario: "Teil 3 - Trả lời câu hỏi về bài thuyết trình",
            options: [
              "Ich weiß nicht. Das war nur ein Zufall.",
              "Weil ich das Thema sehr interessant finde und persönliche Erfahrung damit habe. Außerdem ist dieses Thema in meinem Heimatland sehr aktuell.",
              "Das möchte ich nicht sagen.",
              "Können Sie die Frage wiederholen?",
            ],
            correct: 1,
            explanation:
              "Đưa ra lý do cụ thể với 'weil' và liên hệ với kinh nghiệm bản thân. Thêm 'Außerdem' để bổ sung lý do thứ hai.",
          },
          {
            situation:
              "Partner hỏi: 'Was können wir dort machen?' (Chúng ta có thể làm gì ở đó?)",
            scenario: "Teil 1 - Nói về hoạt động",
            options: [
              "Ich weiß es nicht genau.",
              "Wir könnten wandern gehen und die Natur genießen. Außerdem gibt es dort auch interessante Museen. Was meinst du?",
              "Das ist mir egal. Du kannst entscheiden.",
              "Vielleicht nichts Besonderes.",
            ],
            correct: 1,
            explanation:
              "Đưa ra nhiều đề xuất hoạt động với 'Wir könnten...' + 'Außerdem' (Hơn nữa) + hỏi ý kiến partner.",
          },
          {
            situation:
              "Partner không đồng ý: 'Nein, ich finde das nicht so gut.'",
            scenario: "Phản ứng khi partner từ chối đề xuất của bạn",
            options: [
              "Warum nicht? Du musst mir zustimmen!",
              "Okay, das ist kein Problem. Was wäre denn dein Vorschlag?",
              "Das ist dumm. Meine Idee ist besser.",
              "Dann machen wir gar nichts!",
            ],
            correct: 1,
            explanation:
              "Chấp nhận ý kiến với 'Okay, das ist kein Problem' + hỏi đề xuất của partner (thể hiện sự hợp tác và linh hoạt).",
          },
          {
            situation: "Bạn vừa thuyết trình xong Teil 2",
            scenario: "Kết thúc bài thuyết trình",
            options: [
              "Ich gehe jetzt. Auf Wiedersehen!",
              "Hiermit ist meine Präsentation zu Ende. Vielen Dank fürs Zuhören! Haben Sie noch Fragen?",
              "Das war's. Fertig.",
              "Ich habe nichts mehr zu sagen.",
            ],
            correct: 1,
            explanation:
              "Kết thúc chuyên nghiệp: tuyên bố kết thúc + cảm ơn + mở ra cho câu hỏi. Ba yếu tố này PHẢI có.",
          },
        ],
        "speed-round": [
          { q: "Đề xuất: Ich _____ vor, dass...", a: "schlage" },
          { q: "Đồng ý: Das ist eine gute _____!", a: "Idee" },
          { q: "Hỏi ý kiến: Was _____ du davon?", a: "hältst" },
          {
            q: "Giới thiệu chủ đề: Meine Präsentation ist zu dem _____",
            a: "Thema",
          },
          { q: "Ưu điểm: Ein _____ ist, dass...", a: "Vorteil" },
          { q: "Nhược điểm: Ein _____ ist, dass...", a: "Nachteil" },
          { q: "Quê hương: In meinem _____", a: "Heimatland" },
          { q: "Từ chối: Nein, das finde ich nicht so _____", a: "gut" },
          { q: "Ý kiến: Meiner _____ nach...", a: "Meinung" },
          { q: "Kinh nghiệm: Was mich _____", a: "betrifft" },
          { q: "Câu hỏi: Ich _____ gern eine Frage", a: "hätte" },
          { q: "Kết thúc: Vielen Dank fürs _____!", a: "Zuhören" },
          { q: "Đồng ý: Ich bin _____", a: "einverstanden" },
          { q: "Lặp lại: Könnten Sie das _____?", a: "wiederholen" },
          { q: "Kết luận: Zum _____ möchte ich sagen...", a: "Schluss" },
        ],
      };

      // Start Game
      function startGame(mode) {
        gameState.mode = mode;
        gameState.currentQuestion = 0;
        gameState.score = 0;
        gameState.correct = 0;
        gameState.wrong = 0;
        gameState.streak = 0;
        gameState.selectedAnswer = null;

        document.getElementById("menuScreen").classList.remove("active");
        document.getElementById("gameScreen").classList.add("active");

        if (mode === "speed-round") {
          gameState.timeLeft = 60;
          startTimer();
        }

        loadQuestion();
      }

      // Load Question
      function loadQuestion() {
        const mode = gameState.mode;
        const questionIndex = gameState.currentQuestion;
        const gameArea = document.getElementById("gameArea");
        const feedbackBox = document.getElementById("feedbackBox");

        feedbackBox.classList.remove("show");
        document.getElementById("submitBtn").style.display = "block";
        document.getElementById("nextBtn").style.display = "none";
        gameState.selectedAnswer = null;

        // Update progress
        const progress = ((questionIndex + 1) / gameState.totalQuestions) * 100;
        document.getElementById("progressFill").style.width = progress + "%";
        document.getElementById("progressFill").textContent = `Câu ${
          questionIndex + 1
        }/${gameState.totalQuestions}`;

        let html = "";

        if (mode === "multiple-choice") {
          const q = questionBanks[mode][questionIndex];
          html = `
                    <div class="question-card">
                        <div class="question-text">${q.question}</div>
                        <div class="options-grid">
                            ${q.options
                              .map(
                                (opt, i) => `
                                <div class="option-btn" onclick="selectOption(${i})">
                                    ${opt}
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `;
        } else if (mode === "fill-blank") {
          const q = questionBanks[mode][questionIndex];
          html = `
                    <div class="question-card">
                        <div class="question-text">${q.question}</div>
                        <div class="hint-box">💡 Gợi ý: ${q.hint}</div>
                        <input type="text" class="fill-blank-input" id="answerInput" 
                               placeholder="Nhập câu trả lời..." 
                               onkeypress="if(event.key==='Enter') checkAnswer()">
                    </div>
                `;
        } else if (mode === "sentence-builder") {
          const q = questionBanks[mode][questionIndex];
          const shuffled = [...q.words].sort(() => Math.random() - 0.5);
          html = `
                    <div class="question-card">
                        <div class="question-text">${q.question}</div>
                        <div class="sentence-builder" id="sentenceBuilder"></div>
                        <div class="word-bank">
                            ${shuffled
                              .map(
                                (word) => `
                                <div class="draggable-word" onclick="addToSentence(this)">${word}</div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `;
        } else if (mode === "matching") {
          const q =
            questionBanks[mode][
              Math.floor(Math.random() * questionBanks[mode].length)
            ];
          gameState.matchingPairs = q.pairs;
          const shuffledLeft = [...q.pairs].sort(() => Math.random() - 0.5);
          const shuffledRight = [...q.pairs].sort(() => Math.random() - 0.5);

          html = `
                    <div class="question-card">
                        <div class="question-text">Ghép cặp Tiếng Đức - Tiếng Việt</div>
                        <div class="matching-game">
                            <div class="matching-column" id="leftColumn">
                                ${shuffledLeft
                                  .map(
                                    (pair, i) => `
                                    <div class="match-item" data-text="${pair.de}" onclick="selectMatch(this, 'left')">
                                        ${pair.de}
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                            <div class="matching-column" id="rightColumn">
                                ${shuffledRight
                                  .map(
                                    (pair, i) => `
                                    <div class="match-item" data-text="${pair.vi}" onclick="selectMatch(this, 'right')">
                                        ${pair.vi}
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                        </div>
                    </div>
                `;
          gameState.matchingState = {
            selectedLeft: null,
            selectedRight: null,
            matches: 0,
          };
        } else if (mode === "situation-response") {
          const q = questionBanks[mode][questionIndex];
          html = `
                    <div class="question-card">
                        <div class="situation">
                            <strong>🎬 Tình huống:</strong><br>
                            ${q.situation}
                        </div>
                        <div class="hint-box">
                            <strong>📝 Nhiệm vụ:</strong> ${q.scenario}
                        </div>
                        <div class="options-grid">
                            ${q.options
                              .map(
                                (opt, i) => `
                                <div class="option-btn" onclick="selectOption(${i})">
                                    ${opt}
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `;
        } else if (mode === "speed-round") {
          const q =
            questionBanks[mode][questionIndex % questionBanks[mode].length];
          html = `
                    <div class="question-card">
                        <div class="timer">${gameState.timeLeft}s</div>
                        <div class="question-text">${q.q}</div>
                        <input type="text" class="fill-blank-input" id="answerInput" 
                               placeholder="Trả lời nhanh!" 
                               onkeypress="if(event.key==='Enter') checkAnswer()"
                               autofocus>
                    </div>
                `;
        }

        gameArea.innerHTML = html;

        if (mode === "fill-blank" || mode === "speed-round") {
          setTimeout(
            () => document.getElementById("answerInput")?.focus(),
            100
          );
        }
      }

      // Select Option
      function selectOption(index) {
        gameState.selectedAnswer = index;
        document.querySelectorAll(".option-btn").forEach((btn, i) => {
          btn.style.background =
            i === index
              ? "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
              : "white";
          btn.style.color = i === index ? "white" : "#333";
        });
      }

      // Add word to sentence (for sentence builder)
      function addToSentence(wordEl) {
        if (wordEl.classList.contains("used")) return;

        const builder = document.getElementById("sentenceBuilder");
        const clone = wordEl.cloneNode(true);

        clone.onclick = function () {
          wordEl.classList.remove("used");
          this.remove();
        };

        builder.appendChild(clone);
        wordEl.classList.add("used");
      }

      // Matching game functions
      function selectMatch(element, side) {
        if (element.classList.contains("matched")) return;

        const column = side === "left" ? "leftColumn" : "rightColumn";
        document.querySelectorAll(`#${column} .match-item`).forEach((item) => {
          if (!item.classList.contains("matched")) {
            item.classList.remove("selected");
          }
        });

        element.classList.add("selected");

        if (side === "left") {
          gameState.matchingState.selectedLeft = element.dataset.text;
        } else {
          gameState.matchingState.selectedRight = element.dataset.text;
        }

        if (
          gameState.matchingState.selectedLeft &&
          gameState.matchingState.selectedRight
        ) {
          checkMatch();
        }
      }

      function checkMatch() {
        const leftText = gameState.matchingState.selectedLeft;
        const rightText = gameState.matchingState.selectedRight;

        const pair = gameState.matchingPairs.find(
          (p) => p.de === leftText && p.vi === rightText
        );

        const leftEl = document.querySelector(
          `#leftColumn .match-item[data-text="${leftText}"]`
        );
        const rightEl = document.querySelector(
          `#rightColumn .match-item[data-text="${rightText}"]`
        );

        if (pair) {
          leftEl.classList.add("matched");
          rightEl.classList.add("matched");
          leftEl.classList.remove("selected");
          rightEl.classList.remove("selected");

          gameState.matchingState.matches++;
          gameState.score += 10;
          gameState.correct++;
          gameState.streak++;
          updateStats();

          if (gameState.matchingState.matches === 5) {
            setTimeout(() => {
              showFeedback(true, "matching", 0);
              document.getElementById("submitBtn").style.display = "none";
              document.getElementById("nextBtn").style.display = "block";
            }, 500);
          }
        } else {
          leftEl.style.animation = "wrongShake 0.5s";
          rightEl.style.animation = "wrongShake 0.5s";

          setTimeout(() => {
            leftEl.classList.remove("selected");
            rightEl.classList.remove("selected");
            leftEl.style.animation = "";
            rightEl.style.animation = "";
          }, 500);

          gameState.wrong++;
          gameState.streak = 0;
          updateStats();
        }

        gameState.matchingState.selectedLeft = null;
        gameState.matchingState.selectedRight = null;
      }

      // Check Answer
      function checkAnswer() {
        const mode = gameState.mode;
        const questionIndex = gameState.currentQuestion;
        let isCorrect = false;
        let userAnswer = "";

        if (mode === "multiple-choice" || mode === "situation-response") {
          const q = questionBanks[mode][questionIndex];
          isCorrect = gameState.selectedAnswer === q.correct;

          document.querySelectorAll(".option-btn").forEach((btn, i) => {
            if (i === q.correct) {
              btn.classList.add("correct");
            } else if (i === gameState.selectedAnswer && !isCorrect) {
              btn.classList.add("wrong");
            }
            btn.style.pointerEvents = "none";
          });
        } else if (mode === "fill-blank") {
          const q = questionBanks[mode][questionIndex];
          userAnswer = document
            .getElementById("answerInput")
            .value.trim()
            .toLowerCase();
          isCorrect = userAnswer === q.answer.toLowerCase();

          document.getElementById("answerInput").style.borderColor = isCorrect
            ? "#28a745"
            : "#dc3545";
          document.getElementById("answerInput").disabled = true;
        } else if (mode === "speed-round") {
          const q =
            questionBanks[mode][questionIndex % questionBanks[mode].length];
          userAnswer = document
            .getElementById("answerInput")
            .value.trim()
            .toLowerCase();
          isCorrect = userAnswer === q.a.toLowerCase();

          if (isCorrect) {
            gameState.currentQuestion++;
            gameState.score += 10;
            gameState.correct++;
            gameState.streak++;

            if (gameState.streak > gameState.bestStreak) {
              gameState.bestStreak = gameState.streak;
            }

            updateStats();

            if (gameState.timeLeft > 0) {
              loadQuestion();
            } else {
              showResults();
            }
            return;
          } else {
            gameState.wrong++;
            gameState.streak = 0;
            document.getElementById("answerInput").value = "";
            document.getElementById("answerInput").style.borderColor =
              "#dc3545";
            setTimeout(() => {
              document.getElementById("answerInput").style.borderColor =
                "#e0e0e0";
              document.getElementById("answerInput").focus();
            }, 500);
            updateStats();
            return;
          }
        } else if (mode === "sentence-builder") {
          const q = questionBanks[mode][questionIndex];
          const builder = document.getElementById("sentenceBuilder");
          userAnswer = Array.from(builder.children)
            .map((el) => el.textContent)
            .join(" ");
          isCorrect = userAnswer === q.correct;
        } else if (mode === "matching") {
          return; // Matching is handled separately
        }

        // Update score and streak
        if (isCorrect) {
          gameState.score += 10 + gameState.streak * 2;
          gameState.correct++;
          gameState.streak++;

          if (gameState.streak > gameState.bestStreak) {
            gameState.bestStreak = gameState.streak;
          }

          if (gameState.streak >= 3) {
            showCombo(gameState.streak);
          }
        } else {
          gameState.wrong++;
          gameState.streak = 0;
        }

        updateStats();
        showFeedback(isCorrect, mode, questionIndex);

        document.getElementById("submitBtn").style.display = "none";
        document.getElementById("nextBtn").style.display = "block";
      }

      // Show Feedback
      function showFeedback(isCorrect, mode, questionIndex) {
        const feedbackBox = document.getElementById("feedbackBox");
        const feedbackTitle = document.getElementById("feedbackTitle");
        const feedbackText = document.getElementById("feedbackText");

        let explanation = "";

        if (mode === "matching") {
          explanation = "Bạn đã ghép đúng tất cả các cặp!";
        } else if (questionBanks[mode] && questionBanks[mode][questionIndex]) {
          explanation = questionBanks[mode][questionIndex].explanation || "";
        }

        if (isCorrect) {
          feedbackBox.className = "feedback-box correct show";
          feedbackTitle.textContent = "✅ Chính xác!";
          feedbackText.textContent = explanation;
        } else {
          feedbackBox.className = "feedback-box wrong show";
          feedbackTitle.textContent = "❌ Chưa đúng";
          feedbackText.textContent = explanation;
        }
      }

      // Next Question
      function nextQuestion() {
        gameState.currentQuestion++;

        if (gameState.currentQuestion >= gameState.totalQuestions) {
          showResults();
        } else {
          loadQuestion();
        }
      }

      // Show Results
      function showResults() {
        if (gameState.timerInterval) {
          clearInterval(gameState.timerInterval);
        }

        document.getElementById("gameScreen").classList.remove("active");
        document.getElementById("resultsScreen").classList.add("active");

        const total = gameState.correct + gameState.wrong;
        const accuracy =
          total > 0 ? Math.round((gameState.correct / total) * 100) : 0;

        document.getElementById("finalScore").textContent = gameState.score;
        document.getElementById("correctCount").textContent = gameState.correct;
        document.getElementById("wrongCount").textContent = gameState.wrong;
        document.getElementById("finalAccuracy").textContent = accuracy + "%";
        document.getElementById("bestStreak").textContent =
          gameState.bestStreak;

        // Performance message
        let message = "";
        let achievements = "";

        if (accuracy >= 90) {
          message = "🌟 Xuất sắc! Bạn đã thành thạo Redemittel!";
          achievements +=
            '<span class="achievement-badge">🏆 Bậc Thầy B1</span>';
        } else if (accuracy >= 75) {
          message = "👍 Rất tốt! Tiếp tục luyện tập!";
          achievements +=
            '<span class="achievement-badge">⭐ Học Viên Giỏi</span>';
        } else if (accuracy >= 60) {
          message = "💪 Khá tốt! Hãy ôn lại một số phần.";
          achievements +=
            '<span class="achievement-badge">📚 Học Viên Chăm Chỉ</span>';
        } else {
          message = "📖 Cần cố gắng thêm! Đừng bỏ cuộc!";
        }

        if (gameState.bestStreak >= 5) {
          achievements +=
            '<span class="achievement-badge">🔥 Streak Master</span>';
        }

        if (gameState.score >= 150) {
          achievements += '<span class="achievement-badge">💯 Điểm Cao</span>';
        }

        document.getElementById("performanceMessage").textContent = message;
        document.getElementById("achievementsList").innerHTML = achievements;
      }

      // Update Stats
      function updateStats() {
        const total = gameState.correct + gameState.wrong;
        const accuracy =
          total > 0 ? Math.round((gameState.correct / total) * 100) : 0;

        document.getElementById("totalScore").textContent = gameState.score;
        document.getElementById("accuracy").textContent = accuracy + "%";
        document.getElementById("streak").textContent = gameState.streak;

        // Calculate level based on score
        gameState.level = Math.floor(gameState.score / 50) + 1;
        document.getElementById("level").textContent = gameState.level;
      }

      // Show Combo
      function showCombo(streak) {
        const comboCounter = document.getElementById("comboCounter");
        comboCounter.textContent = `🔥 ${streak}x COMBO!`;
        comboCounter.classList.add("show");

        setTimeout(() => {
          comboCounter.classList.remove("show");
        }, 1000);
      }

      // Timer for Speed Round
      function startTimer() {
        gameState.timerInterval = setInterval(() => {
          gameState.timeLeft--;

          const timerEl = document.querySelector(".timer");
          if (timerEl) {
            timerEl.textContent = gameState.timeLeft + "s";

            if (gameState.timeLeft <= 10) {
              timerEl.style.background =
                "linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)";
            }
          }

          if (gameState.timeLeft <= 0) {
            clearInterval(gameState.timerInterval);
            showResults();
          }
        }, 1000);
      }

      // Return to Menu
      function returnToMenu() {
        if (gameState.timerInterval) {
          clearInterval(gameState.timerInterval);
        }

        document
          .querySelectorAll(".menu-screen, .game-screen, .results-screen")
          .forEach((screen) => {
            screen.classList.remove("active");
          });

        document.getElementById("menuScreen").classList.add("active");
      }

      // Restart Game
      function restartGame() {
        startGame(gameState.mode);
      }

      // Initialize
      updateStats();
    </script>
  </body>
</html>
