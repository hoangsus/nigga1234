<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🎮 B1 Sprechen Master Game - PRO Edition</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .game-container {
        max-width: 1400px;
        width: 100%;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .game-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
      }

      .game-header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .stats-bar {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
        gap: 15px;
        flex-wrap: wrap;
      }

      .stat-item {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px 25px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        flex: 1;
        min-width: 120px;
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        margin-top: 5px;
      }

      .game-content {
        padding: 40px;
      }

      .menu-screen,
      .game-screen,
      .results-screen {
        display: none;
      }

      .menu-screen.active,
      .game-screen.active,
      .results-screen.active {
        display: block;
        animation: fadeIn 0.5s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .game-modes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-top: 30px;
      }

      .game-mode-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 30px;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s;
        border: 3px solid transparent;
        position: relative;
        overflow: hidden;
      }

      .game-mode-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        opacity: 0;
        transition: opacity 0.3s;
      }

      .game-mode-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        border-color: #667eea;
      }

      .game-mode-card:hover::before {
        opacity: 0.1;
      }

      .game-mode-card > * {
        position: relative;
        z-index: 1;
      }

      .mode-icon {
        font-size: 4em;
        margin-bottom: 15px;
      }

      .mode-title {
        font-size: 1.5em;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
      }

      .mode-desc {
        color: #666;
        line-height: 1.6;
        margin-bottom: 15px;
      }

      .mode-stats {
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
        color: #555;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid rgba(0, 0, 0, 0.1);
      }

      .mode-difficulty {
        display: flex;
        gap: 5px;
        margin-top: 15px;
      }

      .difficulty-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ddd;
      }

      .difficulty-dot.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .question-card {
        background: #f8f9fa;
        padding: 40px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .question-timer {
        position: absolute;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 1.3em;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        animation: timerPulse 1s infinite;
      }

      @keyframes timerPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .question-timer.warning {
        animation: timerWarning 0.5s infinite;
      }

      @keyframes timerWarning {
        0%,
        100% {
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }
        50% {
          background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
      }

      .dialogue-box {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 25px;
        border-left: 5px solid #2196f3;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      .dialogue-turn {
        margin: 15px 0;
        padding: 15px;
        background: white;
        border-radius: 10px;
        position: relative;
        padding-left: 60px;
      }

      .speaker-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 2em;
      }

      .speaker-name {
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
      }

      .dialogue-text {
        color: #333;
        line-height: 1.6;
      }

      .your-turn {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 3px solid #ffc107;
        animation: highlightTurn 2s infinite;
      }

      @keyframes highlightTurn {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
        }
        50% {
          box-shadow: 0 0 20px 5px rgba(255, 193, 7, 0.6);
        }
      }

      .question-text {
        font-size: 1.4em;
        color: #333;
        margin-bottom: 30px;
        line-height: 1.8;
      }

      .situation {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
        font-style: italic;
      }

      .context-box {
        background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 5px solid #28a745;
      }

      .options-grid {
        display: grid;
        gap: 15px;
      }

      .option-btn {
        background: white;
        padding: 20px;
        border: 3px solid #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        font-size: 1.1em;
        position: relative;
        overflow: hidden;
      }

      .option-btn:hover:not(.correct):not(.wrong) {
        border-color: #667eea;
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .option-btn.correct {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border-color: #28a745;
        animation: correctPulse 0.5s;
      }

      .option-btn.wrong {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border-color: #dc3545;
        animation: wrongShake 0.5s;
      }

      @keyframes correctPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes wrongShake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }

      .fill-blank-input {
        width: 100%;
        padding: 15px;
        font-size: 1.2em;
        border: 3px solid #e0e0e0;
        border-radius: 10px;
        margin: 20px 0;
        transition: all 0.3s;
      }

      .fill-blank-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
      }

      .sentence-builder {
        min-height: 150px;
        background: white;
        border: 3px solid #667eea;
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: flex-start;
      }

      .word-bank {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
      }

      .draggable-word {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        user-select: none;
        font-weight: 600;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        transition: all 0.3s;
      }

      .draggable-word:hover {
        transform: scale(1.1);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .draggable-word.used {
        opacity: 0.3;
        pointer-events: none;
      }

      .btn {
        padding: 15px 40px;
        font-size: 1.1em;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-3px);
      }

      .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .button-group {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
        flex-wrap: wrap;
      }

      .progress-bar {
        width: 100%;
        height: 25px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 30px;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.9em;
      }

      .feedback-box {
        padding: 25px;
        border-radius: 12px;
        margin: 25px 0;
        display: none;
        animation: slideIn 0.5s;
      }

      @keyframes slideIn {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .feedback-box.show {
        display: block;
      }

      .feedback-box.correct {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border: 3px solid #28a745;
      }

      .feedback-box.wrong {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border: 3px solid #dc3545;
      }

      .feedback-title {
        font-size: 1.3em;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .results-summary {
        text-align: center;
        padding: 40px;
      }

      .score-circle {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 30px auto;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
      }

      .score-number {
        font-size: 4em;
        font-weight: bold;
      }

      .score-label {
        font-size: 1.2em;
        margin-top: 10px;
      }

      .performance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .performance-item {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
      }

      .performance-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #667eea;
        margin: 10px 0;
      }

      .achievement-badge {
        display: inline-block;
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        padding: 10px 20px;
        border-radius: 20px;
        margin: 10px;
        font-weight: bold;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      }

      .hint-box {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
        border-left: 5px solid #ff9a56;
      }

      .matching-game {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin: 30px 0;
      }

      .matching-column {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .match-item {
        padding: 20px;
        background: white;
        border: 3px solid #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
      }

      .match-item:hover {
        border-color: #667eea;
        transform: scale(1.05);
      }

      .match-item.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
      }

      .match-item.matched {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-color: #28a745;
        pointer-events: none;
      }

      .combo-counter {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 5em;
        font-weight: bold;
        color: #667eea;
        opacity: 0;
        pointer-events: none;
        z-index: 1000;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
      }

      .combo-counter.show {
        animation: comboAnimation 1s;
      }

      @keyframes comboAnimation {
        0% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.5);
        }
        50% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1.5);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -50%) scale(1);
        }
      }

      @media (max-width: 768px) {
        .game-header h1 {
          font-size: 1.8em;
        }

        .stats-bar {
          flex-direction: column;
        }

        .game-content {
          padding: 20px;
        }

        .game-modes {
          grid-template-columns: 1fr;
        }

        .matching-game {
          grid-template-columns: 1fr;
        }

        .score-circle {
          width: 150px;
          height: 150px;
        }

        .score-number {
          font-size: 3em;
        }

        .question-timer {
          position: static;
          margin-bottom: 20px;
          display: inline-block;
        }
      }
    </style>
  </head>
  <body>
    <div class="combo-counter" id="comboCounter"></div>

    <div class="game-container">
      <div class="game-header">
        <h1>🎮 B1 SPRECHEN MASTER - PRO</h1>
        <p>Luyện tập nói tiếng Đức B1 Goethe qua game | 200+ câu hỏi</p>

        <div class="stats-bar">
          <div class="stat-item">
            <div class="stat-label">🏆 Điểm</div>
            <div class="stat-value" id="totalScore">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">📊 Độ chính xác</div>
            <div class="stat-value" id="accuracy">0%</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">🔥 Streak</div>
            <div class="stat-value" id="streak">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">⏱️ Thời gian TB</div>
            <div class="stat-value" id="avgTime">0s</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">⭐ Level</div>
            <div class="stat-value" id="level">1</div>
          </div>
        </div>
      </div>

      <div class="game-content">
        <!-- MENU SCREEN -->
        <div class="menu-screen active" id="menuScreen">
          <h2
            style="
              text-align: center;
              color: #333;
              margin-bottom: 30px;
              font-size: 2em;
            "
          >
            Chọn chế độ chơi
          </h2>

          <div class="game-modes">
            <div
              class="game-mode-card"
              onclick="startGame('dialogue-practice')"
            >
              <div class="mode-icon">🗣️</div>
              <div class="mode-title">Luyện Hội thoại</div>
              <div class="mode-desc">
                Thực hành hội thoại hoàn chỉnh như thi thật. Bám sát kịch bản
                Teil 1!
              </div>
              <div class="mode-stats">
                <span>📝 50 câu</span>
                <span>⏱️ 30s/câu</span>
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
              </div>
            </div>

            <div class="game-mode-card" onclick="startGame('multiple-choice')">
              <div class="mode-icon">🎯</div>
              <div class="mode-title">Trắc nghiệm Redemittel</div>
              <div class="mode-desc">
                Chọn cụm từ đúng trong các tình huống. Luyện Teil 1, 2 & 3.
              </div>
              <div class="mode-stats">
                <span>📝 40 câu</span>
                <span>⏱️ 20s/câu</span>
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot"></div>
              </div>
            </div>

            <div class="game-mode-card" onclick="startGame('fill-blank')">
              <div class="mode-icon">✍️</div>
              <div class="mode-title">Điền từ vào chỗ trống</div>
              <div class="mode-desc">
                Hoàn thiện câu với từ đúng. Test từ vựng chính xác!
              </div>
              <div class="mode-stats">
                <span>📝 30 câu</span>
                <span>⏱️ 15s/câu</span>
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
              </div>
            </div>

            <div class="game-mode-card" onclick="startGame('sentence-builder')">
              <div class="mode-icon">🧩</div>
              <div class="mode-title">Xếp câu</div>
              <div class="mode-desc">
                Sắp xếp các từ thành câu đúng. Luyện cấu trúc!
              </div>
              <div class="mode-stats">
                <span>📝 30 câu</span>
                <span>⏱️ 25s/câu</span>
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot"></div>
              </div>
            </div>

            <div class="game-mode-card" onclick="startGame('matching')">
              <div class="mode-icon">🔗</div>
              <div class="mode-title">Ghép cặp Nhanh</div>
              <div class="mode-desc">
                Ghép Deutsch-Việt với thời gian áp lực. Tốc độ là chìa khóa!
              </div>
              <div class="mode-stats">
                <span>📝 20 vòng</span>
                <span>⏱️ 40s/vòng</span>
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot"></div>
                <div class="difficulty-dot"></div>
              </div>
            </div>

            <div
              class="game-mode-card"
              onclick="startGame('situation-response')"
            >
              <div class="mode-icon">💬</div>
              <div class="mode-title">Phản ứng Tình huống</div>
              <div class="mode-desc">
                Chọn phản ứng đúng trong tình huống thực tế Teil 1.
              </div>
              <div class="mode-stats">
                <span>📝 30 câu</span>
                <span>⏱️ 25s/câu</span>
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
              </div>
            </div>

            <div class="game-mode-card" onclick="startGame('speed-round')">
              <div class="mode-icon">⚡</div>
              <div class="mode-title">Vòng Tốc Độ</div>
              <div class="mode-desc">
                60 giây - trả lời nhiều nhất có thể. Siêu căng thẳng!
              </div>
              <div class="mode-stats">
                <span>📝 Không giới hạn</span>
                <span>⏱️ 60s total</span>
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
              </div>
            </div>

            <div class="game-mode-card" onclick="startGame('teil2-practice')">
              <div class="mode-icon">📊</div>
              <div class="mode-title">Thực hành Teil 2</div>
              <div class="mode-desc">
                Luyện cấu trúc bài thuyết trình từng phần. Chuẩn chỉnh!
              </div>
              <div class="mode-stats">
                <span>📝 25 câu</span>
                <span>⏱️ 20s/câu</span>
              </div>
              <div class="mode-difficulty">
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot active"></div>
                <div class="difficulty-dot"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- GAME SCREEN -->
        <div class="game-screen" id="gameScreen">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill">Câu 1/10</div>
          </div>

          <div id="gameArea"></div>

          <div class="feedback-box" id="feedbackBox">
            <div class="feedback-title" id="feedbackTitle"></div>
            <div id="feedbackText"></div>
          </div>

          <div class="button-group">
            <button
              class="btn btn-primary"
              id="submitBtn"
              onclick="checkAnswer()"
            >
              Kiểm tra
            </button>
            <button
              class="btn btn-secondary"
              id="nextBtn"
              onclick="nextQuestion()"
              style="display: none"
            >
              Câu tiếp theo →
            </button>
            <button class="btn btn-secondary" onclick="returnToMenu()">
              ← Quay lại menu
            </button>
          </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div class="results-screen" id="resultsScreen">
          <div class="results-summary">
            <h2 style="color: #667eea; font-size: 2.5em; margin-bottom: 20px">
              🎉 Hoàn thành!
            </h2>

            <div class="score-circle">
              <div class="score-number" id="finalScore">0</div>
              <div class="score-label">điểm</div>
            </div>

            <div class="performance-grid">
              <div class="performance-item">
                <div>✅ Đúng</div>
                <div class="performance-value" id="correctCount">0</div>
              </div>
              <div class="performance-item">
                <div>❌ Sai</div>
                <div class="performance-value" id="wrongCount">0</div>
              </div>
              <div class="performance-item">
                <div>📊 Độ chính xác</div>
                <div class="performance-value" id="finalAccuracy">0%</div>
              </div>
              <div class="performance-item">
                <div>🔥 Streak tốt nhất</div>
                <div class="performance-value" id="bestStreak">0</div>
              </div>
              <div class="performance-item">
                <div>⏱️ Thời gian TB</div>
                <div class="performance-value" id="finalAvgTime">0s</div>
              </div>
            </div>

            <div id="achievementsList"></div>

            <div
              id="performanceMessage"
              style="font-size: 1.3em; margin: 30px 0; color: #666"
            ></div>

            <div class="button-group">
              <button class="btn btn-success" onclick="restartGame()">
                🔄 Chơi lại
              </button>
              <button class="btn btn-primary" onclick="returnToMenu()">
                🏠 Về menu
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Game State
      let gameState = {
        mode: "",
        currentQuestion: 0,
        totalQuestions: 10,
        score: 0,
        correct: 0,
        wrong: 0,
        streak: 0,
        bestStreak: 0,
        level: 1,
        timeLeft: 0,
        timerInterval: null,
        questionTimer: null,
        selectedAnswer: null,
        questionStartTime: 0,
        totalTime: 0,
        questionTimes: [],
      };

      // EXPANDED Question Banks - 200+ questions
      const questionBanks = {
        "dialogue-practice": [
          {
            context: "Chủ đề: Lên kế hoạch chuyến đi cuối tuần đến Schwarzwald",
            dialogue: [
              {
                speaker: "Partner",
                icon: "👤",
                text: "Weißt du was? Wir haben am Wochenende frei. Ich habe gehört, dass es im Schwarzwald viel zu sehen gibt.",
              },
            ],
            question: "Bạn muốn ĐỒNG Ý và đề xuất đi Freiburg. Nên nói gì?",
            options: [
              "Das ist eine gute Idee! Ich schlage vor, dass wir nach Freiburg fahren, weil es dort sehr schön ist. Was hältst du davon?",
              "Nein, das finde ich nicht so gut. Ich möchte lieber zu Hause bleiben.",
              "Vielleicht. Ich weiß noch nicht genau.",
              "Das ist mir egal. Du kannst entscheiden.",
            ],
            correct: 0,
            timeLimit: 30,
            explanation:
              "Cấu trúc hoàn chỉnh: Đồng ý (Das ist eine gute Idee!) + Đề xuất (Ich schlage vor, dass...) + Lý do (weil...) + Hỏi ý kiến (Was hältst du davon?)",
          },
          {
            context: "Tiếp tục hội thoại về chuyến đi Schwarzwald",
            dialogue: [
              {
                speaker: "Bạn",
                icon: "🎯",
                text: "Das ist eine gute Idee! Ich schlage vor, dass wir nach Freiburg fahren.",
              },
              {
                speaker: "Partner",
                icon: "👤",
                text: "Super! Und wann genau? Am Freitag oder am Samstag?",
              },
            ],
            question: "Bạn muốn đề xuất đi vào thứ Sáu. Nên nói gì?",
            options: [
              "Ich finde, am Freitag ist besser, weil wir dann mehr Zeit haben. Am Samstag können wir den ganzen Tag dort verbringen. Was meinst du?",
              "Ich weiß nicht. Kannst du entscheiden?",
              "Beides ist okay für mich.",
              "Das ist eine schwierige Frage.",
            ],
            correct: 0,
            timeLimit: 30,
            explanation:
              "Đưa ra lựa chọn cụ thể + giải thích lý do + hỏi ý kiến partner để duy trì tính tương tác.",
          },
          {
            context: "Thảo luận về phương tiện di chuyển",
            dialogue: [
              {
                speaker: "Partner",
                icon: "👤",
                text: "Und wie fahren wir dorthin? Mit dem Auto oder mit dem Zug?",
              },
            ],
            question:
              "Bạn muốn đề xuất đi bằng tàu vì thân thiện môi trường. Nên nói gì?",
            options: [
              "Ich schlage vor, dass wir mit dem Zug fahren, weil das umweltfreundlich ist. Außerdem ist der Zug auch bequemer. Was hältst du davon?",
              "Mit dem Auto ist schneller.",
              "Ich weiß nicht, welches besser ist.",
              "Können wir zu Fuß gehen?",
            ],
            correct: 0,
            timeLimit: 30,
            explanation:
              "Đề xuất + 2 lý do (weil... + Außerdem...) + hỏi ý kiến. Thêm 'Außerdem' để bổ sung lý do thứ hai.",
          },
          {
            context: "Partner không đồng ý với đề xuất của bạn",
            dialogue: [
              {
                speaker: "Bạn",
                icon: "🎯",
                text: "Ich schlage vor, dass wir mit dem Zug fahren.",
              },
              {
                speaker: "Partner",
                icon: "👤",
                text: "Nein, das finde ich nicht so gut, weil der Zug zu teuer ist.",
              },
            ],
            question: "Bạn chấp nhận và hỏi đề xuất của partner. Nên nói gì?",
            options: [
              "Okay, das ist kein Problem. Was wäre denn dein Vorschlag? Wie möchtest du fahren?",
              "Aber der Zug ist die beste Option!",
              "Du hast Unrecht. Der Zug ist gut.",
              "Dann gehen wir nicht.",
            ],
            correct: 0,
            timeLimit: 30,
            explanation:
              "Thể hiện sự linh hoạt bằng 'Okay, das ist kein Problem' và hỏi đề xuất mới của partner.",
          },
          {
            context: "Thảo luận về nơi ở",
            dialogue: [
              {
                speaker: "Partner",
                icon: "👤",
                text: "Wir müssen auch überlegen, wo wir übernachten. Was meinst du?",
              },
            ],
            question: "Bạn đề xuất ở nhà trẻ vì rẻ. Nên nói gì?",
            options: [
              "Ich schlage vor, dass wir in der Jugendherberge übernachten, weil das am billigsten ist. Außerdem können wir dort andere Reisende kennenlernen. Bist du einverstanden?",
              "Lass uns im Hotel bleiben.",
              "Wir können bei Freunden wohnen.",
              "Ich habe keine Meinung dazu.",
            ],
            correct: 0,
            timeLimit: 30,
            explanation:
              "Đề xuất cụ thể + lý do chính (billig) + lý do phụ (Leute kennenlernen) + xác nhận đồng ý.",
          },
          // Thêm 45 dialogue situations khác...
          {
            context: "Thảo luận về hoạt động tại Schwarzwald",
            dialogue: [
              {
                speaker: "Partner",
                icon: "👤",
                text: "Was können wir dort machen? Hast du Ideen?",
              },
            ],
            question:
              "Bạn đề xuất đi bộ đường dài và tham quan bảo tàng. Nên nói gì?",
            options: [
              "Wir könnten wandern gehen und die Natur genießen. Außerdem gibt es dort auch interessante Museen. Was findest du interessant?",
              "Ich weiß nicht, was wir machen können.",
              "Lass uns nur im Hotel bleiben.",
              "Vielleicht können wir schlafen.",
            ],
            correct: 0,
            timeLimit: 30,
            explanation:
              "Dùng 'Wir könnten...' (chúng ta có thể) để đưa ra nhiều gợi ý và hỏi sở thích của partner.",
          },
          {
            context: "Partner đề xuất hoạt động bạn không thích",
            dialogue: [
              {
                speaker: "Partner",
                icon: "👤",
                text: "Ich finde, wir sollten Mountainbike fahren. Das macht viel Spaß!",
              },
            ],
            question:
              "Bạn từ chối lịch sự và đề xuất hoạt động khác. Nên nói gì?",
            options: [
              "Nein, das finde ich nicht so gut, weil ich kein Mountainbike fahren kann. Aber wir könnten eine Schifffahrt auf dem Rhein machen. Was hältst du davon?",
              "Mountainbike ist langweilig.",
              "Ich mag keine Sportarten.",
              "Okay, wenn du willst.",
            ],
            correct: 0,
            timeLimit: 30,
            explanation:
              "Từ chối + lý do cá nhân + đề xuất thay thế với 'Aber' + hỏi ý kiến.",
          },
          {
            context: "Thảo luận về đồ cần mang theo",
            dialogue: [
              {
                speaker: "Partner",
                icon: "👤",
                text: "Was müssen wir mitnehmen? Hast du schon eine Liste?",
              },
            ],
            question:
              "Bạn đề xuất mang theo quần áo ấm và máy ảnh. Nên nói gì?",
            options: [
              "Ich denke, wir sollten warme Kleidung mitnehmen, weil es im Schwarzwald kalt sein kann. Und natürlich auch eine Kamera für Fotos. Was möchtest du noch mitnehmen?",
              "Wir brauchen nichts.",
              "Das weiß ich nicht.",
              "Du kannst alles organisieren.",
            ],
            correct: 0,
            timeLimit: 30,
            explanation:
              "Đưa ra danh sách cụ thể với lý do và hỏi thêm ý kiến của partner về đồ cần thiết khác.",
          },
          {
            context: "Xin phép bố mẹ",
            dialogue: [
              {
                speaker: "Partner",
                icon: "👤",
                text: "Glaubst du, deine Eltern erlauben dir die Reise?",
              },
            ],
            question: "Bạn nghĩ bố mẹ sẽ đồng ý. Nên nói gì?",
            options: [
              "Ich glaube, dass sie nichts dagegen haben. Normalerweise erlauben sie mir alles, was ich mit Freunden unternehme. Soll meine Mutter mit deiner Mutter reden?",
              "Meine Eltern sind nicht wichtig.",
              "Ich werde nicht fragen.",
              "Das geht dich nichts an.",
            ],
            correct: 0,
            timeLimit: 30,
            explanation:
              "Thể hiện sự tự tin nhưng vẫn đề nghị hỗ trợ nếu cần. Dùng 'Soll...?' để đưa ra đề nghị giúp đỡ.",
          },
          {
            context: "Kết thúc cuộc thảo luận",
            dialogue: [
              {
                speaker: "Partner",
                icon: "👤",
                text: "Ich glaube, wir haben jetzt über alles gesprochen, oder?",
              },
            ],
            question: "Bạn đồng ý và tổng kết. Nên nói gì?",
            options: [
              "Ja, ich glaube auch. Wir fahren also am Freitag mit dem Zug nach Freiburg und übernachten in der Jugendherberge. Das wird sicher toll!",
              "Ja, lass uns aufhören zu reden.",
              "Ich weiß nicht mehr, was wir besprochen haben.",
              "Können wir von vorne anfangen?",
            ],
            correct: 0,
            timeLimit: 30,
            explanation:
              "Tổng kết ngắn gọn các quyết định chính và kết thúc tích cực. Thể hiện sự hào hứng với 'Das wird toll!'",
          },
        ],
        "multiple-choice": [
          // 40 câu trắc nghiệm đa dạng
          {
            question:
              "Partner nói: 'Ich schlage vor, dass wir nach Freiburg fahren.' Bạn muốn ĐỒNG Ý. Nên nói gì?",
            options: [
              "Das ist eine gute Idee! Ich bin einverstanden.",
              "Nein, das finde ich nicht so gut.",
              "Ich habe aber eine Sache nicht verstanden.",
              "Entschuldigung, ich möchte dazu auch etwas sagen.",
            ],
            correct: 0,
            timeLimit: 20,
            explanation:
              "Đồng ý bằng 'Das ist eine gute Idee!' + 'Ich bin einverstanden' để nhấn mạnh.",
          },
          {
            question:
              "Trong Teil 2, bạn muốn giới thiệu chủ đề thuyết trình. Nên dùng cụm nào?",
            options: [
              "Was mich betrifft, ich...",
              "Meine Präsentation ist zu dem Thema: ...",
              "In meinem Heimatland...",
              "Hiermit ist meine Präsentation zu Ende.",
            ],
            correct: 1,
            timeLimit: 20,
            explanation:
              "Giới thiệu chủ đề với 'Meine Präsentation ist zu dem Thema: ...' hoặc 'zum Thema'.",
          },
          {
            question:
              "Partner hỏi: 'Was hältst du davon?' Bạn muốn TỪ CHỐI lịch sự. Chọn câu nào?",
            options: [
              "Super! Das finde ich auch toll.",
              "Ja, klar! Ich glaube schon.",
              "Nein, das finde ich nicht so gut, weil...",
              "Gut, das kann ich machen.",
            ],
            correct: 2,
            timeLimit: 20,
            explanation:
              "Từ chối lịch sự với 'Nein, das finde ich nicht so gut' và LUÔN đưa lý do với 'weil'.",
          },
          {
            question:
              "Trong Teil 3, bạn muốn đặt câu hỏi cho partner. Nên dùng cụm nào?",
            options: [
              "Vielen Dank fürs Zuhören!",
              "Ich hätte gern eine Frage für Sie.",
              "Das ist eine gute Idee!",
              "Mein Vortrag besteht aus folgenden Teilen.",
            ],
            correct: 1,
            timeLimit: 20,
            explanation:
              "Dùng 'Ich hätte gern eine Frage' với Konjunktiv II để thể hiện lịch sự trong Teil 3.",
          },
          {
            question:
              "Bạn muốn nói về kinh nghiệm cá nhân trong Teil 2. Cụm nào phù hợp?",
            options: [
              "In meinem Heimatland ist...",
              "Was mich betrifft, ich...",
              "Ein Vorteil ist, dass...",
              "Damit komme ich zum Schluss.",
            ],
            correct: 1,
            timeLimit: 20,
            explanation:
              "'Was mich betrifft' (Về phần tôi) mở đầu phần kinh nghiệm trong Folie 2.",
          },
          {
            question:
              "Partner từ chối đề xuất của bạn. Bạn muốn chấp nhận và hỏi ý kiến. Nên nói gì?",
            options: [
              "Du musst mir zustimmen!",
              "Okay, das ist kein Problem. Was wäre denn dein Vorschlag?",
              "Deine Idee ist schlecht.",
              "Ich verstehe dich nicht.",
            ],
            correct: 1,
            timeLimit: 20,
            explanation:
              "Thể hiện sự linh hoạt với 'das ist kein Problem' và hỏi đề xuất thay thế.",
          },
          {
            question: "Trong Teil 2, bạn muốn nêu ƯU ĐIỂM. Chọn cụm nào?",
            options: [
              "Ein Vorteil ist, dass...",
              "Ein Nachteil ist, dass...",
              "Ich habe einmal Folgendes erlebt:",
              "Liebe Zuhörer!",
            ],
            correct: 0,
            timeLimit: 20,
            explanation:
              "'Ein Vorteil ist, dass...' cho ưu điểm, 'Ein Nachteil ist, dass...' cho nhược điểm.",
          },
          {
            question: "Bạn không nghe rõ partner. Nên hỏi thế nào?",
            options: [
              "Das ist eine gute Idee!",
              "Könnten Sie das bitte wiederholen?",
              "Ich bin einverstanden.",
              "Vielen Dank für Ihre Frage.",
            ],
            correct: 1,
            timeLimit: 20,
            explanation:
              "Dùng 'Könnten Sie... wiederholen?' với Konjunktiv II để nhờ lặp lại lịch sự.",
          },
          {
            question: "Kết thúc Teil 2, bạn nên nói gì?",
            options: [
              "Zuerst möchte ich über...",
              "Was mich betrifft...",
              "Hiermit ist meine Präsentation zu Ende. Vielen Dank fürs Zuhören!",
              "Ich schlage vor, dass...",
            ],
            correct: 2,
            timeLimit: 20,
            explanation:
              "Kết thúc với 'Hiermit ist meine Präsentation zu Ende' + cảm ơn + hỏi câu hỏi.",
          },
          {
            question:
              "Partner phản hồi tích cực về bài thuyết trình của bạn. Nên đáp lại thế nào?",
            options: [
              "Nein, das stimmt nicht.",
              "Vielen Dank, es freut mich, dass Ihnen meine Präsentation gefallen hat.",
              "Ich habe eine Frage.",
              "Das ist keine gute Idee.",
            ],
            correct: 1,
            timeLimit: 20,
            explanation:
              "Cảm ơn và bày tỏ vui mừng: 'Vielen Dank, es freut mich, dass...'",
          },
          // Thêm 30 câu nữa với độ khó tăng dần...
          {
            question:
              "Bạn muốn bổ sung thêm lý do cho đề xuất. Dùng từ nối nào?",
            options: ["Aber", "Außerdem", "Oder", "Denn"],
            correct: 1,
            timeLimit: 20,
            explanation:
              "'Außerdem' (Hơn nữa) để thêm lý do thứ hai, tăng tính thuyết phục.",
          },
          {
            question:
              "Trong Teil 2, bạn muốn chuyển từ phần kinh nghiệm sang phần tình hình quê nhà. Nên dùng cụm nào?",
            options: [
              "Jetzt komme ich zu...",
              "Zum Schluss...",
              "Zuerst...",
              "Vielen Dank!",
            ],
            correct: 0,
            timeLimit: 20,
            explanation:
              "'Jetzt komme ich zu...' (Bây giờ tôi chuyển sang...) để nối các phần.",
          },
          {
            question: "Partner nói quá nhanh, bạn không hiểu. Nên nói gì?",
            options: [
              "Du sprichst zu schnell. Ich kann dich nicht verstehen.",
              "Das ist langweilig.",
              "Sprich langsamer!",
              "Ich höre nicht zu.",
            ],
            correct: 0,
            timeLimit: 20,
            explanation:
              "Lịch sự nhắc nhở: 'Du sprichst zu schnell. Ich kann dich nicht verstehen.'",
          },
          {
            question:
              "Bạn muốn hỏi về chi phí trong cuộc thảo luận Teil 1. Nên nói thế nào?",
            options: [
              "Und was kostet das? Ist das nicht zu teuer?",
              "Geld ist nicht wichtig.",
              "Ich bezahle alles.",
              "Das interessiert mich nicht.",
            ],
            correct: 0,
            timeLimit: 20,
            explanation:
              "Hỏi trực tiếp về giá: 'Was kostet das?' và bày tỏ lo lắng 'Ist das nicht zu teuer?'",
          },
        ],
        "fill-blank": [
          // 30 câu điền từ
          {
            question: "Ich _____ vor, dass wir nach München fahren.",
            answer: "schlage",
            hint: "vorschlagen - chia ngôi ich",
            timeLimit: 15,
            explanation:
              "'Ich schlage vor' - separable verb, 'vor' ở cuối mệnh đề chính.",
          },
          {
            question: "Das ist eine gute _____!",
            answer: "Idee",
            hint: "Danh từ nữ 'ý tưởng', viết hoa",
            timeLimit: 15,
            explanation:
              "'die Idee' - danh từ trong tiếng Đức luôn viết hoa chữ cái đầu.",
          },
          {
            question:
              "Meine Präsentation ist zu dem _____: 'Lernen im Internet'.",
            answer: "Thema",
            hint: "Danh từ trung tính 'chủ đề'",
            timeLimit: 15,
            explanation:
              "'das Thema' - giới thiệu chủ đề với 'zu dem Thema' hoặc 'zum Thema'.",
          },
          {
            question: "Was mich _____, ich lerne oft online.",
            answer: "betrifft",
            hint: "betreffen - chia ngôi es (was)",
            timeLimit: 15,
            explanation:
              "'Was mich betrifft' - cụm cố định, động từ chia theo 'was' (ngôi 3 số ít).",
          },
          {
            question: "Ein _____ ist, dass Online-Lernen flexibel ist.",
            answer: "Vorteil",
            hint: "Danh từ nam 'ưu điểm'",
            timeLimit: 15,
            explanation:
              "'der Vorteil' - nêu ưu điểm. Tương tự: 'der Nachteil' (nhược điểm).",
          },
          {
            question: "Ich bin damit _____.",
            answer: "einverstanden",
            hint: "Tính từ 'đồng ý', không viết hoa",
            timeLimit: 15,
            explanation:
              "'einverstanden' - tính từ nên viết thường trong cụm 'Ich bin damit einverstanden'.",
          },
          {
            question: "In meinem _____ ist die Situation anders.",
            answer: "Heimatland",
            hint: "Danh từ trung tính 'quê hương'",
            timeLimit: 15,
            explanation:
              "'das Heimatland' - nói về quê nhà trong Teil 2, Folie 3.",
          },
          {
            question: "Ich _____ gern eine Frage für Sie.",
            answer: "hätte",
            hint: "haben ở Konjunktiv II ngôi ich",
            timeLimit: 15,
            explanation:
              "'hätte' - Konjunktiv II của haben, thể hiện lịch sự khi đặt câu hỏi.",
          },
          {
            question: "Damit komme ich zum _____ meiner Präsentation.",
            answer: "Schluss",
            hint: "Danh từ nam 'kết thúc'",
            timeLimit: 15,
            explanation: "'der Schluss' - 'zum Schluss' = đến phần kết thúc.",
          },
          {
            question: "Könnten Sie das bitte _____?",
            answer: "wiederholen",
            hint: "Động từ nguyên thể 'lặp lại'",
            timeLimit: 15,
            explanation:
              "'wiederholen' - không phải separable verb nên giữ nguyên dạng.",
          },
          // Thêm 20 câu nữa...
          {
            question: "Nein, das finde ich nicht so _____.",
            answer: "gut",
            hint: "Tính từ 'tốt'",
            timeLimit: 15,
            explanation:
              "'gut' - từ chối lịch sự: 'das finde ich nicht so gut'.",
          },
          {
            question: "Was _____ du davon?",
            answer: "hältst",
            hint: "halten - chia ngôi du",
            timeLimit: 15,
            explanation:
              "'hältst' - 'Was hältst du davon?' = Bạn nghĩ sao về điều đó?",
          },
          {
            question: "Vielen Dank fürs _____!",
            answer: "Zuhören",
            hint: "Động từ danh từ hóa 'nghe'",
            timeLimit: 15,
            explanation:
              "'Zuhören' - danh từ hóa từ 'zuhören', viết hoa. 'fürs' = 'für das'.",
          },
          {
            question:
              "_____ freut mich, dass Ihnen meine Präsentation gefallen hat.",
            answer: "Es",
            hint: "Đại từ ngôi 3 trung tính",
            timeLimit: 15,
            explanation: "'Es freut mich' - cụm cố định = Tôi vui mừng.",
          },
          {
            question: "Ich möchte gern _____ essen gehen.",
            answer: "außen",
            hint: "Trạng từ 'bên ngoài'",
            timeLimit: 15,
            explanation: "'außen essen gehen' = đi ăn ở ngoài (nhà hàng).",
          },
        ],
        "sentence-builder": [
          // 30 câu xếp câu
          {
            question: "Sắp xếp thành câu đúng (Đề xuất):",
            words: [
              "Ich",
              "schlage",
              "vor,",
              "dass",
              "wir",
              "nach",
              "Berlin",
              "fahren.",
            ],
            correct: "Ich schlage vor, dass wir nach Berlin fahren.",
            timeLimit: 25,
            explanation:
              "'Ich schlage vor, dass...' + mệnh đề phụ (động từ cuối).",
          },
          {
            question: "Sắp xếp thành câu đúng (Giới thiệu):",
            words: [
              "Meine",
              "Präsentation",
              "ist",
              "zu",
              "dem",
              "Thema:",
              "Sport.",
            ],
            correct: "Meine Präsentation ist zu dem Thema: Sport.",
            timeLimit: 25,
            explanation: "Giới thiệu chủ đề: 'zu dem Thema' hoặc 'zum Thema'.",
          },
          {
            question: "Sắp xếp thành câu đúng (Đồng ý):",
            words: ["Das", "ist", "eine", "gute", "Idee!"],
            correct: "Das ist eine gute Idee!",
            timeLimit: 25,
            explanation: "Cách đồng ý đơn giản và hiệu quả nhất.",
          },
          {
            question: "Sắp xếp thành câu đúng (Kinh nghiệm):",
            words: [
              "Was",
              "mich",
              "betrifft,",
              "ich",
              "lerne",
              "gern",
              "Deutsch.",
            ],
            correct: "Was mich betrifft, ich lerne gern Deutsch.",
            timeLimit: 25,
            explanation: "Sau dấu phẩy bắt đầu mệnh đề mới với chủ ngữ 'ich'.",
          },
          {
            question: "Sắp xếp thành câu đúng (Ưu điểm):",
            words: [
              "Ein",
              "Vorteil",
              "ist,",
              "dass",
              "man",
              "flexibel",
              "lernen",
              "kann.",
            ],
            correct: "Ein Vorteil ist, dass man flexibel lernen kann.",
            timeLimit: 25,
            explanation:
              "Mệnh đề 'dass': động từ chia + động từ nguyên thể ở cuối.",
          },
          {
            question: "Sắp xếp thành câu đúng (Đặt câu hỏi):",
            words: ["Ich", "hätte", "gern", "eine", "Frage", "für", "Sie."],
            correct: "Ich hätte gern eine Frage für Sie.",
            timeLimit: 25,
            explanation: "Konjunktiv II 'hätte' thể hiện lịch sự.",
          },
          {
            question: "Sắp xếp thành câu đúng (Quê nhà):",
            words: [
              "In",
              "meinem",
              "Heimatland",
              "ist",
              "die",
              "Situation",
              "anders.",
            ],
            correct: "In meinem Heimatland ist die Situation anders.",
            timeLimit: 25,
            explanation: "Mô tả tình hình khác biệt ở quê nhà.",
          },
          {
            question: "Sắp xếp thành câu đúng (Từ chối):",
            words: ["Nein,", "das", "finde", "ich", "nicht", "so", "gut."],
            correct: "Nein, das finde ich nicht so gut.",
            timeLimit: 25,
            explanation: "Từ chối lịch sự, sau đó PHẢI nêu lý do với 'weil'.",
          },
          {
            question: "Sắp xếp thành câu đúng (Cảm ơn):",
            words: ["Vielen", "Dank", "fürs", "Zuhören!"],
            correct: "Vielen Dank fürs Zuhören!",
            timeLimit: 25,
            explanation: "'fürs' = 'für das' - cảm ơn việc lắng nghe.",
          },
          {
            question: "Sắp xếp thành câu đúng (Đồng ý mạnh):",
            words: ["Ich", "bin", "damit", "einverstanden."],
            correct: "Ich bin damit einverstanden.",
            timeLimit: 25,
            explanation: "'damit' chỉ về đề xuất vừa được nêu ra.",
          },
        ],
        matching: [
          // 20 vòng matching với timer
          {
            pairs: [
              { de: "Ich schlage vor, dass...", vi: "Tôi đề xuất rằng..." },
              { de: "Das ist eine gute Idee!", vi: "Đó là một ý tưởng hay!" },
              { de: "Was hältst du davon?", vi: "Bạn nghĩ sao về điều đó?" },
              { de: "Ich bin einverstanden.", vi: "Tôi đồng ý." },
              { de: "Was mich betrifft...", vi: "Về phần tôi..." },
            ],
            timeLimit: 40,
          },
          {
            pairs: [
              { de: "Ein Vorteil ist, dass...", vi: "Một ưu điểm là..." },
              { de: "Ein Nachteil ist, dass...", vi: "Một nhược điểm là..." },
              { de: "In meinem Heimatland...", vi: "Ở quê hương tôi..." },
              { de: "Meiner Meinung nach...", vi: "Theo ý kiến của tôi..." },
              {
                de: "Zum Schluss möchte ich sagen...",
                vi: "Cuối cùng tôi muốn nói...",
              },
            ],
            timeLimit: 40,
          },
          {
            pairs: [
              { de: "Ich hätte gern eine Frage.", vi: "Tôi muốn hỏi một câu." },
              {
                de: "Vielen Dank für Ihre Frage.",
                vi: "Cảm ơn câu hỏi của bạn.",
              },
              { de: "Das ist interessant.", vi: "Điều đó thật thú vị." },
              {
                de: "Könnten Sie das wiederholen?",
                vi: "Bạn có thể nhắc lại được không?",
              },
              { de: "Ich verstehe nicht ganz.", vi: "Tôi không hiểu hẳn." },
            ],
            timeLimit: 40,
          },
          // Thêm 17 rounds nữa...
          {
            pairs: [
              { de: "Außerdem...", vi: "Hơn nữa..." },
              {
                de: "Einerseits... andererseits...",
                vi: "Một mặt... mặt khác...",
              },
              { de: "Auf der einen Seite...", vi: "Về một mặt..." },
              { de: "Genau wie in Deutschland...", vi: "Giống như ở Đức..." },
              { de: "Im Gegensatz zu...", vi: "Trái ngược với..." },
            ],
            timeLimit: 40,
          },
          {
            pairs: [
              { de: "Zuerst möchte ich...", vi: "Đầu tiên tôi muốn..." },
              { de: "Dann werde ich...", vi: "Sau đó tôi sẽ..." },
              { de: "Anschließend...", vi: "Tiếp theo..." },
              { de: "Zum Schluss...", vi: "Cuối cùng..." },
              {
                de: "Abschließend möchte ich sagen...",
                vi: "Kết thúc tôi muốn nói...",
              },
            ],
            timeLimit: 40,
          },
        ],
        "situation-response": [
          // 30 tình huống phản ứng
          {
            situation:
              "Partner: 'Ich schlage vor, dass wir mit dem Zug fahren, weil das umweltfreundlich ist. Was meinst du?'",
            scenario: "Bạn đồng ý và bổ sung lý do",
            options: [
              "Das ist eine gute Idee! Außerdem ist der Zug auch bequemer als das Auto. Wann fahren wir?",
              "Nein, das finde ich nicht so gut. Ich würde lieber mit dem Auto fahren.",
              "Ich weiß nicht. Vielleicht können wir später entscheiden.",
              "Das verstehe ich nicht. Kannst du das wiederholen?",
            ],
            correct: 0,
            timeLimit: 25,
            explanation:
              "Đồng ý + thêm lý do (Außerdem) + hỏi chi tiết tiếp theo.",
          },
          {
            situation:
              "Partner: 'Wir könnten im Hotel übernachten. Das ist am bequemsten.'",
            scenario: "Bạn từ chối vì đắt, đề xuất nhà trẻ",
            options: [
              "Ja, das stimmt! Hotels sind immer die beste Option.",
              "Nein, das finde ich nicht so gut, weil Hotels zu teuer sind. Ich schlage vor, dass wir in der Jugendherberge übernachten. Das ist billiger. Was hältst du davon?",
              "Ich bin einverstanden. Das machen wir!",
              "Super! Dann buche ich gleich ein Hotelzimmer.",
            ],
            correct: 1,
            timeLimit: 25,
            explanation:
              "Từ chối + lý do + đề xuất thay thế + hỏi ý kiến (5 câu).",
          },
          {
            situation: "Giám khảo: 'Warum haben Sie dieses Thema gewählt?'",
            scenario: "Teil 3 - Giải thích lý do chọn chủ đề",
            options: [
              "Ich weiß nicht. Das war nur ein Zufall.",
              "Weil ich das Thema sehr interessant finde und persönliche Erfahrung damit habe. Außerdem ist dieses Thema in meinem Heimatland sehr aktuell.",
              "Das möchte ich nicht sagen.",
              "Können Sie die Frage wiederholen?",
            ],
            correct: 1,
            timeLimit: 25,
            explanation:
              "Đưa ra 2 lý do: sở thích cá nhân + tính thời sự ở quê nhà.",
          },
          {
            situation: "Partner: 'Was können wir dort machen?'",
            scenario: "Đề xuất nhiều hoạt động",
            options: [
              "Ich weiß es nicht genau.",
              "Wir könnten wandern gehen und die Natur genießen. Außerdem gibt es dort auch interessante Museen. Was meinst du?",
              "Das ist mir egal. Du kannst entscheiden.",
              "Vielleicht nichts Besonderes.",
            ],
            correct: 1,
            timeLimit: 25,
            explanation:
              "Đưa ra 2-3 hoạt động với 'Wir könnten...' + 'Außerdem' + hỏi ý kiến.",
          },
          {
            situation: "Partner: 'Nein, ich finde das nicht so gut.'",
            scenario: "Chấp nhận và hỏi đề xuất mới",
            options: [
              "Warum nicht? Du musst mir zustimmen!",
              "Okay, das ist kein Problem. Was wäre denn dein Vorschlag?",
              "Das ist dumm. Meine Idee ist besser.",
              "Dann machen wir gar nichts!",
            ],
            correct: 1,
            timeLimit: 25,
            explanation:
              "Thể hiện linh hoạt: 'das ist kein Problem' + hỏi đề xuất thay thế.",
          },
          {
            situation: "Bạn vừa kết thúc Teil 2",
            scenario: "Kết thúc bài thuyết trình",
            options: [
              "Ich gehe jetzt. Auf Wiedersehen!",
              "Hiermit ist meine Präsentation zu Ende. Vielen Dank fürs Zuhören! Haben Sie noch Fragen?",
              "Das war's. Fertig.",
              "Ich habe nichts mehr zu sagen.",
            ],
            correct: 1,
            timeLimit: 25,
            explanation: "Ba yếu tố: tuyên bố kết thúc + cảm ơn + mời câu hỏi.",
          },
        ],
        "speed-round": [
          // Unlimited quick questions
          { q: "Đề xuất: Ich _____ vor", a: "schlage" },
          { q: "Đồng ý: Das ist eine gute _____", a: "Idee" },
          { q: "Hỏi ý kiến: Was _____ du davon?", a: "hältst" },
          { q: "Chủ đề: zu dem _____", a: "Thema" },
          { q: "Ưu điểm: Ein _____", a: "Vorteil" },
          { q: "Nhược điểm: Ein _____", a: "Nachteil" },
          { q: "Quê hương: mein _____", a: "Heimatland" },
          { q: "Từ chối: nicht so _____", a: "gut" },
          { q: "Ý kiến: Meiner _____", a: "Meinung" },
          { q: "Kinh nghiệm: Was mich _____", a: "betrifft" },
          { q: "Câu hỏi: Ich _____ gern", a: "hätte" },
          { q: "Cảm ơn: Vielen _____", a: "Dank" },
          { q: "Đồng ý: Ich bin _____", a: "einverstanden" },
          { q: "Lặp lại: _____?", a: "wiederholen" },
          { q: "Kết thúc: Zum _____", a: "Schluss" },
          { q: "Hơn nữa: _____", a: "Außerdem" },
          { q: "Vì vậy: _____", a: "deshalb" },
          { q: "Tuy nhiên: _____", a: "jedoch" },
          { q: "Ví dụ: zum _____", a: "Beispiel" },
          { q: "Đầu tiên: _____", a: "Zuerst" },
        ],
        "teil2-practice": [
          // 25 câu về cấu trúc Teil 2
          {
            question:
              "Folie 1: Bạn muốn chào hỏi khán giả. Chọn cách nào phù hợp nhất?",
            context: "Mở đầu bài thuyết trình Teil 2",
            options: [
              "Liebe Zuhörer! Ich begrüße Sie ganz herzlich.",
              "Hallo zusammen! Was geht?",
              "Guten Tag. Ich bin fertig.",
              "Hey! Lasst uns anfangen.",
            ],
            correct: 0,
            timeLimit: 20,
            explanation:
              "Chào hỏi trang trọng: 'Liebe Zuhörer' + 'Ich begrüße Sie ganz herzlich'.",
          },
          {
            question: "Folie 1: Sau khi chào, bạn cần làm gì?",
            context: "Giới thiệu chủ đề",
            options: [
              "Kết thúc ngay",
              "Nêu chủ đề: 'Meine Präsentation ist zu dem Thema: ...'",
              "Kể chuyện cá nhân",
              "Hỏi khán giả",
            ],
            correct: 1,
            timeLimit: 20,
            explanation: "Luôn giới thiệu chủ đề ngay sau phần chào hỏi.",
          },
          {
            question: "Folie 1: Sau khi nêu chủ đề, bạn nên làm gì?",
            context: "Giới thiệu cấu trúc",
            options: [
              "Kết thúc bài thuyết trình",
              "Giới thiệu cấu trúc: 'Mein Vortrag besteht aus folgenden Teilen...'",
              "Bắt đầu nói về kinh nghiệm ngay",
              "Cảm ơn khán giả",
            ],
            correct: 1,
            timeLimit: 20,
            explanation:
              "Phải giới thiệu cấu trúc bài: kinh nghiệm → quê nhà → ưu/nhược điểm → ý kiến.",
          },
          {
            question: "Folie 2: Bắt đầu phần kinh nghiệm với cụm nào?",
            context: "Chia sẻ kinh nghiệm cá nhân",
            options: [
              "In meinem Heimatland...",
              "Was mich betrifft, ich...",
              "Ein Vorteil ist...",
              "Zum Schluss...",
            ],
            correct: 1,
            timeLimit: 20,
            explanation:
              "'Was mich betrifft' (Về phần tôi) mở đầu phần kinh nghiệm.",
          },
          {
            question: "Folie 3: Nói về tình hình quê nhà bằng cụm nào?",
            context: "So sánh với Đức",
            options: [
              "Was mich betrifft...",
              "In meinem Heimatland ist die Situation...",
              "Ein Nachteil ist...",
              "Ich hätte gern...",
            ],
            correct: 1,
            timeLimit: 20,
            explanation:
              "'In meinem Heimatland' để giới thiệu tình hình ở quê nhà.",
          },
        ],
      };

      // Timer Functions
      function startQuestionTimer(timeLimit) {
        gameState.timeLeft = timeLimit;
        gameState.questionStartTime = Date.now();

        const timerEl = document.querySelector(".question-timer");
        if (timerEl) {
          timerEl.textContent = timeLimit + "s";
        }

        gameState.questionTimer = setInterval(() => {
          gameState.timeLeft--;
          const timerEl = document.querySelector(".question-timer");

          if (timerEl) {
            timerEl.textContent = gameState.timeLeft + "s";

            if (gameState.timeLeft <= 5) {
              timerEl.classList.add("warning");
            }
          }

          if (gameState.timeLeft <= 0) {
            clearInterval(gameState.questionTimer);
            // Auto submit with wrong answer
            gameState.selectedAnswer = -1;
            checkAnswer();
          }
        }, 1000);
      }

      function stopQuestionTimer() {
        if (gameState.questionTimer) {
          clearInterval(gameState.questionTimer);
        }

        // Calculate time taken
        const timeTaken = Math.round(
          (Date.now() - gameState.questionStartTime) / 1000
        );
        gameState.questionTimes.push(timeTaken);
        gameState.totalTime += timeTaken;

        // Update average time
        const avgTime = Math.round(
          gameState.totalTime / gameState.questionTimes.length
        );
        document.getElementById("avgTime").textContent = avgTime + "s";
      }

      // Start Game
      function startGame(mode) {
        gameState.mode = mode;
        gameState.currentQuestion = 0;
        gameState.score = 0;
        gameState.correct = 0;
        gameState.wrong = 0;
        gameState.streak = 0;
        gameState.selectedAnswer = null;
        gameState.totalTime = 0;
        gameState.questionTimes = [];

        // Set total questions based on mode
        const questionCounts = {
          "dialogue-practice": 50,
          "multiple-choice": 40,
          "fill-blank": 30,
          "sentence-builder": 30,
          matching: 20,
          "situation-response": 30,
          "speed-round": 999,
          "teil2-practice": 25,
        };

        gameState.totalQuestions = questionCounts[mode] || 10;

        document.getElementById("menuScreen").classList.remove("active");
        document.getElementById("gameScreen").classList.add("active");

        if (mode === "speed-round") {
          gameState.timeLeft = 60;
          startSpeedRoundTimer();
        }

        loadQuestion();
      }

      // Speed Round Timer
      function startSpeedRoundTimer() {
        gameState.timerInterval = setInterval(() => {
          gameState.timeLeft--;

          const timerEl = document.querySelector(".question-timer");
          if (timerEl) {
            timerEl.textContent = gameState.timeLeft + "s";

            if (gameState.timeLeft <= 10) {
              timerEl.classList.add("warning");
            }
          }

          if (gameState.timeLeft <= 0) {
            clearInterval(gameState.timerInterval);
            showResults();
          }
        }, 1000);
      }

      // Load Question
      function loadQuestion() {
        const mode = gameState.mode;
        const questionIndex = gameState.currentQuestion;
        const gameArea = document.getElementById("gameArea");
        const feedbackBox = document.getElementById("feedbackBox");

        feedbackBox.classList.remove("show");
        document.getElementById("submitBtn").style.display = "block";
        document.getElementById("nextBtn").style.display = "none";
        gameState.selectedAnswer = null;

        // Stop previous timer
        if (gameState.questionTimer) {
          clearInterval(gameState.questionTimer);
        }

        // Update progress
        const progress = ((questionIndex + 1) / gameState.totalQuestions) * 100;
        document.getElementById("progressFill").style.width = progress + "%";
        document.getElementById("progressFill").textContent = `Câu ${
          questionIndex + 1
        }/${gameState.totalQuestions}`;

        let html = "";
        const questions = questionBanks[mode];
        const q = questions[questionIndex % questions.length];

        // Add timer for all modes except speed-round
        if (mode !== "speed-round" && q.timeLimit) {
          startQuestionTimer(q.timeLimit);
        }

        if (mode === "dialogue-practice") {
          html = `
                    <div class="question-card">
                        ${
                          q.timeLimit
                            ? `<div class="question-timer">${q.timeLimit}s</div>`
                            : ""
                        }
                        <div class="context-box">
                            <strong>🎯 Bối cảnh:</strong> ${q.context}
                        </div>
                        <div class="dialogue-box">
                            ${q.dialogue
                              .map(
                                (turn) => `
                                <div class="dialogue-turn ${
                                  turn.speaker === "Bạn" ? "your-turn" : ""
                                }">
                                    <div class="speaker-icon">${turn.icon}</div>
                                    <div class="speaker-name">${
                                      turn.speaker
                                    }:</div>
                                    <div class="dialogue-text">${
                                      turn.text
                                    }</div>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                        <div class="question-text">💬 ${q.question}</div>
                        <div class="options-grid">
                            ${q.options
                              .map(
                                (opt, i) => `
                                <div class="option-btn" onclick="selectOption(${i})">
                                    ${opt}
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `;
        } else if (
          mode === "multiple-choice" ||
          mode === "situation-response" ||
          mode === "teil2-practice"
        ) {
          html = `
                    <div class="question-card">
                        ${
                          q.timeLimit
                            ? `<div class="question-timer">${q.timeLimit}s</div>`
                            : ""
                        }
                        ${
                          q.context
                            ? `<div class="context-box"><strong>📝 Context:</strong> ${q.context}</div>`
                            : ""
                        }
                        ${
                          q.situation
                            ? `<div class="situation"><strong>🎬 Tình huống:</strong><br>${q.situation}</div>`
                            : ""
                        }
                        ${
                          q.scenario
                            ? `<div class="hint-box"><strong>📝 Nhiệm vụ:</strong> ${q.scenario}</div>`
                            : ""
                        }
                        <div class="question-text">${q.question}</div>
                        <div class="options-grid">
                            ${q.options
                              .map(
                                (opt, i) => `
                                <div class="option-btn" onclick="selectOption(${i})">
                                    ${opt}
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `;
        } else if (mode === "fill-blank") {
          html = `
                    <div class="question-card">
                        ${
                          q.timeLimit
                            ? `<div class="question-timer">${q.timeLimit}s</div>`
                            : ""
                        }
                        <div class="question-text">${q.question}</div>
                        <div class="hint-box">💡 Gợi ý: ${q.hint}</div>
                        <input type="text" class="fill-blank-input" id="answerInput" 
                               placeholder="Nhập câu trả lời..." 
                               onkeypress="if(event.key==='Enter') checkAnswer()">
                    </div>
                `;
        } else if (mode === "sentence-builder") {
          const shuffled = [...q.words].sort(() => Math.random() - 0.5);
          html = `
                    <div class="question-card">
                        ${
                          q.timeLimit
                            ? `<div class="question-timer">${q.timeLimit}s</div>`
                            : ""
                        }
                        <div class="question-text">${q.question}</div>
                        <div class="sentence-builder" id="sentenceBuilder"></div>
                        <div class="word-bank">
                            ${shuffled
                              .map(
                                (word) => `
                                <div class="draggable-word" onclick="addToSentence(this)">${word}</div>
                            `
                              )
                              .join("")}
                        </div>
                    </div>
                `;
        } else if (mode === "matching") {
          gameState.matchingPairs = q.pairs;
          const shuffledLeft = [...q.pairs].sort(() => Math.random() - 0.5);
          const shuffledRight = [...q.pairs].sort(() => Math.random() - 0.5);

          html = `
                    <div class="question-card">
                        ${
                          q.timeLimit
                            ? `<div class="question-timer">${q.timeLimit}s</div>`
                            : ""
                        }
                        <div class="question-text">⚡ Ghép cặp Tiếng Đức - Tiếng Việt nhanh nhất có thể!</div>
                        <div class="matching-game">
                            <div class="matching-column" id="leftColumn">
                                ${shuffledLeft
                                  .map(
                                    (pair, i) => `
                                    <div class="match-item" data-text="${pair.de}" onclick="selectMatch(this, 'left')">
                                        ${pair.de}
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                            <div class="matching-column" id="rightColumn">
                                ${shuffledRight
                                  .map(
                                    (pair, i) => `
                                    <div class="match-item" data-text="${pair.vi}" onclick="selectMatch(this, 'right')">
                                        ${pair.vi}
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                        </div>
                    </div>
                `;
          gameState.matchingState = {
            selectedLeft: null,
            selectedRight: null,
            matches: 0,
          };
          if (q.timeLimit) {
            startQuestionTimer(q.timeLimit);
          }
        } else if (mode === "speed-round") {
          html = `
                    <div class="question-card">
                        <div class="question-timer">${gameState.timeLeft}s</div>
                        <div class="question-text">${q.q}</div>
                        <input type="text" class="fill-blank-input" id="answerInput" 
                               placeholder="Trả lời nhanh!" 
                               onkeypress="if(event.key==='Enter') checkAnswer()"
                               autofocus>
                    </div>
                `;
        }

        gameArea.innerHTML = html;

        if (mode === "fill-blank" || mode === "speed-round") {
          setTimeout(
            () => document.getElementById("answerInput")?.focus(),
            100
          );
        }
      }

      // Select Option
      function selectOption(index) {
        gameState.selectedAnswer = index;
        document.querySelectorAll(".option-btn").forEach((btn, i) => {
          btn.style.background =
            i === index
              ? "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
              : "white";
          btn.style.color = i === index ? "white" : "#333";
        });
      }

      // Add word to sentence (for sentence builder)
      function addToSentence(wordEl) {
        if (wordEl.classList.contains("used")) return;

        const builder = document.getElementById("sentenceBuilder");
        const clone = wordEl.cloneNode(true);

        clone.onclick = function () {
          wordEl.classList.remove("used");
          this.remove();
        };

        builder.appendChild(clone);
        wordEl.classList.add("used");
      }

      // Matching game functions
      function selectMatch(element, side) {
        if (element.classList.contains("matched")) return;

        const column = side === "left" ? "leftColumn" : "rightColumn";
        document.querySelectorAll(`#${column} .match-item`).forEach((item) => {
          if (!item.classList.contains("matched")) {
            item.classList.remove("selected");
          }
        });

        element.classList.add("selected");

        if (side === "left") {
          gameState.matchingState.selectedLeft = element.dataset.text;
        } else {
          gameState.matchingState.selectedRight = element.dataset.text;
        }

        if (
          gameState.matchingState.selectedLeft &&
          gameState.matchingState.selectedRight
        ) {
          checkMatch();
        }
      }

      function checkMatch() {
        const leftText = gameState.matchingState.selectedLeft;
        const rightText = gameState.matchingState.selectedRight;

        const pair = gameState.matchingPairs.find(
          (p) => p.de === leftText && p.vi === rightText
        );

        const leftEl = document.querySelector(
          `#leftColumn .match-item[data-text="${leftText}"]`
        );
        const rightEl = document.querySelector(
          `#rightColumn .match-item[data-text="${rightText}"]`
        );

        if (pair) {
          leftEl.classList.add("matched");
          rightEl.classList.add("matched");
          leftEl.classList.remove("selected");
          rightEl.classList.remove("selected");

          gameState.matchingState.matches++;
          gameState.score += 10;
          gameState.correct++;
          gameState.streak++;
          updateStats();

          if (gameState.matchingState.matches === 5) {
            stopQuestionTimer();
            setTimeout(() => {
              showFeedback(true, "matching", 0);
              document.getElementById("submitBtn").style.display = "none";
              document.getElementById("nextBtn").style.display = "block";
            }, 500);
          }
        } else {
          leftEl.style.animation = "wrongShake 0.5s";
          rightEl.style.animation = "wrongShake 0.5s";

          setTimeout(() => {
            leftEl.classList.remove("selected");
            rightEl.classList.remove("selected");
            leftEl.style.animation = "";
            rightEl.style.animation = "";
          }, 500);

          gameState.wrong++;
          gameState.streak = 0;
          updateStats();
        }

        gameState.matchingState.selectedLeft = null;
        gameState.matchingState.selectedRight = null;
      }

      // Check Answer
      function checkAnswer() {
        stopQuestionTimer();

        const mode = gameState.mode;
        const questionIndex = gameState.currentQuestion;
        let isCorrect = false;
        let userAnswer = "";

        const questions = questionBanks[mode];
        const q = questions[questionIndex % questions.length];

        if (
          mode === "multiple-choice" ||
          mode === "situation-response" ||
          mode === "dialogue-practice" ||
          mode === "teil2-practice"
        ) {
          if (gameState.selectedAnswer === -1) {
            isCorrect = false; // Timeout
          } else {
            isCorrect = gameState.selectedAnswer === q.correct;
          }

          document.querySelectorAll(".option-btn").forEach((btn, i) => {
            if (i === q.correct) {
              btn.classList.add("correct");
            } else if (i === gameState.selectedAnswer && !isCorrect) {
              btn.classList.add("wrong");
            }
            btn.style.pointerEvents = "none";
          });
        } else if (mode === "fill-blank") {
          userAnswer = document
            .getElementById("answerInput")
            .value.trim()
            .toLowerCase();
          isCorrect = userAnswer === q.answer.toLowerCase();

          document.getElementById("answerInput").style.borderColor = isCorrect
            ? "#28a745"
            : "#dc3545";
          document.getElementById("answerInput").disabled = true;
        } else if (mode === "speed-round") {
          userAnswer = document
            .getElementById("answerInput")
            .value.trim()
            .toLowerCase();
          isCorrect = userAnswer === q.a.toLowerCase();

          if (isCorrect) {
            gameState.currentQuestion++;
            gameState.score += 10;
            gameState.correct++;
            gameState.streak++;

            if (gameState.streak > gameState.bestStreak) {
              gameState.bestStreak = gameState.streak;
            }

            updateStats();

            if (gameState.timeLeft > 0) {
              loadQuestion();
            } else {
              showResults();
            }
            return;
          } else {
            gameState.wrong++;
            gameState.streak = 0;
            document.getElementById("answerInput").value = "";
            document.getElementById("answerInput").style.borderColor =
              "#dc3545";
            setTimeout(() => {
              document.getElementById("answerInput").style.borderColor =
                "#e0e0e0";
              document.getElementById("answerInput").focus();
            }, 500);
            updateStats();
            return;
          }
        } else if (mode === "sentence-builder") {
          const builder = document.getElementById("sentenceBuilder");
          userAnswer = Array.from(builder.children)
            .map((el) => el.textContent)
            .join(" ");
          isCorrect = userAnswer === q.correct;
        } else if (mode === "matching") {
          return; // Matching is handled separately
        }

        // Update score and streak
        if (isCorrect) {
          const timeBonusPoints = Math.max(0, gameState.timeLeft * 2);
          gameState.score += 10 + gameState.streak * 2 + timeBonusPoints;
          gameState.correct++;
          gameState.streak++;

          if (gameState.streak > gameState.bestStreak) {
            gameState.bestStreak = gameState.streak;
          }

          if (gameState.streak >= 3) {
            showCombo(gameState.streak);
          }
        } else {
          gameState.wrong++;
          gameState.streak = 0;
        }

        updateStats();
        showFeedback(isCorrect, mode, questionIndex);

        document.getElementById("submitBtn").style.display = "none";
        document.getElementById("nextBtn").style.display = "block";
      }

      // Show Feedback
      function showFeedback(isCorrect, mode, questionIndex) {
        const feedbackBox = document.getElementById("feedbackBox");
        const feedbackTitle = document.getElementById("feedbackTitle");
        const feedbackText = document.getElementById("feedbackText");

        let explanation = "";

        if (mode === "matching") {
          explanation = "Bạn đã ghép đúng tất cả các cặp!";
        } else {
          const questions = questionBanks[mode];
          const q = questions[questionIndex % questions.length];
          explanation = q.explanation || "";
        }

        if (isCorrect) {
          feedbackBox.className = "feedback-box correct show";
          feedbackTitle.textContent = "✅ Chính xác!";
          feedbackText.textContent = explanation;
        } else {
          feedbackBox.className = "feedback-box wrong show";
          feedbackTitle.textContent =
            gameState.selectedAnswer === -1 ? "⏱️ Hết giờ!" : "❌ Chưa đúng";
          feedbackText.textContent = explanation;
        }
      }

      // Next Question
      function nextQuestion() {
        gameState.currentQuestion++;

        if (gameState.currentQuestion >= gameState.totalQuestions) {
          showResults();
        } else {
          loadQuestion();
        }
      }

      // Show Results
      function showResults() {
        if (gameState.timerInterval) {
          clearInterval(gameState.timerInterval);
        }
        if (gameState.questionTimer) {
          clearInterval(gameState.questionTimer);
        }

        document.getElementById("gameScreen").classList.remove("active");
        document.getElementById("resultsScreen").classList.add("active");

        const total = gameState.correct + gameState.wrong;
        const accuracy =
          total > 0 ? Math.round((gameState.correct / total) * 100) : 0;
        const avgTime =
          gameState.questionTimes.length > 0
            ? Math.round(gameState.totalTime / gameState.questionTimes.length)
            : 0;

        document.getElementById("finalScore").textContent = gameState.score;
        document.getElementById("correctCount").textContent = gameState.correct;
        document.getElementById("wrongCount").textContent = gameState.wrong;
        document.getElementById("finalAccuracy").textContent = accuracy + "%";
        document.getElementById("bestStreak").textContent =
          gameState.bestStreak;
        document.getElementById("finalAvgTime").textContent = avgTime + "s";

        // Performance message
        let message = "";
        let achievements = "";

        if (accuracy >= 90) {
          message = "🌟 Xuất sắc! Bạn đã thành thạo Redemittel!";
          achievements +=
            '<span class="achievement-badge">🏆 Bậc Thầy B1</span>';
        } else if (accuracy >= 75) {
          message = "👍 Rất tốt! Tiếp tục luyện tập!";
          achievements +=
            '<span class="achievement-badge">⭐ Học Viên Giỏi</span>';
        } else if (accuracy >= 60) {
          message = "💪 Khá tốt! Hãy ôn lại một số phần.";
          achievements +=
            '<span class="achievement-badge">📚 Học Viên Chăm Chỉ</span>';
        } else {
          message = "📖 Cần cố gắng thêm! Đừng bỏ cuộc!";
        }

        if (gameState.bestStreak >= 5) {
          achievements +=
            '<span class="achievement-badge">🔥 Streak Master</span>';
        }

        if (gameState.score >= 200) {
          achievements += '<span class="achievement-badge">💯 Điểm Cao</span>';
        }

        if (avgTime <= 10) {
          achievements +=
            '<span class="achievement-badge">⚡ Tốc Độ Ánh Sáng</span>';
        }

        document.getElementById("performanceMessage").textContent = message;
        document.getElementById("achievementsList").innerHTML = achievements;
      }

      // Update Stats
      function updateStats() {
        const total = gameState.correct + gameState.wrong;
        const accuracy =
          total > 0 ? Math.round((gameState.correct / total) * 100) : 0;

        document.getElementById("totalScore").textContent = gameState.score;
        document.getElementById("accuracy").textContent = accuracy + "%";
        document.getElementById("streak").textContent = gameState.streak;

        // Calculate level based on score
        gameState.level = Math.floor(gameState.score / 50) + 1;
        document.getElementById("level").textContent = gameState.level;
      }

      // Show Combo
      function showCombo(streak) {
        const comboCounter = document.getElementById("comboCounter");
        comboCounter.textContent = `🔥 ${streak}x COMBO!`;
        comboCounter.classList.add("show");

        setTimeout(() => {
          comboCounter.classList.remove("show");
        }, 1000);
      }

      // Return to Menu
      function returnToMenu() {
        if (gameState.timerInterval) {
          clearInterval(gameState.timerInterval);
        }
        if (gameState.questionTimer) {
          clearInterval(gameState.questionTimer);
        }

        document
          .querySelectorAll(".menu-screen, .game-screen, .results-screen")
          .forEach((screen) => {
            screen.classList.remove("active");
          });

        document.getElementById("menuScreen").classList.add("active");
      }

      // Restart Game
      function restartGame() {
        startGame(gameState.mode);
      }

      // Initialize
      updateStats();
    </script>
  </body>
</html>
